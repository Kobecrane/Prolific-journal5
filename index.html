



<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prolific Journal 3.0</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- jsPDF and html2canvas for PDF Export -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
     <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light-border.css" />
    <style>
        :root {
            --bg-primary: #1a1c23;
            --bg-secondary: #20222a;
            --bg-tertiary: #2a2d37;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: #3a3d4a;
            --accent-color: #4f46e5; /* Default accent color */
            --reversal-card-bg: rgba(234, 88, 12, 0.1); /* orange-600 with 10% opacity */
            --reversal-card-border: rgba(234, 88, 12, 0.2);
            --reversal-card-header: #fb923c; /* orange-400 */
            --reversal-card-text: #fdba74; /* orange-300 */
        }
        /* ADD THIS CSS FOR LIGHT MODE */
        .light {
            --bg-primary: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #e5e7eb; /* gray-200 */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #6b7280; /* gray-500 */
           --border-color: #d1d5db; /* gray-300 */
            --accent-color: #4f46e5; /* indigo-600 */
            --reversal-card-bg: rgba(234, 88, 12, 0.1);
            --reversal-card-border: rgba(234, 88, 12, 0.3);
            --reversal-card-header: #c2410c; /* orange-700 */
            --reversal-card-text: #9a3412; /* orange-800 */
        }
        .light .trade-type-btn.bg-tertiary {
         background-color: #d1d5db; /* gray-300 */
          color: #374151; /* gray-700 */
          font-weight: 600;
        }
         .reversal-card {
            background-color: var(--reversal-card-bg);
            border: 1px solid var(--reversal-card-border);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .reversal-card-header {
            color: var(--reversal-card-header);
            font-weight: 700;
            font-size: 1.125rem; /* text-lg */
        }
        .reversal-card-stat-value {
            color: var(--reversal-card-text);
            font-weight: 600;
        }
        /* Style for the toggle switch */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 44px;
        }
        .theme-switch input {
            display:none;
        }
        /* Collapsible Section Styles */
/* ADD THIS NEW RULE for the adviser panel */
#adviser-panel > .collapsible-header {
    padding: 0; /* Removes default padding to fit nicely in the card */
} 
.collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 0.75rem 0; /* Increased padding for better click area */
    user-select: none;
}
.collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out, margin-top 0.3s ease-in-out, padding-bottom 0.3s ease-in-out;
}
.collapsible-container.open .collapsible-content {
    max-height: 1500px; /* Increased max-height for adviser content */
    margin-top: 1rem;
    padding-bottom: 0;
}
.collapsible-icon {
    transition: transform 0.3s ease-in-out;
}
.collapsible-container.open .collapsible-icon {
    transform: rotate(180deg);
}
        .slider {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            background-color: var(--text-secondary);
            bottom: 3px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: white;
        }
        
        html {
             color-scheme: dark;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .sidebar {
            transition: width 0.3s ease;
        }

        .sidebar-link.active {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }
        .sidebar-link.active svg {
            color: white !important;
        }

     /* Add these styles for the collapsible review card */
.trade-details-grid .rendered-notes {
    transition: grid-column 0.3s ease-in-out;
}

.trade-details-grid.review-collapsed .trade-insight-card {
    display: none;
}

@media (min-width: 768px) { /* md breakpoint */
    .trade-details-grid.review-collapsed .rendered-notes {
        grid-column: span 2 / span 2;
    }
}   
        .trade-insight-card {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
}
.insight-grade {
    font-size: 1.25rem;
    font-weight: 800;
    padding: 0.25rem 0.75rem;
    border-radius: 0.5rem;
}
.insight-grade.grade-a { background-color: #22c55e; color: white; }
.insight-grade.grade-b { background-color: #84cc16; color: white; }
.insight-grade.grade-c { background-color: #facc15; color: #422006; }
.insight-grade.grade-d { background-color: #f97316; color: white; }
.insight-grade.grade-f { background-color: #ef4444; color: white; }

.insight-item svg {
    flex-shrink: 0;
    margin-top: 3px;
}
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .form-input {
            background-color: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-primary);
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }

        .form-input:focus {
            --tw-ring-color: var(--accent-color);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--tw-ring-color);
        }
        /* Add this for Zebra Striping */
#trade-history-body tr:nth-child(even) {
    background-color: var(--bg-tertiary);
}

/* Optional: Add a hover effect for better tracking */
#trade-history-body tr:hover {
    background-color: var(--border-color);
}
        .light .insight-grade.grade-a { background-color: #dcfce7; color: #166534; } /* green-100 bg, green-800 text */
        .light .insight-grade.grade-b { background-color: #ecfccb; color: #3f6212; } /* lime-100 bg, lime-800 text */
        .light .insight-grade.grade-d { background-color: #ffedd5; color: #9a3412; } /* orange-100 bg, orange-800 text */
        .light .insight-grade.grade-f { background-color: #fee2e2; color: #991b1b; } /* red-100 bg, red-800 text */

        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .details-row { transition: all 0.3s ease-in-out; }
        .details-row td { padding-top: 0; padding-bottom: 0; }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        .details-row.open .details-content { max-height: 20000px; padding: 1rem; }
        .rendered-notes img, .playbook-image { max-width: 100%; height: auto; border-radius: 0.5rem; margin-top: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }


        #trade-comments-editor, .playbook-textarea { min-height: 100px; }
        #trade-comments-editor:empty:before, .playbook-textarea:empty:before { content: attr(data-placeholder); color: var(--text-secondary); cursor: text; }
        #trade-comments-editor.dragover, .image-dropzone.dragover { border-style: dashed; border-color: var(--accent-color); }

        #toast-container { position: fixed; bottom: 1.25rem; right: 1.25rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateY(120%); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); color: white; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: var(--accent-color); }
        .toast-progress { position: absolute; bottom: 0; left: 0; height: 4px; background-color: rgba(0,0,0,0.3); width: 100%; animation: shrink 3s linear forwards; }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }

        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--accent-color); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .loader-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animation Classes */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        .animate-fade-in-up { opacity: 0; animation: fade-in-up 0.5s ease-out forwards; }
        
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: scale(1.05) translateY(-2px); }
        .btn:active { transform: scale(0.98) translateY(0); }

        .btn-primary {
            background-color: var(--accent-color);
            transition: 0.3s;
        }
        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--accent-color), white 10%);
        }

        #log-trade-btn { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 var(--accent-color); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        
        /* Star Rating */
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating input { display: none; }
        .star-rating label { color: #4b5563; font-size: 2rem; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label { color: #f59e0b; }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 28rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
         
        /* Tippy.js Theme */
.tippy-box[data-theme~='light-border'] {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}
.tippy-box[data-theme~='light-border'][data-placement^='top']>.tippy-arrow:before {
    border-top-color: var(--border-color);
}
.tippy-box[data-theme~='light-border'][data-placement^='bottom']>.tippy-arrow:before {
    border-bottom-color: var(--border-color);
}
/* New Tab Styles */
        .analytics-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        .tab-btn {
            padding: 0.75rem 1.25rem;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
        }
        .tab-btn:hover {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }
        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* START: New styles for Deep Dive UI Upgrade */
.deep-dive-card {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-left: 4px solid var(--accent-color);
    border-radius: 0.5rem;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    transition: all 0.2s ease-in-out;
}
.deep-dive-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.deep-dive-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.deep-dive-header .title {
    font-size: 1.125rem; /* text-lg */
    font-weight: 700;
    color: var(--text-primary);
}
.deep-dive-header .title a:hover {
    text-decoration: underline;
    color: var(--accent-color);
}
.deep-dive-header .total-pl {
    font-size: 1.125rem;
    font-weight: 700;
}
.pl-bar-background {
    width: 100%;
    height: 8px;
    background-color: var(--bg-primary);
    border-radius: 9999px;
    overflow: hidden;
}
.pl-bar-fill {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease-out;
}
.pl-bar-fill.win { background: linear-gradient(to right, #22c55e, #84cc16); }
.pl-bar-fill.loss { background: linear-gradient(to right, #ef4444, #f97316); }
.secondary-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid var(--border-color);
    padding-top: 0.75rem;
    gap: 1rem;
}
.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.1rem;
    text-align: center;
    flex-grow: 1;
}
.stat-item-value {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem; /* text-sm */
}
.stat-item-value svg {
    width: 0.875rem; /* 14px */
    height: 0.875rem; /* 14px */
    color: var(--text-secondary);
}
.stat-item-label {
    font-size: 0.75rem; /* text-xs */
    color: var(--text-secondary);
}
/* END: New styles for Deep Dive UI Upgrade */
    </style>
</head>
<body class="flex">
<svg width="0" height="0" style="position:absolute;z-index:-1;">
    <defs>
        <filter id="pro-drop-shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur"/>
            <feOffset in="blur" dx="1" dy="2" result="offsetBlur"/>
            <feFlood flood-color="#000" flood-opacity="0.2" result="offsetColor"/>
            <feComposite in="offsetColor" in2="offsetBlur" operator="in" result="offsetBlur"/>
            <feMerge>
                <feMergeNode/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
        <linearGradient id="pro-gradient-green" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#4ade80;" />
            <stop offset="100%" style="stop-color:#16a34a;" />
        </linearGradient>
        <linearGradient id="pro-gradient-red" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#f87171;" />
            <stop offset="100%" style="stop-color:#dc2626;" />
        </linearGradient>
        <linearGradient id="pro-gradient-sparkline-win" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#22c55e; stop-opacity:0.4" />
            <stop offset="100%" style="stop-color:#22c55e; stop-opacity:0" />
        </linearGradient>
        <linearGradient id="pro-gradient-sparkline-loss" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ef4444; stop-opacity:0.4" />
            <stop offset="100%" style="stop-color:#ef4444; stop-opacity:0" />
        </linearGradient>
    </defs>
</svg>
<style>
    .pro-shadow { filter: url(#pro-drop-shadow); }
</style>

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="sidebar w-20 hover:w-64 bg-secondary h-screen flex flex-col p-4 border-r border-border-color fixed top-0 left-0 z-40">
        <div class="flex items-center justify-center mb-10 h-10">
            <svg class="w-10 h-10 text-accent-color" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
            </svg>
            <span class="sidebar-text text-xl font-bold ml-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">Prolific</span>
        </div>
       <nav class="flex-grow space-y-3">
            <a href="#" data-page="journal" class="sidebar-link flex items-center p-3 rounded-lg text-text-secondary hover:bg-tertiary transition-colors duration-200 active">
                <svg class="w-6 h-6 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                <span class="sidebar-text ml-4 font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">Journal</span>
            </a>
            <a href="#" data-page="playbook" class="sidebar-link flex items-center p-3 rounded-lg text-text-secondary hover:bg-tertiary transition-colors duration-200">
                <svg class="w-6 h-6 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.63 2.25c-5.508 0-10.72 2.266-10.72 5.5s5.212 5.5 10.72 5.5c1.233 0 2.417-.172 3.5-.472z" /></svg>
                <span class="sidebar-text ml-4 font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">Playbook</span>
            </a>
            <a href="#" data-page="goals" class="sidebar-link flex items-center p-3 rounded-lg text-text-secondary hover:bg-tertiary transition-colors duration-200">
                <svg class="w-6 h-6 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>
                <span class="sidebar-text ml-4 font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">Goals</span>
            </a>
            <a href="#" data-page="analytics" class="sidebar-link flex items-center p-3 rounded-lg text-text-secondary hover:bg-tertiary transition-colors duration-200">
                <svg class="w-6 h-6 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" /></svg>
                <span class="sidebar-text ml-4 font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">Analytics</span>
            </a>

            <a href="#" data-page="chart" class="sidebar-link flex items-center p-3 rounded-lg text-text-secondary hover:bg-tertiary transition-colors duration-200">
                <svg class="w-6 h-6 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-3.75-3.75M21 12l-3.75 3.75" />
                </svg>
                <span class="sidebar-text ml-4 font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">Chart</span>
            </a>
        </nav>
    <div class="mt-auto space-y-3">

            <div class="sidebar-link flex items-center p-3 w-full rounded-lg justify-between">
                <div class="flex items-center">
                    <svg class="w-6 h-6 flex-shrink-0 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                    </svg>
                    <span class="sidebar-text ml-4 font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">Theme</span>
                </div>
                <div class="theme-switch-wrapper sidebar-text opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <label class="theme-switch" for="theme-toggle">
                        <input type="checkbox" id="theme-toggle" />
                        <div class="slider round"></div>
                    </label>
                </div>
            </div>

            <button id="settings-menu-btn" class="sidebar-link flex items-center p-3 w-full rounded-lg text-text-secondary hover:bg-tertiary transition-colors duration-200">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <span class="sidebar-text ml-4 font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">Settings</span>
            </button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main id="main-content" class="flex-1 ml-20 p-4 md:p-6 lg:p-8 transition-all duration-300">
        <!-- Header -->
        <header class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <div>
                <h1 id="page-title" class="text-3xl font-bold text-text-primary">Prolific Journal</h1>
                <p class="text-text-secondary">Log and review your trading performance.</p>
            </div>
            <div class="flex items-center gap-2 sm:gap-4">
                <div class="relative">
                    <select id="account-switcher" class="form-input text-sm rounded-lg p-2 w-48 appearance-none pr-8"></select>
                    <svg class="w-4 h-4 absolute right-3 top-1/2 -translate-y-1/2 text-text-secondary pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                </div>
                <button id="manage-accounts-btn" title="Manage Accounts" class="btn p-2 bg-tertiary border border-border-color rounded-lg hover:bg-border-color transition-colors flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-text-secondary"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.38"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <div id="page-content" class="animate-fade-in">
            <!-- Journal Page -->
            <div id="journal-page">
                <!-- Performance Dashboard -->
               <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up col-span-2 lg:col-span-1">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-sm font-medium text-text-secondary">Prolific Score</p>
            <p id="prolific-score" class="text-2xl font-bold text-text-primary">0</p>
        </div>
        <div id="prolific-score-gauge" class="w-16 h-16"></div>
    </div>
</div>
    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-text-secondary">Total P/L</p>
                <p id="total-pl" class="text-2xl font-bold text-text-primary">$0.00</p>
            </div>
            <div id="pl-sparkline" class="w-24 h-10"></div>
        </div>
    </div>
    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-text-secondary">Win Rate</p>
                <p id="win-rate" class="text-2xl font-bold text-text-primary">0%</p>
            </div>
            <div id="winrate-donut" class="w-10 h-10"></div>
        </div>
    </div>
    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-text-secondary">Realized R:R</p>
                <p id="realized-rr" class="text-2xl font-bold text-text-primary">1 : 0.00</p>
            </div>
            <div id="rr-barchart" class="w-12 h-10"></div>
        </div>
    </div>

    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-sm font-medium text-text-secondary">Avg. Win</p>
            <p id="avg-profit" class="text-xl font-bold text-green-500">$0.00</p>
        </div>
        <div id="avg-win-loss-bars" class="w-12 h-10"></div>
        <div>
            <p class="text-sm font-medium text-text-secondary">Avg. Loss</p>
            <p id="avg-loss" class="text-xl font-bold text-red-500">$0.00</p>
        </div>
    </div>
</div>
    
    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up">
        <p class="text-sm font-medium text-text-secondary">Total Trades</p>
        <p id="total-trades" class="text-2xl font-bold text-text-primary">0</p>
    </div>
</div>
                
                 <!-- Account Overview -->
                <div class="mb-6 card p-6 rounded-xl shadow-sm animate-fade-in-up">
                    <h2 class="text-xl font-semibold mb-4 text-text-primary">Account Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div class="flex items-center gap-4 col-span-1 md:col-span-1">
                            <div class="flex-1">
                                <label for="starting-balance" class="block text-sm font-medium text-text-secondary">Starting Balance ($)</label>
                                <input type="number" id="starting-balance" placeholder="e.g., 10000" class="mt-1 w-full p-2 form-input rounded-lg">
                            </div>
                            <button id="save-balance-btn" class="self-end font-semibold py-2 px-4 rounded-lg transition-colors btn btn-primary text-white">Save</button>
                        </div>
                        <div class="col-span-1 md:col-span-1">
                            <p class="text-sm font-medium text-text-secondary">Account Growth</p>
                            <p id="account-growth" class="text-3xl font-bold text-text-primary">0.00%</p>
                        </div>
                         <div class="col-span-1 md:col-span-1">
                            <p class="text-sm font-medium text-text-secondary">Current Balance</p>
                            <p id="current-balance" class="text-3xl font-bold text-text-primary">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Main Content: Form and History -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card p-6 rounded-xl shadow-sm self-start animate-fade-in-up">
                        <h2 id="form-title" class="text-xl font-semibold mb-4 text-text-primary">Log New Trade</h2>
                        <div class="space-y-4">
                              <input type="hidden" id="editing-trade-id">
                            <div>
                                <label for="index-selector" class="block text-sm font-medium text-text-secondary">Instrument</label>
                                <select id="index-selector" class="mt-1 w-full p-2 form-input rounded-lg">
                                      <optgroup label="Stock Indices">
                                          <option value="US Wall Street 30">US Wall Street 30</option><option value="US 500">US 500</option><option value="US Tech 100">US Tech 100</option><option value="Germany 40">Germany 40</option><option value="UK 100">UK 100</option><option value="Japan 225">Japan 225</option>
                                    </optgroup>
                                      <optgroup label="Metals">
                                        <option value="Gold">Gold</option><option value="Silver">Silver</option><option value="Platinum">Platinum</option>
                                    </optgroup>
                                      <optgroup label="Commodities">
                                        <option value="Oil (WTI)">Oil (WTI)</option><option value="Natural Gas">Natural Gas</option>
                                    </optgroup>
                                      <optgroup label="Forex - Majors">
                                        <option value="EUR/USD">EUR/USD</option><option value="GBP/USD">GBP/USD</option><option value="USD/JPY">USD/JPY</option><option value="USD/CAD">USD/CAD</option><option value="AUD/USD">AUD/USD</option><option value="USD/CHF">USD/CHF</option><option value="NZD/USD">NZD/USD</option>
                                    </optgroup>
                                      <optgroup label="Forex - Minors">
                                        <option value="EUR/GBP">EUR/GBP</option><option value="EUR/JPY">EUR/JPY</option><option value="EUR/AUD">EUR/AUD</option><option value="EUR/CAD">EUR/CAD</option><option value="EUR/CHF">EUR/CHF</option><option value="EUR/NZD">EUR/NZD</option><option value="GBP/JPY">GBP/JPY</option><option value="GBP/AUD">GBP/AUD</option><option value="GBP/CAD">GBP/CAD</option><option value="GBP/CHF">GBP/CHF</option><option value="GBP/NZD">GBP/NZD</option><option value="AUD/JPY">AUD/JPY</option><option value="AUD/CAD">AUD/CAD</option><option value="AUD/CHF">AUD/CHF</option><option value="AUD/NZD">AUD/NZD</option><option value="CAD/JPY">CAD/JPY</option><option value="CAD/CHF">CAD/CHF</option><option value="CHF/JPY">CHF/JPY</option><option value="NZD/JPY">NZD/JPY</option><option value="NZD/CAD">NZD/CAD</option><option value="NZD/CHF">NZD/CHF</option>
                                    </optgroup>
                                      <optgroup label="Forex - Exotics">
                                        <option value="USD/ZAR">USD/ZAR</option><option value="USD/MXN">USD/MXN</option><option value="USD/SGD">USD/SGD</option><option value="USD/HKD">USD/HKD</option><option value="USD/TRY">USD/TRY</option><option value="EUR/TRY">EUR/TRY</option>
                                    </optgroup>
                                      <optgroup label="Volatility Indices">
                                        <option value="Volatility 10 Index">Volatility 10 Index</option><option value="Volatility 25 Index">Volatility 25 Index</option><option value="Volatility 50 Index">Volatility 50 Index</option><option value="Volatility 75 Index">Volatility 75 Index</option><option value="Volatility 100 Index">Volatility 100 Index</option><option value="Volatility 10 (1s) Index">Volatility 10 (1s) Index</option><option value="Volatility 25 (1s) Index">Volatility 25 (1s) Index</option><option value="Volatility 50 (1s) Index">Volatility 50 (1s) Index</option><option value="Volatility 75 (1s) Index">Volatility 75 (1s) Index</option><option value="Volatility 100 (1s) Index">Volatility 100 (1s) Index</option>
                                    </optgroup>
                                      <optgroup label="Crash/Boom">
                                        <option value="Crash 300 Index">Crash 300 Index</option><option value="Crash 500 Index">Crash 500 Index</option><option value="Crash 1000 Index">Crash 1000 Index</option><option value="Boom 300 Index">Boom 300 Index</option><option value="Boom 500 Index">Boom 500 Index</option><option value="Boom 1000 Index">Boom 1000 Index</option>
                                    </optgroup>
                                      <optgroup label="Jump Indices">
                                        <option value="Jump 10 Index">Jump 10 Index</option><option value="Jump 25 Index">Jump 25 Index</option><option value="Jump 50 Index">Jump 50 Index</option><option value="Jump 75 Index">Jump 75 Index</option><option value="Jump 100 Index">Jump 100 Index</option>
                                    </optgroup>
                                      <optgroup label="Step Indices">
                                        <option value="Step Index">Step Index</option>
                                    </optgroup>
                                      <optgroup label="Range Break Indices">
                                        <option value="Range Break 100 Index">Range Break 100 Index</option><option value="Range Break 200 Index">Range Break 200 Index</option>
                                    </optgroup>
                                      <optgroup label="DEX Indices">
                                        <option value="DEX 600UP Index">DEX 600UP Index</option><option value="DEX 900UP Index">DEX 900UP Index</option><option value="DEX 1500UP Index">DEX 1500UP Index</option><option value="DEX 600DN Index">DEX 600DN Index</option><option value="DEX 900DN Index">DEX 900DN Index</option><option value="DEX 1500DN Index">DEX 1500DN Index</option>
                                    </optgroup>
                                </select>
                            </div>
                              <div>
                                <label for="playbook-select" class="block text-sm font-medium text-text-secondary">Playbook Setup</label>
                                <select id="playbook-select" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <option value="">None</option>
                                </select>
                            </div>
                             <div>
    <label for="entry-timeframe" class="block text-sm font-medium text-text-secondary">Entry Timeframe</label>
    <select id="entry-timeframe" class="form-input mt-1 w-full p-2 rounded-lg">
        <option value="1m">1 Minute</option>
        <option value="3m">3 Minutes</option>
        <option value="5m">5 Minutes</option>
        <option value="15m">15 Minutes</option>
        <option value="30m">30 Minutes</option>
        <option value="1H">1 Hour</option>
        <option value="4H">4 Hours</option>
        <option value="D">Daily</option>
        <option value="W">Weekly</option>
    </select>
</div>
                            <div class="collapsible-container border-y border-border-color" id="checklist-collapsible">
                            <div class="collapsible-header">
                                <label class="block text-sm font-medium text-text-secondary">Pre-Trade Checklist</label>
                                <svg class="collapsible-icon w-4 h-4 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                            <div class="collapsible-content">
                                <button id="manage-checklist-btn" class="text-xs text-accent-color font-semibold hover:underline mb-2">Manage</button>
                                <div id="trade-checklist" class="w-full p-2 form-input rounded-lg max-h-[150px] overflow-y-auto"></div>
                            </div>
                        </div>
                            <div class="collapsible-container border-b border-border-color" id="strategy-tags-collapsible">
                            <div class="collapsible-header">
                                <label class="block text-sm font-medium text-text-secondary">Strategy Tags</label>
                                <svg class="collapsible-icon w-4 h-4 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                            <div class="collapsible-content">
                                <button id="manage-tags-btn" class="text-xs text-accent-color font-semibold hover:underline mb-2">Manage Tags</button>
                                <div id="tags-checklist" class="w-full p-2 form-input rounded-lg max-h-[150px] overflow-y-auto"></div>
                            </div>
                        </div>
                        <div class="collapsible-container border-b border-border-color" id="psychology-tags-collapsible">
                            <div class="collapsible-header">
                                <label class="block text-sm font-medium text-text-secondary">Psychology Tags</label>
                                <svg class="collapsible-icon w-4 h-4 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                            <div class="collapsible-content">
                                <button id="manage-psychology-tags-btn" class="text-xs text-accent-color font-semibold hover:underline mb-2">Manage Psychology Tags</button>
                                <div id="psychology-tags-checklist" class="w-full p-2 form-input rounded-lg max-h-[150px] overflow-y-auto"></div>
                            </div>
                        </div>
                            <div>
                                <label class="block text-sm font-medium text-text-secondary">Trade Type</label>
                                <div class="mt-1 grid grid-cols-2 gap-2">
                                      <button id="buy-btn" class="trade-type-btn bg-blue-500 text-white p-2 rounded-lg btn">Buy</button>
                                      <button id="sell-btn" class="trade-type-btn bg-tertiary text-text-secondary p-2 rounded-lg btn">Sell</button>
                                </div>
                            </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                   <label for="entry-price" class="block text-sm font-medium text-text-secondary">Entry Price</label>
                                   <input type="number" id="entry-price" placeholder="e.g., 12345.6" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                                <div>
                                   <label for="exit-price" class="block text-sm font-medium text-text-secondary">Exit Price</label>
                                   <input type="number" id="exit-price" placeholder="Leave blank if open" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                            </div>
                            <div id="realtime-pl-display" class="p-2 text-center rounded-lg h-10 transition-all"></div>
                            <div class="grid grid-cols-2 gap-4">
    <div>
        <label for="lot-size" class="block text-sm font-medium text-text-secondary">Lot Size</label>
        <input type="number" id="lot-size" placeholder="e.g., 0.2" class="form-input mt-1 w-full p-2 rounded-lg">
    </div>
     <div id="num-positions-container">
        <label for="num-positions" class="block text-sm font-medium text-text-secondary">No. of Positions</label>
        <input type="number" id="num-positions" value="1" min="1" class="form-input mt-1 w-full p-2 rounded-lg">
    </div>
</div>
                             <div class="p-3 rounded-lg border border-border-color bg-tertiary/50 space-y-3 mb-4">
    <label class="block text-sm font-bold text-accent-color">Risk to SL Calculator</label>
    <div class="flex items-center gap-2">
        <input type="number" id="risk-percentage" placeholder="Risk %" class="form-input w-full p-2 rounded-lg text-sm">
        <button id="calculate-sl-from-risk-btn" class="btn btn-primary text-white font-semibold py-2 px-4 rounded-lg w-full">Calculate SL</button>
    </div>
</div>
                              <div>
                                <label for="stop-loss" class="block text-sm font-medium text-text-secondary">Stop Loss</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="stop-loss" placeholder="Price level" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <input type="number" id="sl-pips" placeholder="pips/pts" class="form-input mt-1 w-20 p-2 rounded-lg text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="take-profit" class="block text-sm font-medium text-text-secondary">Take Profit</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="take-profit" placeholder="Price level" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <input type="number" id="tp-pips" placeholder="pips/pts" class="form-input mt-1 w-20 p-2 rounded-lg text-sm">
                                </div>
                            </div>
                              <div class="collapsible-container border-t border-border-color mt-4" id="advanced-options-collapsible">
                            <div class="collapsible-header">
                                <label class="block text-sm font-medium text-text-secondary">Advanced Options</label>
                                <svg class="collapsible-icon w-4 h-4 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                            <div class="collapsible-content space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="peak-price" class="block text-sm font-medium text-text-secondary">Peak Profit Price (MFE)</label>
                                        <input type="number" id="peak-price" placeholder="For losing trades" class="form-input mt-1 w-full p-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label for="mae-price" class="block text-sm font-medium text-text-secondary">Peak Drawdown Price (MAE)</label>
                                        <input type="number" id="mae-price" placeholder="For winning trades" class="form-input mt-1 w-full p-2 rounded-lg">
                                    </div>
                                </div>
                                <div>
                                    <label for="fees" class="block text-sm font-medium text-text-secondary">Commissions & Fees</label>
                                    <input type="number" id="fees" placeholder="e.g., 5.50" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                            </div>
                        </div>
                            <div>
                                <label for="trade-comments-editor" class="block text-sm font-medium text-text-secondary">Comments & Screenshots</label>
                                <div id="trade-comments-editor" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg max-h-[400px] overflow-y-auto" data-placeholder="Add notes, paste or drag images here..."></div>
                            </div>
                            <button id="log-trade-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg shadow-md text-white">Log Trade</button>
                            <button id="cancel-edit-btn" class="hidden w-full bg-tertiary text-text-primary font-bold py-2 px-4 rounded-lg hover:bg-border-color transition-colors mt-2">Cancel Edit</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 card p-6 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                        <div class="flex flex-wrap gap-4 items-center justify-between mb-4">
                              <h2 class="text-xl font-semibold text-text-primary">Trade History</h2>
                            <div id="filter-bar" class="flex flex-wrap items-center gap-2 text-sm">
                                <select id="filter-instrument" class="form-input rounded-lg p-1.5"><option value="">All Instruments</option></select>
                                <select id="filter-timeframe" class="form-input rounded-lg p-1.5"><option value="">All Timeframes</option></select>
                                <select id="filter-tag" class="form-input rounded-lg p-1.5"><option value="">All Tags</option></select>
                                <select id="filter-psychology-tag" class="form-input rounded-lg p-1.5"><option value="">All Psychology</option></select>
                                <select id="filter-type" class="form-input rounded-lg p-1.5"><option value="">All Types</option><option value="Buy">Buy</option><option value="Sell">Sell</option></select>
                                <select id="filter-outcome" class="form-input rounded-lg p-1.5"><option value="">All Outcomes</option><option value="win">Win</option><option value="loss">Loss</option><option value="breakeven">Breakeven</option><option value="open">Open</option></select>
                                <input type="date" id="filter-start-date" class="form-input rounded-lg p-1.5 text-sm" title="Start Date">
                                <input type="date" id="filter-end-date" class="form-input rounded-lg p-1.5 text-sm" title="End Date">
                                <button id="reset-filters-btn" class="p-1.5 text-text-secondary hover:text-text-primary">Reset</button>
                            </div>
                        </div>
                        <div id="filter-status" class="text-xs text-accent-color mb-2 hidden"></div>
                        <div class="overflow-y-auto" style="max-height: 150vh;">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-text-secondary uppercase bg-bg-tertiary sticky top-0 z-10">
    <tr>
        <th scope="col" class="px-4 py-3 w-10">
            <input type="checkbox" id="select-all-trades" onclick="toggleSelectAll(this)" class="w-4 h-4 rounded border-border-color bg-bg-primary text-accent-color focus:ring-accent-color cursor-pointer">
        </th>
        <th scope="col" class="px-4 py-3">Trade Details</th>
        <th scope="col" class="px-4 py-3">Type</th>
        <th scope="col" class="px-4 py-3">Net P/L ($)</th>
        <th scope="col" class="px-4 py-3">Actions</th>
    </tr>
</thead>
                                <tbody id="trade-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals Page -->
            <div id="goals-page" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card p-6 rounded-xl shadow-sm self-start animate-fade-in-up">
                        <h2 id="goal-form-title" class="text-xl font-semibold mb-4 text-text-primary">Add New Goal</h2>
                         <form class="space-y-4" id="add-goal-form">
                              <input type="hidden" id="editing-goal-id">
                            <div>
                                <label for="goal-title" class="block text-sm font-medium text-text-secondary">Goal Title</label>
                                <input type="text" id="goal-title" placeholder="e.g., Monthly Profit Target" class="form-input mt-1 w-full p-2 rounded-lg">
                            </div>
                            <div>
                                <label for="goal-metric" class="block text-sm font-medium text-text-secondary">Metric</label>
                                <select id="goal-metric" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <option value="totalPL">Total P/L ($)</option>
                                    <option value="winRate">Win Rate (%)</option>
                                    <option value="profitFactor">Profit Factor</option>
                                </select>
                            </div>
                            <div>
                                <label for="goal-target" class="block text-sm font-medium text-text-secondary">Target Value</label>
                                <input type="number" id="goal-target" placeholder="e.g., 1000" class="form-input mt-1 w-full p-2 rounded-lg">
                            </div>
                            <div>
                                <label for="goal-timeframe" class="block text-sm font-medium text-text-secondary">Timeframe</label>
                                <select id="goal-timeframe" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <button type="button" id="add-goal-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg shadow-md text-white">Add Goal</button>
                           <button type="button" id="cancel-goal-edit-btn" class="hidden w-full bg-tertiary text-text-primary font-bold py-2 px-4 rounded-lg hover:bg-border-color transition-colors mt-2">Cancel Edit</button>
                        </form>
                    </div>
                     <div class="lg:col-span-2 card p-6 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                         <h2 class="text-xl font-semibold mb-4 text-text-primary">Active Goals</h2>
                         <div id="goals-list" class="space-y-4">
                        </div>
                     </div>
                </div>
            </div>

             <!-- Playbook Page -->
            <div id="playbook-page" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card p-6 rounded-xl shadow-sm self-start animate-fade-in-up">
                        <h2 id="play-form-title" class="text-xl font-semibold mb-4 text-text-primary">Add New Play</h2>
                        <input type="hidden" id="editing-play-id">
                        <div class="space-y-4">
                              <div>
                                <label for="play-title" class="block text-sm font-medium text-text-secondary">Play Title</label>
                                <input type="text" id="play-title" placeholder="e.g., London Killzone Scalp" class="form-input mt-1 w-full p-2 rounded-lg">
                            </div>
                              <div>
                                <label for="play-instruments" class="block text-sm font-medium text-text-secondary">Optimal Instruments</label>
                                <select id="play-instruments" multiple class="form-input mt-1 w-full p-2 rounded-lg h-32"></select>
                            </div>
                            <div>
                                <label for="play-market-condition" class="block text-sm font-medium text-text-secondary">Ideal Market Condition</label>
                                <select id="play-market-condition" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <option>Trending</option>
                                    <option>Ranging</option>
                                    <option>Volatile</option>
                                </select>
                            </div>
                            <div>
                                <label for="play-entry-criteria" class="block text-sm font-medium text-text-secondary">Entry Criteria</label>
                                <div id="play-entry-criteria" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg playbook-textarea" data-placeholder="1. Market structure shift..."></div>
                            </div>
                              <div>
                                <label for="play-sl-rules" class="block text-sm font-medium text-text-secondary">Stop Loss Rules</label>
                                <div id="play-sl-rules" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg playbook-textarea" data-placeholder="e.g., 5 pips above previous high"></div>
                            </div>
                              <div>
                                <label for="play-management-rules" class="block text-sm font-medium text-text-secondary">Trade Management</label>
                                <div id="play-management-rules" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg playbook-textarea" data-placeholder="e.g., Move to BE at 1R"></div>
                            </div>
                            <div>
                                <label for="play-confidence-rating" class="block text-sm font-medium text-text-secondary">Confidence Rating</label>
                                <div id="play-confidence-rating" class="star-rating mt-1">
                                    <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars"></label>
                                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars"></label>
                                    <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars"></label>
                                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars"></label>
                                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star"></label>
                                </div>
                            </div>
                            <div>
                                <label for="play-review-notes" class="block text-sm font-medium text-text-secondary">Review Notes</label>
                                <div id="play-review-notes" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg playbook-textarea" data-placeholder="e.g., Underperforms in choppy markets..."></div>
                            </div>
                              <div>
                                <label class="block text-sm font-medium text-text-secondary">"Before" Screenshot</label>
                                <div id="play-before-image" class="mt-1 image-dropzone h-32 flex items-center justify-center border-2 border-dashed border-border-color rounded-lg text-text-secondary cursor-pointer">
                                    Click or Drag Image Here
                                </div>
                                <input type="file" id="play-before-file" class="hidden" accept="image/*">
                            </div>
                              <div>
                                <label class="block text-sm font-medium text-text-secondary">"After" Screenshot</label>
                                <div id="play-after-image" class="mt-1 image-dropzone h-32 flex items-center justify-center border-2 border-dashed border-border-color rounded-lg text-text-secondary cursor-pointer">
                                    Click or Drag Image Here
                                </div>
                                 <input type="file" id="play-after-file" class="hidden" accept="image/*">
                            </div>
                            <button id="save-play-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg shadow-md text-white">Save Play</button>
                           <button id="cancel-play-edit-btn" class="hidden w-full bg-tertiary text-text-primary font-bold py-2 px-4 rounded-lg hover:bg-border-color transition-colors mt-2">Cancel Edit</button>
                        </div>
                    </div>
                     <div class="lg:col-span-2 card p-6 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                         <h2 class="text-xl font-semibold mb-4 text-text-primary">My Playbook</h2>
                         <div id="playbook-list" class="space-y-4">
                        </div>
                     </div>
                </div>
            </div>
  <div id="page-content" class="animate-fade-in">
            <div id="chart-page" class="hidden">
                <div id="tradingview-widget-container" class="h-[85vh] w-full"></div>
            </div>

            <!-- Analytics Page -->
            <div id="analytics-page" class="hidden">
                <div id="drilldown-status-bar" class="hidden items-center justify-between bg-accent-color/20 text-accent-color p-3 rounded-lg mb-4">
                    <p class="font-semibold">Showing analytics for: <span id="drilldown-filter-name" class="font-bold underline"></span></p>
                    <button id="clear-drilldown-btn" class="font-bold text-lg hover:text/white">&times;</button>
                </div>

                <!-- START: Collapsible Adviser Panel -->
<div id="adviser-panel" class="collapsible-container card p-6 rounded-xl shadow-sm animate-fade-in-up mb-6 border-l-4 border-accent-color">
    <!-- This is the new clickable header -->
    <div class="collapsible-header">
        <h2 class="text-xl font-semibold text-text-primary flex items-center gap-2">
            <svg xmlns="http://www.w.org/2000/svg" class="h-6 w-6 text-accent-color" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v2.5a1.5 1.5 0 01-3 0v-.5a1 1 0 00-1-1h-3a1 1 0 00-1 1v10a1 1 0 001 1h3a1 1 0 001-1v-.5a1.5 1.5 0 013 0V18a1 1 0 01-1 1h-3a1 1 0 01-1-1v-2.5a1.5 1.5 0 00-3 0V17a1 1 0 01-1 1H5a1 1 0 01-1-1v-2.5a1.5 1.5 0 00-3 0V6a1 1 0 011-1h3a1 1 0 011 1v.5a1.5 1.5 0 003 0V3.5z" /></svg>
            <span>Trading Adviser</span>
        </h2>
        <!-- This is the rotating arrow icon -->
        <svg class="collapsible-icon w-6 h-6 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
    </div>

    <!-- This content will now hide and show -->
    <div class="collapsible-content">
        <div id="adviser-content" class="space-y-4"></div>
    </div>
</div>
<!-- END: Collapsible Adviser Panel -->

                <div class="analytics-tabs">
                    <button class="tab-btn active" data-tab="overview">Overview</button>
                    <button class="tab-btn" data-tab="deep-dive">Performance Deep Dive</button>
                    <button class="tab-btn" data-tab="risk-execution">Risk & Execution</button>
                    <button class="tab-btn" data-tab="forecasting">Forecasting & Tools</button>
                </div>

                <div id="analytics-content-for-pdf">
                    <div id="overview-tab" class="tab-content active animate-fade-in">
                        <div class="space-y-6">
                            <div class="card p-6 rounded-xl shadow-sm">
    <div class="flex flex-wrap justify-between items-center gap-y-2 mb-4">
        <h2 class="text-xl font-semibold text-text-primary">Equity Curve Analysis</h2>
        <div id="equity-curve-toggles" class="flex items-center gap-4 text-xs font-medium">
            <label class="flex items-center cursor-pointer hover:text-text-primary transition-colors">
                <input type="checkbox" id="toggle-hwm" class="w-4 h-4 text-accent-color bg-tertiary border-border-color rounded focus:ring-accent-color" checked>
                <span class="ml-2 text-text-secondary">High-Water Mark</span>
            </label>
            <label class="flex items-center cursor-pointer hover:text-text-primary transition-colors">
                <input type="checkbox" id="toggle-trades" class="w-4 h-4 text-accent-color bg-tertiary border-border-color rounded focus:ring-accent-color" checked>
                <span class="ml-2 text-text-secondary">Show Trades</span>
            </label>
        </div>
    </div>
    <div class="h-96">
        <canvas id="equityCurveChart"></canvas>
    </div>
</div>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                <div class="card p-4 rounded-xl shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-text-secondary">Profit Factor</p><svg data-tippy-content="Gross Profit / Gross Loss. Measures how many dollars you make for every dollar you lose. A value > 1 is profitable." xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-text-secondary cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><p id="profit-factor" class="text-2xl font-bold text-text-primary">0.00</p></div>
                                <div class="card p-4 rounded-xl shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-text-secondary">Expectancy</p><svg data-tippy-content="The average amount you can expect to win or lose per trade. Calculated as (Win Rate * Avg Win) - (Loss Rate * Avg Loss)." xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-text-secondary cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><p id="expectancy" class="text-2xl font-bold text-text-primary">$0.00</p></div>
                                <div class="card p-4 rounded-xl shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-text-secondary">Recovery Factor</p><svg data-tippy-content="Total Net Profit / Max Drawdown. Measures the system's ability to recover from its largest loss period. Higher is better." xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-text-secondary cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><p id="recovery-factor" class="text-2xl font-bold text-text-primary">0.00</p></div>
                                <div class="card p-4 rounded-xl shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-text-secondary">Longest Win Streak</p><svg data-tippy-content="The highest number of consecutive winning trades." xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-text-secondary cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><p id="win-streak" class="text-2xl font-bold text-green-500">0</p></div>
                                <div class="card p-4 rounded-xl shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-text-secondary">Longest Loss Streak</p><svg data-tippy-content="The highest number of consecutive losing trades." xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-text-secondary cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><p id="loss-streak" class="text-2xl font-bold text-red-500">0</p></div>
                            </div>
                            <div class="card p-6 rounded-xl shadow-sm">
                                <h2 class="text-xl font-semibold mb-4 text-text-primary">Drawdown Analysis</h2>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                    <div><p class="text-sm font-medium text-text-secondary">Max Drawdown ($)</p><p id="max-drawdown-usd" class="text-2xl font-bold text-red-500">$0.00</p></div>
                                    <div><p class="text-sm font-medium text-text-secondary">Max Drawdown (%)</p><p id="max-drawdown-pct" class="text-2xl font-bold text-red-500">0.00%</p></div>
                                    <div><p class="text-sm font-medium text-text-secondary">Longest Drawdown</p><p id="longest-drawdown-period" class="text-2xl font-bold text-red-500">0 days</p></div>
                                </div>
                                <div class="mt-4 h-48"><canvas id="drawdownChart"></canvas></div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="card p-6 rounded-xl shadow-sm"><h2 class="text-xl font-semibold mb-4 text-text-primary">Performance by Day of Week</h2><canvas id="dailyPerformanceChart"></canvas></div>
                                <div class="card p-6 rounded-xl shadow-sm"><h2 class="text-xl font-semibold mb-4 text-text-primary">Performance by Hour of Day</h2><canvas id="hourlyPerformanceChart"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <div id="deep-dive-tab" class="tab-content animate-fade-in">
                        <div class="space-y-6">
                            <div class="card p-6 rounded-xl shadow-sm"><h2 class="text-xl font-semibold mb-4 text-text-primary">Performance by Instrument</h2><div id="index-performance-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                            
                            <div class="card p-6 rounded-xl shadow-sm"><h2 class="text-xl font-semibold mb-4 text-text-primary">Performance by Strategy Tag</h2><p class="text-xs text-text-secondary mb-4 -mt-3">Analyzes performance based on your custom strategy tags.</p><div id="tag-performance-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                            <div class="card p-6 rounded-xl shadow-sm"><h2 class="text-xl font-semibold mb-4 text-text-primary">Psychology & Performance Analysis</h2><p class="text-xs text-text-secondary mb-4 -mt-3">Analyzes performance based on your psychology tags.</p><div id="psychology-performance-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                            <div class="card p-6 rounded-xl shadow-sm"><h2 class="text-xl font-semibold mb-4 text-text-primary">Performance by Entry Timeframe</h2><div id="timeframe-performance-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                    </div>
                    </div>

                    <div id="risk-execution-tab" class="tab-content animate-fade-in">
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        
        <div class="card p-5 rounded-xl border border-border-color bg-bg-secondary shadow-sm relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider">Avg Planned R:R</h3>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-accent-color" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20"/><path d="M12 2v18"/><path d="M22 2l-10 10"/></svg>
            </div>
            <div id="kpi-planned-rr" class="text-2xl font-bold text-text-primary">--</div>
            <p class="text-xs text-text-secondary mt-1">Target structure</p>
        </div>

        <div class="card p-5 rounded-xl border border-border-color bg-bg-secondary shadow-sm relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider">Realized R:R</h3>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>
            </div>
            <div id="kpi-realized-rr" class="text-2xl font-bold text-text-primary">--</div>
            <p id="kpi-realized-sub" class="text-xs text-text-secondary mt-1">Actual performance</p>
        </div>

        <div class="card p-5 rounded-xl border border-border-color bg-bg-secondary shadow-sm relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider">Exit Efficiency</h3>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            </div>
            <div id="kpi-efficiency" class="text-2xl font-bold text-text-primary">--%</div>
            <div class="w-full bg-bg-tertiary h-1.5 rounded-full mt-2 overflow-hidden">
                <div id="kpi-efficiency-bar" class="h-full bg-yellow-500 transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div class="card p-5 rounded-xl border border-border-color bg-bg-secondary shadow-sm relative overflow-hidden">
             <div class="flex justify-between items-start mb-2">
                <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider">Near Death Wins</h3>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </div>
            <div id="kpi-near-death" class="text-2xl font-bold text-text-primary">--</div>
            <p class="text-xs text-text-secondary mt-1">Trades saved by < 15%</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <div class="card p-6 rounded-xl border border-border-color bg-bg-secondary shadow-sm lg:col-span-2 flex flex-col">
            <div class="mb-4">
                <h3 class="font-bold text-lg text-text-primary">Risk Consistency</h3>
                <p class="text-xs text-text-secondary">Initial Dollar Risk per Trade (Discipline Tracker)</p>
            </div>
            <div class="flex-1 min-h-[250px] relative">
                <canvas id="riskConsistencyChart"></canvas>
            </div>
        </div>

        <div class="card p-0 rounded-xl border border-border-color bg-bg-secondary shadow-sm overflow-hidden flex flex-col">
            <div class="p-5 border-b border-border-color">
                <h3 class="font-bold text-lg text-text-primary">Pain vs. Gain</h3>
                <p class="text-xs text-text-secondary">Analysis of drawdown vs missed profit</p>
            </div>
            
            <div class="flex-1 grid grid-rows-2">
                <div class="p-6 border-b border-border-color/10 bg-green-500/5 flex flex-col justify-center relative group hover:bg-green-500/10 transition-colors">
                    <div class="flex justify-between items-end">
                         <div>
                             <span class="text-sm font-semibold text-green-400 uppercase tracking-wide">Missed Profit</span>
                             <div id="dash-mfe-val" class="text-2xl font-bold text-green-400 mt-1">--</div>
                         </div>
                         <div class="text-right">
                             <div id="dash-mfe-pct" class="text-sm font-mono text-green-400/70">--%</div>
                         </div>
                    </div>
                    <p class="text-xs text-text-secondary mt-2 opacity-60 group-hover:opacity-100">Avg profit seen on losing trades</p>
                </div>

                <div class="p-6 bg-red-500/5 flex flex-col justify-center relative group hover:bg-red-500/10 transition-colors">
                    <div class="flex justify-between items-end">
                         <div>
                             <span class="text-sm font-semibold text-red-400 uppercase tracking-wide">Max Drawdown</span>
                             <div id="dash-mae-val" class="text-2xl font-bold text-red-400 mt-1">--</div>
                         </div>
                         <div class="text-right">
                             <div id="dash-mae-pct" class="text-sm font-mono text-red-400/70">--%</div>
                         </div>
                    </div>
                     <p class="text-xs text-text-secondary mt-2 opacity-60 group-hover:opacity-100">Avg heat taken on winning trades</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-6 rounded-xl border border-border-color bg-bg-secondary shadow-sm">
        <h3 class="font-bold text-lg text-text-primary mb-4">Performance by Planned R:R</h3>
        <div id="rr-performance-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            </div>
    </div>
</div>

                    <div id="forecasting-tab" class="tab-content animate-fade-in">
                        <div class="space-y-6">
                            <div class="card p-6 rounded-xl shadow-sm"><h2 class="text-xl font-semibold mb-4 text-text-primary">Monte Carlo Simulation</h2><div class="flex flex-wrap items-end gap-4 mb-4"><div><label for="mc-trades" class="block text-sm font-medium text-text-secondary">Trades to Project</label><input type="number" id="mc-trades" value="252" class="form-input mt-1 p-2 rounded-lg w-32"></div><div><label for="mc-simulations" class="block text-sm font-medium text-text-secondary">Simulations</label><input type="number" id="mc-simulations" value="1000" class="form-input mt-1 p-2 rounded-lg w-32"></div><button id="run-mc-btn" class="font-semibold py-2 px-4 rounded-lg btn btn-primary text-white">Run Simulation</button></div><div id="mc-results-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"><canvas id="mcChart"></canvas><div id="mc-stats" class="text-sm"></div></div></div>
                            <div class="card p-6 rounded-xl shadow-sm"><h2 class="text-xl font-semibold mb-4 text-text-primary">Trade Calendar</h2><div class="flex items-center justify-between mb-4"><button id="calendar-prev-btn" class="p-2 rounded-full hover:bg-tertiary">&lt;</button><h3 id="calendar-title" class="text-lg font-semibold text-center flex-grow cursor-pointer hover:text-accent-color transition-colors" title="Click to go up a level"></h3><button id="calendar-next-btn" class="p-2 rounded-full hover:bg-tertiary">&gt;</button></div><div class="flex justify-center mb-4"><div id="calendar-view-toggle" class="flex items-center bg-tertiary p-1 rounded-lg"><button data-view="day" class="calendar-view-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors">Day</button><button data-view="month" class="calendar-view-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors">Month</button><button data-view="year" class="calendar-view-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors">Year</button></div></div><div id="calendar-day-headers" class="grid grid-cols-7 gap-1 text-center text-xs text-text-secondary mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div><div id="calendar-body" class="grid gap-2"></div></div>
                        </div>
                    </div>
                </div>
            </div>
    </main>
    
    <!-- Modals and Overlays -->
    <div id="settings-menu-panel" class="fixed inset-y-0 right-0 w-80 bg-bg-secondary/95 backdrop-blur-md border-l border-border-color shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">
    
    <div class="flex items-center justify-between p-6 border-b border-border-color">
        <h2 class="text-lg font-bold text-text-primary">Settings</h2>
        <button id="close-settings-btn" class="text-text-secondary hover:text-text-primary transition-colors p-2 rounded-lg hover:bg-bg-tertiary">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
        
        <div class="space-y-4">
            <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider">Appearance</h3>
            
            <div class="bg-bg-tertiary/50 p-4 rounded-xl border border-border-color space-y-4">
                <div>
                    <label class="text-sm font-medium text-text-primary mb-2 block">Accent Color</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="accent-color-picker" class="h-10 w-14 bg-transparent cursor-pointer rounded overflow-hidden border-0 p-0" title="Choose Accent Color">
                        <span class="text-xs text-text-secondary">Pick a color to match your vibe.</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider">Analysis Configuration</h3>
            
            <div class="bg-bg-tertiary/50 p-4 rounded-xl border border-border-color space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-medium text-text-primary">Breakeven Threshold</label>
                        <span id="breakeven-value" class="text-xs font-mono bg-bg-primary px-2 py-1 rounded border border-border-color">$2.00</span>
                    </div>
                    <input type="range" id="breakeven-slider" min="0" max="50" step="0.5" class="w-full h-2 bg-bg-primary rounded-lg appearance-none cursor-pointer accent-accent-color">
                    <p class="text-[10px] text-text-secondary mt-2">Trades below this profit are considered "Breakeven".</p>
                </div>
            </div>
            
            <div class="bg-bg-tertiary/50 p-4 rounded-xl border border-border-color space-y-4">
                <div class="flex justify-between items-center">
                    <label class="text-sm font-medium text-text-primary">Pip Analysis Mode</label>
                    <button id="pip-analysis-settings-btn" class="text-xs text-accent-color hover:underline">Edit Rules</button>
                </div>
                
                <div id="pip-analysis-settings-panel" class="hidden space-y-3 pt-2 border-t border-border-color mt-2">
                    <div class="flex items-center gap-4 text-sm">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="pip-analysis-mode" value="strict" class="text-accent-color focus:ring-accent-color">
                            <span>Strict (Exact Price)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="pip-analysis-mode" value="flexible" checked class="text-accent-color focus:ring-accent-color">
                            <span>Flexible (Tolerance)</span>
                        </label>
                    </div>
                    <div id="pip-analysis-tolerance-container">
                        <div class="flex justify-between text-xs text-text-secondary mb-1">
                            <span>Tolerance %</span>
                            <span id="pip-analysis-tolerance-value">10</span>
                        </div>
                        <input type="range" id="pip-analysis-tolerance" min="1" max="20" value="10" class="w-full h-1 bg-bg-primary rounded-lg appearance-none cursor-pointer accent-accent-color">
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider">Data Management</h3>
            
            <div class="grid grid-cols-1 gap-3">
                <button id="save-data-btn" class="flex items-center justify-center gap-2 w-full p-3 bg-bg-tertiary hover:bg-bg-tertiary/80 border border-border-color rounded-xl text-sm font-semibold transition-all hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Save Changes to DB
                </button>
                
                <div class="grid grid-cols-2 gap-3">
                     <label class="flex flex-col items-center justify-center gap-1 p-3 bg-bg-tertiary hover:bg-bg-tertiary/80 border border-border-color rounded-xl text-sm font-semibold cursor-pointer transition-all hover:border-accent-color group">
                        <svg class="text-text-secondary group-hover:text-accent-color transition-colors" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        <span class="text-xs">Import JSON</span>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                    </label>
                    
                    <button id="export-btn" class="flex flex-col items-center justify-center gap-1 p-3 bg-bg-tertiary hover:bg-bg-tertiary/80 border border-border-color rounded-xl text-sm font-semibold transition-all hover:border-accent-color group">
                        <svg class="text-text-secondary group-hover:text-accent-color transition-colors" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <span class="text-xs">Export JSON</span>
                    </button>
                </div>

                <label class="flex items-center justify-center gap-2 w-full p-3 bg-blue-600/10 hover:bg-blue-600/20 border border-blue-600/30 text-blue-500 rounded-xl text-sm font-semibold cursor-pointer transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Import MT5 History
                    <input type="file" id="import-mt5-file" class="hidden" accept=".csv">
                </label>

                <button id="export-pdf-btn" class="flex items-center justify-center gap-2 w-full p-3 bg-red-600 hover:bg-red-700 text-white border border-transparent rounded-xl text-sm font-semibold shadow-lg shadow-red-600/20 transition-all hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Generate PDF Report
                </button>
            </div>
        </div>
    </div>
    
    <div class="p-4 border-t border-border-color bg-bg-tertiary/30 text-center">
        <p class="text-[10px] text-text-secondary">Prolific Journal v2.0  Local Storage Mode</p>
    </div>
</div>

<div id="settings-backdrop" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden transition-opacity duration-300 opacity-0"></div>

    <div id="accounts-modal" class="modal-overlay">
         <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-text-primary">Manage Accounts</h2>
                <button id="close-accounts-modal-btn" class="text-text-secondary hover:text-text-primary">&times;</button>
            </div>
            <div id="accounts-list" class="space-y-2 mb-4"></div>
            <div class="flex items-center gap-2">
                <input type="text" id="new-account-name" placeholder="New account name..." class="flex-1 p-2 form-input rounded-lg">
                <button id="add-account-btn" class="bg-accent-color text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-80">Add</button>
            </div>
        </div>
    </div>
    <div id="tags-modal" class="modal-overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-text-primary">Manage Strategy Tags</h2>
                <button id="close-tags-modal-btn" class="text-text-secondary hover:text-text-primary">&times;</button>
            </div>
            <div id="tags-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <div class="flex items-center gap-2">
                <input type="text" id="new-tag-name" placeholder="New tag name..." class="flex-1 p-2 form-input rounded-lg">
                <input type="color" id="new-tag-color" value="#8B5CF6" class="p-1 h-10 w-10 bg-tertiary rounded-lg cursor-pointer">
                <button id="add-tag-btn" class="bg-accent-color text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-80">Add</button>
            </div>
        </div>
    </div>
    <div id="psychology-tags-modal" class="modal-overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-text-primary">Manage Psychology Tags</h2>
                <button id="close-psychology-tags-modal-btn" class="text-text-secondary hover:text-text-primary">&times;</button>
            </div>
            <div id="psychology-tags-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <div class="flex items-center gap-2">
                <input type="text" id="new-psychology-tag-name" placeholder="New psychology tag..." class="flex-1 p-2 form-input rounded-lg">
                <input type="color" id="new-psychology-tag-color" value="#EC4899" class="p-1 h-10 w-10 bg-tertiary rounded-lg cursor-pointer">
                <button id="add-psychology-tag-btn" class="bg-accent-color text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-80">Add</button>
            </div>
        </div>
    </div>
    <div id="calendar-day-modal" class="modal-overlay">
        <div class="modal-content max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="calendar-day-title" class="text-xl font-semibold text-text-primary">Trades for...</h2>
                <button id="close-day-modal-btn" class="text-text-secondary hover:text-text-primary">&times;</button>
            </div>
            <div id="calendar-day-trades" class="overflow-y-auto"></div>
        </div>
    </div>
    <div id="toast-container"></div>
    <div id="loader-overlay" class="hidden loader-overlay">
        <div class="loader"></div>
    </div>

    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="custom-modal-title" class="text-lg font-bold text-text-primary mb-2"></h3>
            <p id="custom-modal-text" class="text-sm text-text-secondary mb-4"></p>
            <div id="custom-modal-input-container" class="hidden mb-4">
                <input type="text" id="custom-modal-input" class="form-input w-full p-2 rounded-lg">
            </div>
            <div class="flex justify-end gap-3">
                <button id="custom-modal-cancel-btn" class="btn bg-tertiary text-text-primary font-semibold py-2 px-4 rounded-lg hover:bg-border-color">Cancel</button>
                <button id="custom-modal-confirm-btn" class="btn bg-accent-color text-white font-semibold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>
     <div id="checklist-modal" class="modal-overlay">
    <div class="modal-content max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-text-primary">Manage Checklist Items</h2>
            <button id="close-checklist-modal-btn" class="text-text-secondary hover:text-text-primary">&times;</button>
        </div>
        <div id="checklist-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
        <div class="flex items-center gap-2">
            <input type="text" id="new-checklist-item-name" placeholder="e.g., R:R is at least 2:1" class="flex-1 p-2 form-input rounded-lg">
            <button id="add-checklist-item-btn" class="bg-accent-color text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-80">Add</button>
        </div>
    </div>
</div>


    <script type="module">
        // --- App State & Constants ---
        let appData = {
             activeAccountName: 'Default Account',
             accounts: {},
             settings: {}
        };
        let tradeType = 'Buy';
        let calendarDate = new Date();
        let calendarViewMode = 'day';
        let analyticsDrillDownFilter = null;
        let dailyPerfChart = null, hourlyPerfChart = null, mcChart = null, drawdownChart = null, riskConsistencyChart = null, equityCurveChart = null;
        
        // --- All DOM Element IDs used in the script ---
        const elementIds = [
            'sidebar', 'main-content', 'page-title', 
            'buy-btn', 'sell-btn', 'log-trade-btn', 'cancel-edit-btn', 'save-balance-btn', 'save-data-btn',
            'settings-menu-btn', 'settings-menu-panel', 'manage-accounts-btn', 'close-accounts-modal-btn', 'add-account-btn', 'account-switcher', 'close-day-modal-btn', 'export-btn', 'import-file',
            'export-pdf-btn', 'reset-filters-btn', 'run-mc-btn', 'trade-comments-editor', 'lot-size', 'entry-price',
            'exit-price', 'index-selector', 'starting-balance', 'num-positions', 'stop-loss', 'take-profit',
            'peak-price', 'fees', 'realtime-pl-display', 'form-title', 'editing-trade-id', 'num-positions-container',
            'tags-checklist', 'accounts-modal', 'tags-modal', 'calendar-day-modal',
            'manage-tags-btn', 'close-tags-modal-btn', 'add-tag-btn', 'new-tag-name', 'new-tag-color', 'tags-list',
            'manage-psychology-tags-btn', 'psychology-tags-modal', 'close-psychology-tags-modal-btn', 'add-psychology-tag-btn', 'new-psychology-tag-name', 'new-psychology-tag-color', 'psychology-tags-list', 'psychology-tags-checklist',
            'accounts-list', 'new-account-name', 'filter-instrument', 'filter-tag', 'filter-psychology-tag', 'filter-type', 'filter-outcome', 'filter-start-date', 'filter-end-date',
            'filter-status', 'journal-page', 'analytics-page', 'goals-page', 'playbook-page', 'trade-history-body', 'total-pl', 'win-rate',
            'realized-rr', 'total-trades', 'avg-profit', 'avg-loss', 'account-growth', 'current-balance',
            'profit-factor', 'expectancy', 'win-streak', 'loss-streak', 'recovery-factor', 
            'dailyPerformanceChart', 'hourlyPerformanceChart', 'tag-performance-body', 'psychology-performance-body',
            'index-performance-body', 'rr-analysis-body', 'calendar-body', 'calendar-month-year',
            'mcChart', 'mc-stats', 'reversal-analysis-body', 'calendar-day-title', 'calendar-day-trades',
            'mc-trades', 'mc-simulations', 'add-goal-form', 'add-goal-btn', 'goals-list', 'goal-title', 'goal-metric', 'goal-target', 'goal-timeframe',
            'drawdownChart', 'max-drawdown-usd', 'max-drawdown-pct', 'longest-drawdown-period', 'goal-form-title', 'editing-goal-id', 'cancel-goal-edit-btn',
            'play-form-title', 'editing-play-id', 'play-title', 'play-instruments', 'play-market-condition', 'play-entry-criteria', 'play-sl-rules', 'play-management-rules',
            'play-confidence-rating', 'play-review-notes', 'play-before-image', 'play-after-image', 'play-before-file', 'play-after-file',
            'save-play-btn', 'cancel-play-edit-btn', 'playbook-list', 'playbook-select', 'mae-price', 
            'avg-mae-winners', 'total-mae-winners', 'mae-comparison-bar',
            'avg-mfe-losers', 'total-mfe-losers', 'mfe-comparison-bar',
            'custom-modal-overlay', 'custom-modal-title', 'custom-modal-text', 'custom-modal-cancel-btn', 'custom-modal-confirm-btn', 'custom-modal-input-container', 'custom-modal-input',
            'accent-color-picker', 'sl-pips', 'tp-pips', 'riskConsistencyChart', 'rr-performance-body',
            'breakeven-slider', 'breakeven-value', 'avg-win-loss-comparison', 'trade-duration-performance-body', 'calendar-prev-btn', 
'calendar-next-btn', 
'calendar-title', 
'calendar-view-toggle', 
'calendar-day-headers',
'drilldown-status-bar',
'drilldown-filter-name',
'clear-drilldown-btn',
'pl-sparkline',
'winrate-donut',
'rr-barchart', 'avg-win-loss-bars', 'theme-toggle', 'manage-checklist-btn',
'trade-checklist',
'checklist-modal',
'close-checklist-modal-btn',
'checklist-list',
'new-checklist-item-name',
'add-checklist-item-btn', 'prolific-score', 'prolific-score-gauge', 'chart-page', 'tradingview-widget-container', 'adviser-panel', 'adviser-content', 'entry-timeframe', 'filter-timeframe', 'timeframe-performance-body', 'pip-analysis-body', 'pip-analysis-settings-btn', 'pip-analysis-settings-panel', 'pip-analysis-tolerance-container', 'pip-analysis-tolerance', 'pip-analysis-tolerance-value',  'risk-percentage', 'calculate-sl-from-risk-btn',

];
        
        const dom = {};

        // --- IndexedDB Setup ---
        const DB_NAME = 'ProlificJournalDB';
        const DB_VERSION = 1;
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error("Database error:", event.target.error);
                    reject("Database error");
                };

                request.onupgradeneeded = (event) => {
                    const dbInstance = event.target.result;
                    if (!dbInstance.objectStoreNames.contains('accounts')) {
                        dbInstance.createObjectStore('accounts', { keyPath: 'accountName' });
                    }
                    if (!dbInstance.objectStoreNames.contains('settings')) {
                         dbInstance.createObjectStore('settings', { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("Database opened successfully.");
                    resolve(db);
                };
            });
        }

        function saveData(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("DB not initialized"); return; }
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`Error saving to ${storeName}: ${event.target.error}`);
            });
        }

        function getData(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("DB not initialized"); return; }
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`Error getting from ${storeName}: ${event.target.error}`);
            });
        }
        
        function getAllData(storeName) {
             return new Promise((resolve, reject) => {
                if (!db) { reject("DB not initialized"); return; }
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`Error getting all from ${storeName}: ${event.target.error}`);
            });
        }
        
        function deleteData(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("DB not initialized"); return; }
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(`Error deleting from ${storeName}: ${event.target.error}`);
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            elementIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) dom[id] = el;
            });
            dom.sidebarLinks = document.querySelectorAll('nav .sidebar-link');

            setupEventListeners();
            await loadAppData(); // Now async
            populateAccountSwitcher();
            loadAccountDataIntoUI();
            populatePlaybookInstrumentsSelect();
            refreshUI();
            initializeTradingViewWidget();
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-fade-in-up');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.animate-fade-in-up').forEach(el => observer.observe(el));
            
            dom.sidebar.addEventListener('mouseenter', () => dom.sidebar.classList.add('group'));
            dom.sidebar.addEventListener('mouseleave', () => dom.sidebar.classList.remove('group'));
        // Initialize Tippy.js for all elements with the data-tippy-content attribute
tippy('[data-tippy-content]', {
  animation: 'scale-subtle',
  theme: 'light-border',
});
        });
        
       const getChartColors = () => {
            const isLightMode = document.documentElement.classList.contains('light');
            if (isLightMode) {
                return {
                    textColor: '#374151', // gray-700
                    gridColor: 'rgba(0, 0, 0, 0.05)',
                    tooltipBg: '#ffffff',
                    tooltipText: '#111827',
                    textSecondary: '#6b7280', // ADDED: Fixes tooltip visibility
                    gaugeBase: '#e5e7eb', // gray-200
                    donutBase: '#e5e7eb'  // gray-200
                };
            }
            // Return default dark mode colors
            return {
                textColor: '#d1d5db', // gray-300
                gridColor: 'rgba(255, 255, 255, 0.1)',
                tooltipBg: '#1f2937',
                tooltipText: '#f9fafb',
                textSecondary: '#a0a0a0', // ADDED: Improves consistency
                gaugeBase: '#374151', // gray-700
                donutBase: '#374151'  // gray-700
            };
        };
    // ====== REPLACE YOUR OLD SETTHEME FUNCTION WITH THIS ONE ======
const setTheme = (theme) => {
    const html = document.documentElement;
    if (theme === 'light') {
        html.classList.add('light');
        html.style.colorScheme = 'light';
        if (dom['theme-toggle']) dom['theme-toggle'].checked = true;
    } else {
        html.classList.remove('light');
        html.style.colorScheme = 'dark';
        if (dom['theme-toggle']) dom['theme-toggle'].checked = false;
    }

    // Redraw charts AND the TradingView widget to match the new theme
    if (typeof refreshUI === 'function') {
        refreshUI();
    }
    if (typeof initializeTradingViewWidget === 'function') {
        initializeTradingViewWidget();
    }
};

        // --- Data Management ---
       const loadAppData = async () => {
            await initDB();
            
            // One-time migration from localStorage
            const oldData = localStorage.getItem('prolificJournalData');
            if (oldData) {
                try {
                    console.log("Found old localStorage data, migrating...");
                    const parsedOldData = JSON.parse(oldData);
                    
                    // Migrate accounts
                    for (const accountName in parsedOldData.accounts) {
                        const accountData = parsedOldData.accounts[accountName];
                        await saveData('accounts', { accountName, ...accountData });
                    }
                    
                    // Migrate settings
                    if (parsedOldData.settings) {
                        await saveData('settings', { id: 'appSettings', ...parsedOldData.settings });
                    }
                    
                    // Store active account name
                    localStorage.setItem('activeAccountName', parsedOldData.activeAccountName);
                    
                    localStorage.removeItem('prolificJournalData');
                    showToast("Data successfully migrated to the new database!", "success");
                } catch (e) {
                    console.error("Migration failed:", e);
                    showToast("Could not migrate old data.", "error");
                }
            }
            
            // Load settings
            let settings = await getData('settings', 'appSettings');
            if (!settings) {
                settings = {
                    id: 'appSettings',
                    accentColor: '#4f46e5',
                    breakevenThreshold: 2.0,
                    calendarSummaryMode: 'monthly',
                    theme: 'dark',
                     pipAnalysisMode: 'flexible', 
                    pipAnalysisTolerance: 10, 
                };
                await saveData('settings', settings);
            }
             if (!settings.theme) 
                 settings.theme = 'dark';
            appData.settings = settings;
            
            // Load accounts
            const allAccounts = await getAllData('accounts');
            if (allAccounts.length === 0) {
                 const defaultAccount = {
                    accountName: 'Default Account',
                    trades: [],
                    startingBalance: null,
                    tags: [
                        { name: 'Strategy', color: '#8B5CF6' },
                        { name: 'Mistake', color: '#EF4444' },
                        { name: 'News Trade', color: '#F59E0B' }
                    ],
                    psychologyTags: [
                        { name: 'FOMO', color: '#EC4899' },
                        { name: 'Revenge Trading', color: '#F43F5E' },
                        { name: 'Overconfident', color: '#FCD34D' },
                        { name: 'Anxious', color: '#60A5FA' },
                    ],
                    goals: [],
                    playbook: [],
                    // --- START FIX: ADDED THE NEW DEFAULT CHECKLIST ---
                    checklist: [
                        'Two positions?',
                        'ATR SL',
                        'At least 1:1 RR'
                    ]
                    // --- END FIX ---
                };
                await saveData('accounts', defaultAccount);
                appData.accounts = { [defaultAccount.accountName]: defaultAccount };
            } else {
                 appData.accounts = allAccounts.reduce((acc, account) => {
                    acc[account.accountName] = account;
                    return acc;
                }, {});

                // Ensure all loaded accounts have a checklist array for backward compatibility
                Object.values(appData.accounts).forEach(account => {
                    if (!account.checklist) {
                        console.log(`Initializing default checklist for older account: ${account.accountName}`);
                        // --- START FIX: UPDATED THE CHECKLIST FOR OLDER ACCOUNTS ---
                        account.checklist = [
                            'Two positions?',
                            'ATR SL',
                            'At least 1:1 RR'
                        ];
                        // --- END FIX ---
                    }
                });
            }

            // Set active account
            const savedActiveAccount = localStorage.getItem('activeAccountName');
            if (savedActiveAccount && appData.accounts[savedActiveAccount]) {
                appData.activeAccountName = savedActiveAccount;
            } else {
                appData.activeAccountName = Object.keys(appData.accounts)[0];
                localStorage.setItem('activeAccountName', appData.activeAccountName);
            }

            applyAccentColor(appData.settings.accentColor);
            dom['breakeven-slider'].value = appData.settings.breakevenThreshold;
            dom['breakeven-value'].textContent = `$${parseFloat(appData.settings.breakevenThreshold).toFixed(2)}`;
            setTheme(appData.settings.theme);
        };

        const saveAppData = () => {
            const activeAccount = getActiveAccount();
            if (activeAccount) {
                saveData('accounts', activeAccount).catch(err => console.error("Failed to save account data:", err));
            }
            saveData('settings', appData.settings).catch(err => console.error("Failed to save settings:", err));
        };

       const getActiveAccount = () => {
            if (!appData.activeAccountName || !appData.accounts) return null;
            const account = appData.accounts[appData.activeAccountName];

            // --- START OF NEW APPROACH ---
            // This is the ultimate safety net. It ensures that any function
            // asking for the active account's data will NEVER fail because an
            // array is missing. It creates them if they don't exist.
            if (account) {
                if (!account.trades) account.trades = [];
                if (!account.tags) account.tags = [];
                if (!account.psychologyTags) account.psychologyTags = [];
                if (!account.goals) account.goals = [];
                if (!account.playbook) account.playbook = [];
                
                // The most critical check: If the checklist array is missing for any reason,
                // create a default one right now. This is more robust than the one-time
                // check in loadAppData.
                if (!Array.isArray(account.checklist)) {
                    console.warn(`Account "${account.accountName}" was missing a valid checklist. Initializing a default one.`);
                    account.checklist = [
                        'Setup is in my Playbook',
                        'Risk/Reward is at least 2:1',
                        'Trading during my session'
                    ];
                }
            }
            // --- END OF NEW APPROACH ---
            
            return account;
        };

        const getActiveTrades = () => {
            const account = getActiveAccount();
            return account ? account.trades : [];
        }

        const switchAccount = (accountName) => {
            if (appData.accounts[accountName]) {
                appData.activeAccountName = accountName;
                localStorage.setItem('activeAccountName', accountName); // Persist active account choice
                loadAccountDataIntoUI();
                refreshUI();
            }
        };

        const loadAccountDataIntoUI = () => {
            const account = getActiveAccount();
            if (account) {
                const balance = account.startingBalance;
                dom['starting-balance'].value = balance !== null ? balance : '';
            }
        };

        const populateAccountSwitcher = () => {
            const switcher = dom['account-switcher'];
            switcher.innerHTML = '';
            Object.keys(appData.accounts).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                switcher.appendChild(option);
            });
            switcher.value = appData.activeAccountName;
        };
        
        const populatePlaybookInstrumentsSelect = () => {
            const tradeInstrumentSelector = dom['index-selector'];
            const playbookInstrumentSelector = dom['play-instruments'];
            playbookInstrumentSelector.innerHTML = tradeInstrumentSelector.innerHTML;
        };

        // --- UI Feedback (Toast, Loader, Custom Modal) ---
        const showToast = (message, type = 'info', duration = 3000) => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span><div class="toast-progress" style="animation-duration: ${duration / 1000}s;"></div>`;
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        };
        const toggleLoader = (show) => document.getElementById('loader-overlay').classList.toggle('hidden', !show);

        const showCustomModal = ({ title, text, confirmText = 'Confirm', cancelText = 'Cancel', isPrompt = false, promptValue = '' }) => {
            return new Promise((resolve) => {
                dom['custom-modal-title'].textContent = title;
                dom['custom-modal-text'].textContent = text;
                dom['custom-modal-confirm-btn'].textContent = confirmText;
                dom['custom-modal-cancel-btn'].textContent = cancelText;

                dom['custom-modal-input-container'].classList.toggle('hidden', !isPrompt);
                dom['custom-modal-input'].value = promptValue;

                dom['custom-modal-overlay'].classList.add('open');

                const close = (value) => {
                    dom['custom-modal-overlay'].classList.remove('open');
                    dom['custom-modal-confirm-btn'].onclick = null;
                    dom['custom-modal-cancel-btn'].onclick = null;
                    resolve(value);
                };

                dom['custom-modal-confirm-btn'].onclick = () => {
                    close(isPrompt ? dom['custom-modal-input'].value : true);
                };
                dom['custom-modal-cancel-btn'].onclick = () => {
                    close(isPrompt ? null : false);
                };
            });
        };

        // PASTE THIS ENTIRE NEW FUNCTION
const handleCalculateSLFromRisk = () => {
    // 1. Get all necessary values from the form
    const riskPercent = parseFloat(dom['risk-percentage'].value);
    const currentBalanceText = dom['current-balance'].textContent.replace(/[^0-9.-]+/g, "");
    const currentBalance = parseFloat(currentBalanceText);
    const entryPrice = parseFloat(dom['entry-price'].value);
    const lotSize = parseFloat(dom['lot-size'].value);
    const instrument = dom['index-selector'].value;

    // 2. Validate the inputs
    if (isNaN(riskPercent) || riskPercent <= 0) {
        showToast("Please enter a valid Risk %.", "error");
        return;
    }
    if (isNaN(currentBalance) || currentBalance <= 0) {
        showToast("Cannot calculate risk without a Current Balance.", "error");
        return;
    }
    if (isNaN(entryPrice) || isNaN(lotSize)) {
        showToast("Entry Price and Lot Size must be set to calculate SL.", "error");
        return;
    }

    // 3. Calculate the risk amount in dollars
    const riskAmount = currentBalance * (riskPercent / 100);

    // 4. Determine the required price difference for that risk amount
    let priceDifference;
    if (instrument.includes('/')) { // Handle Forex
        priceDifference = riskAmount / (100000 * lotSize);
    } else { // Handle Deriv Assets, Indices, Gold, etc.
        priceDifference = riskAmount / lotSize;
    }
    
    // 5. Calculate the final Stop Loss price based on trade type
    let stopLossPrice;
    if (tradeType === 'Buy') {
        stopLossPrice = entryPrice - priceDifference;
    } else { // Sell
        stopLossPrice = entryPrice + priceDifference;
    }

    // 6. Update the UI with the results
    const decimalPlaces = (entryPrice.toString().split('.')[1] || '').length;
    dom['stop-loss'].value = stopLossPrice.toFixed(decimalPlaces);
    
    // Also update the pips box automatically for a great user experience
    calculatePipsFromPrice('sl'); 
    
    showToast(`Stop Loss set to ${stopLossPrice.toFixed(decimalPlaces)} for a $${riskAmount.toFixed(2)} risk.`, "success");
};
        const calculatePL = (type, lot, entry, exit, index) => {
    // 1. Safety checks
    if (exit === null || exit === undefined || isNaN(entry) || isNaN(exit) || isNaN(lot) || !index) {
        return { profit: null, movement: null };
    }
    
    // 2. Calculate raw price difference
    let diff = (type === 'Buy') ? exit - entry : entry - exit;
    let profit;

    // 3. Determine Profit based on Instrument Type
    if (index.includes('/')) {
        // Forex (Standard Lot = 100,000 units)
        profit = diff * 100000 * lot;
    } else if (index.startsWith('Volatility') || index.includes('Boom') || index.includes('Crash') || index.includes('Jump') || index.includes('Step') || index.includes('Range') || index.includes('DEX')) {
        // Deriv Indices (1 point = $1 per lot)
        profit = diff * lot;
    } else {
        // Metals/Crypto/Indices (Standard 1 point = $1 per lot approximation)
        profit = diff * lot;
    }

    // 4. Calculate Movement in Pips
    let movement = Math.abs(exit - entry);
    // FIX: Pass 'entry' to getPipMultiplier so it works for Volatility Indices
    const multiplier = getPipMultiplier(index, entry); 
    
    if (multiplier !== 0) {
        movement = movement / multiplier;
    }

    return { profit, movement };
}; 


const generateAdvancedInsights = (trade) => {
    const insights = [];
    let score = 5; // Start with a baseline 'C'

    // --- 1. CHECKLIST COMPLIANCE (Restored) ---
    const allChecklistItems = appData.settings.checklist || [];
    const totalRequired = allChecklistItems.length;
    if (totalRequired > 0) {
        const checkedCount = (trade.checklistMet || []).length;
        const compliancePct = (checkedCount / totalRequired) * 100;
        
        if (compliancePct === 100) {
            insights.push({ type: 'positive', text: `Discipline King: You followed 100% of your rules (${checkedCount}/${totalRequired}).` });
            score += 3;
        } else if (compliancePct < 50) {
            insights.push({ type: 'negative', text: `Rule Breaker: You only followed ${checkedCount}/${totalRequired} rules. Why take this trade?` });
            score -= 3;
        } else {
            insights.push({ type: 'warning', text: `Partial Discipline: You missed ${totalRequired - checkedCount} checklist items.` });
            score -= 1;
        }
    }

    // --- 2. R:R ANALYSIS (Restored) ---
    if (trade.rrRatio) {
        if (trade.rrRatio < 1 && trade.profitLoss > 0) {
            insights.push({ type: 'warning', text: `Poor R:R: You risked more than you planned to make (1:${trade.rrRatio}), but got lucky.` });
            score -= 1;
        } else if (trade.rrRatio >= 2) {
            insights.push({ type: 'positive', text: `Great Structure: You took a high potential trade (1:${trade.rrRatio}).` });
            score += 1;
        }
    }

    // --- 3. BASIC P/L ---
    if (trade.profitLoss > 0) {
        insights.push({ type: 'positive', text: `Result: Profitable (+$${trade.profitLoss.toFixed(2)})` });
        score += 1;
    } else {
        insights.push({ type: 'negative', text: `Result: Loss (-$${Math.abs(trade.profitLoss).toFixed(2)})` });
        // Don't penalize score too much for a loss if rules were followed!
    }

    // --- 4. "NEAR DEATH" (New Feature) ---
    if (trade.stopLoss && trade.maePrice) {
        const entry = trade.entryPrice;
        const slDist = Math.abs(entry - trade.stopLoss);
        const maeDist = Math.abs(entry - trade.maePrice);
        
        // If price went 85%+ of the way to SL but didn't hit it
        if (slDist > 0 && (maeDist / slDist) > 0.85 && trade.profitLoss > 0) {
            insights.push({ type: 'warning', text: `<b>Near Death:</b> Price missed your SL by just ${(slDist - maeDist).toFixed(2)} pts before winning.` });
            score -= 1; 
        }
    }

    // --- 5. EFFICIENCY (New Feature) ---
    if (trade.peakPrice && trade.profitLoss > 0) {
        const { profit: maxPotential } = calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.peakPrice, trade.indexName);
        
        if (maxPotential > 0) {
            const capturedPct = (trade.profitLoss / maxPotential) * 100;
            const leftOnTable = maxPotential - trade.profitLoss;

            if (capturedPct < 30) {
                insights.push({ type: 'warning', text: `<b>Paper Hands:</b> You captured only ${capturedPct.toFixed(1)}% of the move. Missed +$${leftOnTable.toFixed(2)}.` });
                score -= 1; 
            } else if (capturedPct > 85) {
                insights.push({ type: 'positive', text: `<b>Sniper Exit:</b> You captured ${capturedPct.toFixed(1)}% of the entire move!` });
                score += 2;
            }
        }
    }

    // --- 6. PSYCHOLOGY (Restored) ---
    if (trade.psychologyTags && trade.psychologyTags.length > 0) {
        const negativePsych = ['FOMO', 'Revenge', 'Greed', 'Hesitation', 'Tilted', 'Impulsive'];
        const hasNegative = trade.psychologyTags.some(tag => negativePsych.includes(tag));
        if (hasNegative) {
            insights.push({ type: 'negative', text: `Mindset Warning: Trade tagged with '${trade.psychologyTags.join(', ')}'.` });
            score -= 3;
        }
    }

    // --- GRADING ---
    // Cap score between 0 and 10
    score = Math.max(0, Math.min(10, score));

    let grade = 'C';
    if (score >= 9) grade = 'A+';
    else if (score >= 8) grade = 'A';
    else if (score >= 6) grade = 'B';
    else if (score >= 4) grade = 'C';
    else if (score >= 2) grade = 'D';
    else grade = 'F';

    return { grade, insights };
};
        // ADD THESE THREE NEW FUNCTIONS TO YOUR SCRIPT
const renderProlificScoreGauge = (score) => {
    const container = dom['prolific-score-gauge'];
    const colors = getChartColors();
    const percentage = score || 0;
    const circumference = 2 * Math.PI * 28;
    const strokeOffset = circumference - (percentage / 100) * circumference;

    let colorStop1 = '#ef4444'; let colorStop2 = '#b91c1c';
    if (percentage >= 75) { colorStop1 = '#4ade80'; colorStop2 = '#16a34a'; }
    else if (percentage >= 50) { colorStop1 = '#facc15'; colorStop2 = '#ca8a04'; }
    else if (percentage >= 25) { colorStop1 = '#fb923c'; colorStop2 = '#ea580c'; }

    container.innerHTML = `
        <svg viewBox="0 0 64 64" class="w-full h-full transform -rotate-90">
            <defs>
                <linearGradient id="pro-score-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:${colorStop1};" />
                    <stop offset="100%" style="stop-color:${colorStop2};" />
                </linearGradient>
            </defs>
            <circle stroke-width="8" stroke="${colors.gaugeBase}" fill="transparent" r="28" cx="32" cy="32"></circle>
            <circle class="pro-shadow"
                stroke-width="8"
                stroke-dasharray="${circumference}"
                stroke-dashoffset="${strokeOffset}"
                stroke-linecap="round"
                stroke="url(#pro-score-gradient)"
                fill="transparent"
                r="28" cx="32" cy="32"
                style="transition: stroke-dashoffset 0.8s cubic-bezier(0.25, 1, 0.5, 1);"
            ></circle>
            <text fill="${colors.textColor}" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" transform="rotate(90 32 32)">
                <tspan font-size="18" font-weight="800" fill="${colorStop1}">${Math.round(percentage)}</tspan>
                <tspan font-size="10" font-weight="600" fill="${colors.textColor}" dx="-2">%</tspan>
            </text>
        </svg>
    `;
};
const renderTotalPLSparkline = (trades) => {
    const container = dom['pl-sparkline'];
    const closedTrades = trades.filter(t => t.profitLoss !== null).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).slice(-30);
    if (closedTrades.length < 2) {
        container.innerHTML = '';
        return;
    }

    let cumulativePl = [0];
    closedTrades.forEach(t => cumulativePl.push(cumulativePl[cumulativePl.length - 1] + t.profitLoss));
    
    const max = Math.max(...cumulativePl);
    const min = Math.min(...cumulativePl);
    const range = max - min || 1;
    
    const width = 96;
    const height = 40;
    const points = cumulativePl.map((p, i) => {
        const x = (i / (cumulativePl.length - 1)) * width;
        const y = height - ((p - min) / range) * height;
        return `${x.toFixed(2)},${y.toFixed(2)}`;
    }).join(' ');
    
    const areaPoints = `${points} ${width},${height} 0,${height}`;
    const isWin = cumulativePl[cumulativePl.length - 1] >= cumulativePl[0];
    const color = isWin ? '#22c55e' : '#ef4444';
    const gradientId = isWin ? 'url(#pro-gradient-sparkline-win)' : 'url(#pro-gradient-sparkline-loss)';

    container.innerHTML = `
        <svg viewBox="0 0 ${width} ${height}" class="w-full h-full" preserveAspectRatio="none">
            <polygon points="${areaPoints}" fill="${gradientId}"/>
            <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pro-shadow"/>
        </svg>
    `;
};

const renderWinRateDonut = (winRate) => {
    const container = dom['winrate-donut'];
    const colors = getChartColors();
    const percentage = winRate || 0;
    const color = percentage >= 50 ? '#22c55e' : '#ef4444';
    
    container.style.background = `
        radial-gradient(${colors.donutBase} 55%, transparent 56%),
        conic-gradient(${color} 0% ${percentage}%, ${colors.gaugeBase} ${percentage}% 100%)
    `;
    container.style.borderRadius = '50%';
    container.classList.add('pro-shadow');
};

const renderRRBarChart = (avgWin, avgLoss) => {
    const container = dom['rr-barchart'];
    if (avgWin <= 0 || avgLoss <= 0) {
        container.innerHTML = '';
        return;
    }
    const maxVal = Math.max(avgWin, avgLoss);
    const winHeight = (avgWin / maxVal) * 100;
    const lossHeight = (avgLoss / maxVal) * 100;

    container.innerHTML = `
        <svg viewBox="0 0 48 40" class="w-full h-full">
            <rect x="5" y="${100 - winHeight}%" width="16" height="${winHeight}%" fill="url(#pro-gradient-green)" rx="4" class="pro-shadow"></rect>
            <rect x="27" y="${100 - lossHeight}%" width="16" height="${lossHeight}%" fill="url(#pro-gradient-red)" rx="4" class="pro-shadow"></rect>
        </svg>
    `;
};
const renderAvgWinLossBars = (avgWin, avgLoss) => {
    const container = dom['avg-win-loss-bars'];
    if (avgWin <= 0 && avgLoss <= 0) {
        container.innerHTML = '';
        return;
    }
    const maxVal = Math.max(avgWin, avgLoss);
    const winHeight = maxVal > 0 ? (avgWin / maxVal) * 100 : 0;
    const lossHeight = maxVal > 0 ? (avgLoss / maxVal) * 100 : 0;

    container.innerHTML = `
        <svg viewBox="0 0 48 40" class="w-full h-full">
            <rect x="5" y="${100 - winHeight}%" width="16" height="${winHeight}%" fill="url(#pro-gradient-green)" rx="4" class="pro-shadow"></rect>
            <rect x="27" y="${100 - lossHeight}%" width="16" height="${lossHeight}%" fill="url(#pro-gradient-red)" rx="4" class="pro-shadow"></rect>
        </svg>
    `;
};

        

// ====== REPLACE YOUR OLD `updateAdviser` FUNCTION WITH THIS ENTIRE "SUPER ADVANCED" VERSION ======

const updateAdviser = (allTrades) => {
    const content = dom['adviser-content'];
    content.innerHTML = ''; // Clear previous advice
    const closedTrades = allTrades.filter(t => t.profitLoss !== null);

    if (closedTrades.length < 20) { // Increased threshold for super advanced analysis
        content.innerHTML = '<p class="text-center text-text-secondary">Log at least 20 trades for the Super Advanced Adviser to generate its report.</p>';
        return;
    }

    const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

    // --- 1. GATHER ALL ANALYTICS & METRICS ---
    const metrics = {};
    const winningTrades = closedTrades.filter(t => t.profitLoss > breakevenThreshold);
    const losingTrades = closedTrades.filter(t => t.profitLoss <= 0);
    
    metrics.totalProfit = winningTrades.reduce((sum, t) => sum + t.profitLoss, 0);
    metrics.totalLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.profitLoss, 0));
    metrics.profitFactor = metrics.totalLoss > 0 ? metrics.totalProfit / metrics.totalLoss : Infinity;
    metrics.winRate = (winningTrades.length + losingTrades.length) > 0 ? (winningTrades.length / (winningTrades.length + losingTrades.length)) * 100 : 0;
    metrics.avgWin = winningTrades.length > 0 ? metrics.totalProfit / winningTrades.length : 0;
    metrics.avgLoss = losingTrades.length > 0 ? metrics.totalLoss / losingTrades.length : 0;
    metrics.realizedRR = metrics.avgLoss > 0 ? metrics.avgWin / metrics.avgLoss : 0;
    
    // Day of week performance
    metrics.dailyPerformance = { 'Sun': {pl:0, count:0}, 'Mon': {pl:0, count:0}, 'Tue': {pl:0, count:0}, 'Wed': {pl:0, count:0}, 'Thu': {pl:0, count:0}, 'Fri': {pl:0, count:0}, 'Sat': {pl:0, count:0} };
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    closedTrades.forEach(t => { const day = days[new Date(t.timestamp).getDay()]; metrics.dailyPerformance[day].pl += t.profitLoss; metrics.dailyPerformance[day].count++; });

    // Risk Consistency
    const riskTrades = closedTrades.filter(t => t.stopLoss !== null && !isNaN(t.stopLoss));
    const riskAmounts = riskTrades.map(t => Math.abs(calculatePL(t.tradeType, t.lotSize, t.entryPrice, t.stopLoss, t.indexName).profit || 0));
    if (riskAmounts.length > 1) {
        metrics.avgRisk = riskAmounts.reduce((a, b) => a + b, 0) / riskAmounts.length;
        const variance = riskAmounts.reduce((a, b) => a + Math.pow(b - metrics.avgRisk, 2), 0) / riskAmounts.length;
        metrics.riskStdDev = Math.sqrt(variance);
        metrics.riskConsistencyRatio = metrics.avgRisk > 0 ? metrics.riskStdDev / metrics.avgRisk : 0;
    } else { metrics.riskConsistencyRatio = 0; }
    
    // --- Checklist Adherence
const checklist = getActiveAccount()?.checklist || [];
metrics.nonCompliantTrades = [];
if (checklist.length > 0) {
    // CORRECTED LOGIC: A trade is non-compliant if not every master rule is found in the trade's checklist.
    metrics.nonCompliantTrades = closedTrades.filter(trade => {
        const checkedItems = trade.checklistMet || [];
        return !checklist.every(masterRule => checkedItems.includes(masterRule));
    });

    if (metrics.nonCompliantTrades.length > 0) {
        metrics.nonCompliantPL = metrics.nonCompliantTrades.reduce((sum, t) => sum + t.profitLoss, 0);
    }
}

    // Psychology
    const psychologyStats = {};
    closedTrades.forEach(trade => { (trade.psychologyTags || []).forEach(tag => { if (!psychologyStats[tag]) psychologyStats[tag] = { totalPL: 0, count: 0 }; psychologyStats[tag].totalPL += trade.profitLoss; psychologyStats[tag].count++; }); });
    metrics.topPsychologyLeak = Object.entries(psychologyStats).filter(([tag, data]) => data.count > 2 && data.totalPL < 0).sort((a, b) => a[1].totalPL - b[1].totalPL)[0];

    // MFE on Losers (Reversals)
    const reversedTrades = closedTrades.filter(t => t.profitLoss <= 0 && t.peakPrice && calculatePL(t.tradeType, t.lotSize, t.entryPrice, t.peakPrice, t.indexName).profit > breakevenThreshold);
    if (reversedTrades.length > 0) {
        metrics.slippedProfit = reversedTrades.reduce((sum, t) => sum + calculatePL(t.tradeType, t.lotSize, t.entryPrice, t.peakPrice, t.indexName).profit, 0);
        metrics.reversalRate = reversedTrades.length / closedTrades.length;
    }

    // Best Strategy
    const tagStats = closedTrades.reduce((acc, trade) => { (trade.tags || []).forEach(tag => { if (!acc[tag]) acc[tag] = { totalPL: 0, count: 0 }; acc[tag].totalPL += trade.profitLoss; acc[tag].count++; }); return acc; }, {});
    metrics.topStrategy = Object.entries(tagStats).filter(([tag, data]) => data.count > 3 && data.totalPL > 0).sort((a, b) => b[1].totalPL - a[1].totalPL)[0];

    // *** NEW LOGIC: Analyze Strategy Tag Pairs ***
    const tagPairStats = {};
    closedTrades.forEach(trade => {
        if (trade.tags && trade.tags.length >= 2) {
            const sortedTags = [...trade.tags].sort(); // Create a sorted copy
            for (let i = 0; i < sortedTags.length; i++) {
                for (let j = i + 1; j < sortedTags.length; j++) {
                    const pairKey = `${sortedTags[i]}|${sortedTags[j]}`; // Use a delimiter
                    if (!tagPairStats[pairKey]) {
                        tagPairStats[pairKey] = { totalPL: 0, count: 0 };
                    }
                    tagPairStats[pairKey].totalPL += trade.profitLoss;
                    tagPairStats[pairKey].count++;
                }
            }
        }
    });

    const MIN_PAIR_TRADES = 3; // Minimum trades for a pair to be considered significant
    const significantPairs = Object.entries(tagPairStats)
        .filter(([key, data]) => data.count >= MIN_PAIR_TRADES && data.totalPL > 0)
        .sort((a, b) => b[1].totalPL - a[1].totalPL);
    
    metrics.topTagPair = significantPairs.length > 0 ? significantPairs[0] : null;
    // *** END OF NEW LOGIC ***
    
    // Timeframe Performance
    const timeframeStats = closedTrades.reduce((acc, trade) => {
        if (trade.timeframe) {
            if (!acc[trade.timeframe]) acc[trade.timeframe] = { totalPL: 0, count: 0 };
            acc[trade.timeframe].totalPL += trade.profitLoss;
            acc[trade.timeframe].count++;
        }
        return acc;
    }, {});
    metrics.topTimeframe = Object.entries(timeframeStats).filter(([tf, data]) => data.count > 3 && data.totalPL > 0).sort((a, b) => b[1].totalPL - a[1].totalPL)[0];
    metrics.worstTimeframe = Object.entries(timeframeStats).filter(([tf, data]) => data.count > 3 && data.totalPL < 0).sort((a, b) => a[1].totalPL - b[1].totalPL)[0];
    
    // --- 2. DEFINE THE ADVANCED RULES ENGINE ---
    let strengths = [];
    let weaknesses = [];

    // --- STRENGTH IDENTIFICATION ---
    if (metrics.profitFactor >= 2) strengths.push({ score: 95, text: `Excellent Profitability (Profit Factor: ${metrics.profitFactor.toFixed(2)})` });
    if (metrics.realizedRR >= 2) strengths.push({ score: 90, text: `Superb Risk Management (Avg Win is ${metrics.realizedRR.toFixed(1)}x Avg Loss)` });
    // Add the new synergy check
    if (metrics.topTagPair) {
        const pairName = metrics.topTagPair[0].replace('|', ' & ');
        const pairData = metrics.topTagPair[1];
        strengths.push({ score: 88, text: `Powerful Tag Synergy ('${pairName}' combination is highly profitable, generating $${pairData.totalPL.toFixed(2)})` });
    }
    if (metrics.topStrategy) strengths.push({ score: 85, text: `High-Performing Strategy ('${metrics.topStrategy[0]}' has generated $${metrics.topStrategy[1].totalPL.toFixed(2)})` });
    if (metrics.topTimeframe) strengths.push({ score: 82, text: `High-Performing Timeframe ('${metrics.topTimeframe[0]}' has generated $${metrics.topTimeframe[1].totalPL.toFixed(2)})` });
    if (metrics.winRate > 65) strengths.push({ score: 80, text: `High Win Rate Accuracy (${metrics.winRate.toFixed(1)}%)` });


    // --- WEAKNESS IDENTIFICATION ---
    if (metrics.profitFactor < 1) weaknesses.push({ id: 'unprofitable', score: 100, impact: Math.abs(metrics.totalProfit + metrics.totalLoss), category: 'Profitability', title: "System is Unprofitable", description: `Your Profit Factor is ${metrics.profitFactor.toFixed(2)}. This is the most critical issue as your total losses currently outweigh your total profits.` });
    if (metrics.realizedRR < 1 && metrics.avgLoss > 0) weaknesses.push({ id: 'negativeRR', score: 90, impact: metrics.avgLoss - metrics.avgWin, category: 'Risk Management', title: "Negative Risk:Reward", description: `Your average loss ($${metrics.avgLoss.toFixed(2)}) is bigger than your average win ($${metrics.avgWin.toFixed(2)}), making long-term profitability very difficult.` });
    if (metrics.riskConsistencyRatio > 0.6) weaknesses.push({ id: 'badSizing', score: 85, impact: metrics.riskStdDev, category: 'Risk Management', title: "Inconsistent Position Sizing", description: `Your risk per trade is highly erratic. This makes your equity curve unpredictable and suggests emotional sizing.` });
    if (metrics.reversalRate > 0.20) weaknesses.push({ id: 'badExits', score: 80, impact: metrics.slippedProfit, category: 'Execution', title: "Poor Profit Taking", description: `You let ${Math.round(metrics.reversalRate*100)}% of trades reverse from winners to losers, costing you $${metrics.slippedProfit.toFixed(2)} in potential profit.` });
    if (metrics.nonCompliantPL < 0) weaknesses.push({ id: 'noDiscipline', score: 75, impact: Math.abs(metrics.nonCompliantPL), category: 'Discipline', title: "Lack of Discipline", description: `Breaking your own rules is expensive. Your non-compliant trades have cost you $${Math.abs(metrics.nonCompliantPL).toFixed(2)}.` });
    const worstDay = Object.entries(metrics.dailyPerformance).filter(([d, data]) => data.count > 4 && data.pl < 0).sort((a,b) => a[1].pl - b[1].pl)[0];
    if (worstDay) weaknesses.push({ id: 'badDay', score: 70, impact: Math.abs(worstDay[1].pl), category: 'Patterns', title: `Performance Leak on ${worstDay[0]}s`, description: `You have a clear negative pattern on ${worstDay[0]}s, with a cumulative loss of $${Math.abs(worstDay[1].pl).toFixed(2)}.` });
    if (metrics.topPsychologyLeak) weaknesses.push({ id: 'psychology', score: 65, impact: Math.abs(metrics.topPsychologyLeak[1].totalPL), category: 'Psychology', title: `Psychological Leak: '${metrics.topPsychologyLeak[0]}'`, description: `Trading while feeling '${metrics.topPsychologyLeak[0]}' is your most expensive emotional error.` });
    if (metrics.worstTimeframe) weaknesses.push({ id: 'badTimeframe', score: 68, impact: Math.abs(metrics.worstTimeframe[1].totalPL), category: 'Patterns', title: `Performance Leak on ${metrics.worstTimeframe[0]} Timeframe`, description: `You have a clear negative pattern on the ${metrics.worstTimeframe[0]} timeframe, with a cumulative loss of $${Math.abs(metrics.worstTimeframe[1].totalPL).toFixed(2)}.` });

    // --- 3. CORRELATE DATA FOR "TOXIC COMBOS" ---
    if(weaknesses.length > 0) {
        weaknesses.sort((a, b) => b.score - a.score);
        const topWeakness = weaknesses[0];
        let correlationDetail = '';

        if (topWeakness.id === 'noDiscipline' && metrics.topPsychologyLeak) {
            const nonCompliantWithLeak = metrics.nonCompliantTrades.filter(t => t.psychologyTags?.includes(metrics.topPsychologyLeak[0]));
            if (nonCompliantWithLeak.length / metrics.nonCompliantTrades.length > 0.4) {
                 correlationDetail = `A key finding is the link between your psychology and discipline. When you trade with '${metrics.topPsychologyLeak[0]}', you are significantly more likely to break your own rules.`;
            }
        }
        else if (topWeakness.id === 'negativeRR' && worstDay) {
            const losingTradesOnWorstDay = losingTrades.filter(t => days[new Date(t.timestamp).getDay()] === worstDay[0]);
            if(losingTradesOnWorstDay.length / losingTrades.length > 0.3) { // If >30% of losses occur on the worst day
                 correlationDetail = `This issue is most severe on <strong>${worstDay[0]}s</strong>. You tend to take bigger losses on this day, which drags down your entire average.`;
            }
        }
        else if(topWeakness.id === 'badSizing' && metrics.topPsychologyLeak) {
            const riskTradesWithLeak = riskTrades.filter(t => t.psychologyTags?.includes(metrics.topPsychologyLeak[0]));
            if (riskTradesWithLeak.length / riskTrades.length > 0.3) { // If >30% of trades with risk have the leak tag
                correlationDetail = `Your inconsistent sizing appears to be driven by emotion. Trades tagged with '${metrics.topPsychologyLeak[0]}' show the highest variance in position size.`;
            }
        }
        
        if (correlationDetail) {
            weaknesses[0].description += ` <br><strong>Correlation found:</strong> ${correlationDetail}`;
        }
    }


    // --- 4. GENERATE PERSONA & ACTION PLAN ---
    let persona = "You are a Developing Trader.";
    if (strengths.length > 2 && weaknesses.length < 2) persona = "You are a Consistent & Profitable Trader.";
    else if (metrics.realizedRR > 1.5 && metrics.winRate < 50) persona = "You are a Patient Trader with great risk management but could improve entry timing.";
    else if (metrics.winRate > 60 && metrics.realizedRR < 1.2) persona = "You are an Accurate Trader with precise entries, but need to work on maximizing profits.";
    else if (weaknesses.find(w => w.id === 'noDiscipline') || weaknesses.find(w => w.id === 'psychology')) persona = "You are an Emotional Trader whose psychology is the biggest barrier to profitability.";

    const actionPlan = {
        'unprofitable': ["1. **Stop Trading Live.** Go back to demo or paper trading immediately.", "2. **Focus on ONE setup** from your playbook. Master it.", "3. **Do not proceed** until you can achieve a Profit Factor > 1.2 over 50+ trades."],
        'negativeRR': ["1. **Mandatory R:R Check:** Before every trade, explicitly state your planned R:R. If it's below 1.5, reject the trade.", "2. **Review Your Top 5 Losses:** Find the exact point you should have exited. Was it a break of structure? A candle close? Define this as a hard exit rule.", "3. **Let Winners Run:** Trust your Take Profit. Use smaller position sizes if you feel fear about giving back profits."],
        'badSizing': ["1. **Use a Position Size Calculator:** This is non-negotiable. Use one for EVERY trade.", "2. **Define Fixed Risk:** Decide on a fixed % (e.g., 1%) or fixed dollar amount (e.g., $100) to risk per trade.", "3. **Lock It In:** Write this risk amount on a sticky note and put it on your monitor. Do not deviate."],
        'badExits': ["1. **Implement a Breakeven Rule:** Once a trade reaches 1R in profit, move your stop loss to your entry price. This is your #1 priority.", "2. **Partial Profits:** Consider taking 50% profit at 1.5R or 2R. This secures gains and makes it easier to hold for the final target.", "3. **Study Your MFE:** Review the 'Slipped P/L' metric in your analytics. This is money you are leaving on the table."],
        'noDiscipline': ["1. **Print Your Checklist:** Keep a physical copy on your desk. Touch each item before entering a trade.", "2. **Introduce a 'Cool-off' Period:** If you break a rule, you must stop trading for the rest of the day.", "3. **Accountability:** At the end of each day, write one sentence explaining why you followed or broke your rules."],
        'badDay': [`1. **Analyze All ${worstDay ? worstDay[0] : ''} Trades:** What do they have in common? Are you forcing setups? Is volume low?`, `2. **Cut Risk in Half:** For the next 4 weeks, trade with 50% of your normal size on ${worstDay ? worstDay[0] : ''}s.`, `3. **Consider Taking it Off:** If performance doesn't improve, use that day for review and study instead of live trading.`],
        'psychology': [`1. **Identify the Trigger:** Before each trade, pause and ask, "Am I feeling ${metrics.topPsychologyLeak ? metrics.topPsychologyLeak[0] : 'emotional'}?".`, `2. **Create a State-Change Routine:** If the answer is yes, you MUST step away. Walk, listen to music, stretch. Do not trade until you feel neutral.`, `3. **Journal the Emotion:** Write down *why* you felt that way. Was it after a loss? A big win? A news event? Finding the source is key.`],
       'badTimeframe': [
            `1. <strong>Analyze All Losing Trades</strong> on the ${metrics.worstTimeframe ? metrics.worstTimeframe[0] : ''} timeframe. Is the setup less clear? Are you forcing trades?`,
            `2. <strong>Impose a Rule:</strong> For the next 20 trades, either avoid this timeframe completely or reduce your position size by 75% when trading on it.`,
            `3. <strong>Compare to Your Best Timeframe:</strong> What are the key differences in market conditions or your own execution versus your most profitable timeframe?`
        ]
    };


    // --- 5. RENDER THE REPORT ---
    strengths.sort((a,b) => b.score - a.score);
    weaknesses.sort((a, b) => b.impact - a.impact); // Sort by financial impact!

    const topWeakness = weaknesses[0];

    const categoryIcons = {
        'Profitability': '', 'Risk Management': '', 'Execution': '', 'Discipline': '', 'Patterns': '', 'Psychology': ''
    };

    let html = `<div class="p-4 bg-tertiary/50 rounded-lg border border-border-color space-y-6">`;

    // Executive Summary
    html += `<div>
                <h3 class="text-xs font-semibold uppercase text-text-secondary tracking-wider">Executive Summary</h3>
                <p class="text-lg font-semibold text-accent-color mt-1">"${persona}"</p>
             </div>`;
    
    // Strengths
    if (strengths.length > 0) {
        html += `<div class="border-t border-border-color pt-4">
                    <h3 class="text-base font-bold text-green-400"> Key Strengths</h3>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-sm text-text-secondary">
                        ${strengths.slice(0,2).map(s => `<li>${s.text}</li>`).join('')}
                    </ul>
                </div>`;
    }

    // Weaknesses
    if (weaknesses.length > 0) {
        html += `<div class="border-t border-border-color pt-4">
                    <h3 class="text-base font-bold text-red-400"> Critical Growth Areas</h3>
                     <div class="space-y-3 mt-2">
                        ${weaknesses.slice(0,2).map(w => `
                            <div class="text-sm">
                                <p class="font-semibold text-text-primary">${categoryIcons[w.category] || ''} ${w.title}</p>
                                <p class="text-text-secondary text-xs pl-6">${w.description}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
    }

    // Action Plan
    if (topWeakness) {
        html += `<div class="border-t border-border-color pt-4">
                    <h3 class="text-base font-bold text-yellow-400"> Your #1 Action Plan: Fixing "${topWeakness.title}"</h3>
                    <ol class="list-decimal list-inside mt-2 space-y-2 text-sm text-text-secondary">
                         ${actionPlan[topWeakness.id] ? actionPlan[topWeakness.id].map(step => `<li>${step}</li>`).join('') : '<li>No specific action plan available. Focus on journaling this issue.</li>'}
                    </ol>
                </div>`;
    }
    html += updateRiskOptimizationEngine(closedTrades, breakevenThreshold);
    html += `</div>`;
    content.innerHTML = html;
};
        const calculateRR = (type, entry, sl, tp) => {
             if (!sl || !tp || isNaN(entry) || isNaN(sl) || isNaN(tp)) return null;
             const risk = Math.abs(entry - sl);
             const reward = Math.abs(tp - entry);
             if (risk === 0) return null;
             return reward / risk;
        };

        const formatDuration = (ms) => {
            if(ms < 0 || isNaN(ms)) return 'N/A';
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${seconds}s`;
            return `${seconds}s`;
        }
        
     // --- SHERLOCK VERSION: Prioritizes First Recorded SL ---
const parseMT5CSV = (csvText) => {
    const lines = csvText.trim().split('\n');
    const cleanLines = lines.map(l => l.replace('\r', ''));
    const headers = cleanLines[0].split(';'); 
    const deals = [];
    
    for(let i=1; i<cleanLines.length; i++) {
        if(!cleanLines[i].trim()) continue;
        const row = cleanLines[i].split(';');
        const deal = {};
        headers.forEach((h, index) => deal[h.trim()] = row[index] ? row[index].trim() : "");
        deals.push(deal);
    }
    
    const positions = {};
    deals.forEach(deal => {
        const pid = deal.PositionID;
        if(!pid) return;
        if(!positions[pid]) positions[pid] = [];
        positions[pid].push(deal);
    });
    
    const journalTrades = [];
    
    Object.values(positions).forEach(group => {
        const entryDeal = group.find(d => d.Entry === '0'); 
        const exitDeals = group.filter(d => d.Entry === '1'); 
        
        if(entryDeal && exitDeals.length > 0) {
            let totalProfit = 0;
            let totalCommission = 0;
            let totalSwap = 0;
            
            group.forEach(d => {
                totalCommission += parseFloat(d.Commission || 0);
                totalSwap += parseFloat(d.Swap || 0);
                totalProfit += parseFloat(d.Profit || 0);
            });

            const lastExit = exitDeals[exitDeals.length-1];

            // --- PRIORITY LOGIC FOR SL ---
            let finalSL = null;
            let finalTP = null;
            
            // Priority 1: The "Sherlock" SL (First SL ever detected in history)
            // This catches the SL you added 10 seconds after entry!
            if (lastExit.FirstRecordedSL && parseFloat(lastExit.FirstRecordedSL) > 0) {
                finalSL = parseFloat(lastExit.FirstRecordedSL);
            }
            // Priority 2: The Initial Entry SL (If you set it at the start)
            else if (entryDeal.InitialSL && parseFloat(entryDeal.InitialSL) > 0) {
                finalSL = parseFloat(entryDeal.InitialSL);
            }
            // Priority 3: The Exit Comment (Last resort)
            else {
                 const comment = lastExit.Comment || "";
                 const slMatch = comment.match(/sl\s+([\d.]+)/);
                 if (slMatch) finalSL = parseFloat(slMatch[1]);
            }

            // Standard TP Logic
            if (entryDeal.InitialTP && parseFloat(entryDeal.InitialTP) > 0) {
                finalTP = parseFloat(entryDeal.InitialTP);
            } else {
                 const comment = lastExit.Comment || "";
                 const tpMatch = comment.match(/tp\s+([\d.]+)/);
                 if (tpMatch) finalTP = parseFloat(tpMatch[1]);
            }

            // R:R Calculation
            let rrRatio = null;
            const entryPrice = parseFloat(entryDeal.Price);
            if (finalSL && finalTP && finalSL !== entryPrice) {
                const risk = Math.abs(entryPrice - finalSL);
                const reward = Math.abs(finalTP - entryPrice);
                rrRatio = parseFloat((reward / risk).toFixed(2));
            }

            // MFE / MAE Logic
            let highestPrice = parseFloat(lastExit.MaxPrice || 0);
            let lowestPrice = parseFloat(lastExit.MinPrice || 0);
            
            if (highestPrice === 0) highestPrice = Math.max(entryPrice, parseFloat(lastExit.Price));
            if (lowestPrice === 0) lowestPrice = Math.min(entryPrice, parseFloat(lastExit.Price));

            const isBuy = entryDeal.Type === '0';
            let peakPrice = isBuy ? highestPrice : lowestPrice;
            let maePrice = isBuy ? lowestPrice : highestPrice;

            const trade = {
                id: crypto.randomUUID(),
                mt5PositionId: entryDeal.PositionID,
                indexName: entryDeal.Symbol, 
                tradeType: isBuy ? 'Buy' : 'Sell',
                entryPrice: entryPrice,
                exitPrice: parseFloat(lastExit.Price),
                lotSize: parseFloat(entryDeal.Lots),
                timestamp: new Date(parseInt(entryDeal.Time) * 1000).toISOString(),
                exitTimestamp: new Date(parseInt(lastExit.Time) * 1000).toISOString(),
                profitLoss: totalProfit + totalCommission + totalSwap,
                stopLoss: finalSL, 
                takeProfit: finalTP, 
                rrRatio: rrRatio,
                peakPrice: peakPrice,
                maePrice: maePrice,
                notesHTML: `<p class="text-xs text-text-secondary">Imported from MT5 (Ticket: ${entryDeal.PositionID})</p>`,
                fees: totalCommission + totalSwap,
                tags: [],             
                psychologyTags: [],   
                checklistMet: [],     
                timeframe: null       
            };
            journalTrades.push(trade);
        }
    });
    return journalTrades;
};

        const handleMT5Import = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const csvText = e.target.result;
                    const newTrades = parseMT5CSV(csvText);
                    const activeAccount = getActiveAccount();
                    let addedCount = 0;

                    newTrades.forEach(trade => {
                        // Duplicate Check: Check by PositionID OR exact timestamp+symbol match
                        const isDuplicate = activeAccount.trades.some(t => 
                            (t.mt5PositionId && t.mt5PositionId === trade.mt5PositionId) || 
                            (t.timestamp === trade.timestamp && t.indexName === trade.indexName && t.entryPrice === trade.entryPrice)
                        );

                        if (!isDuplicate) {
                            activeAccount.trades.push(trade);
                            addedCount++;
                        }
                    });

                    if (addedCount > 0) {
                        await saveAppData();
                        refreshUI();
                        showToast(`Successfully imported ${addedCount} new trades!`, "success");
                    } else {
                        showToast("No new trades found. All trades were duplicates.", "info");
                    }
                } catch (err) {
                    console.error(err);
                    showToast("Error parsing CSV file.", "error");
                } finally {
                    event.target.value = ''; 
                }
            };
            reader.readAsText(file);
        };
        // --- END NEW CODE ---
         
        // --- Form & Edit Logic ---
        const resetForm = () => {
            const form = dom['log-trade-btn'].closest('div.space-y-4');
            form.querySelectorAll('input, select').forEach(el => {
                if(el.type !== 'checkbox' && el.type !== 'radio' && el.id !== 'num-positions' && el.id !== 'index-selector'  && el.id !== 'playbook-select' && el.id !== 'entry-timeframe' ) el.value = '';
            });

            // Uncheck all checklist, strategy, and psychology tags
            if (dom['trade-checklist']) {
                dom['trade-checklist'].querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
            if (dom['tags-checklist']) {
                dom['tags-checklist'].querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
            if (dom['psychology-tags-checklist']) {
                dom['psychology-tags-checklist'].querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }

            dom['num-positions'].value = '1';
            dom['trade-comments-editor'].innerHTML = '';
            dom['editing-trade-id'].value = '';
            dom['form-title'].textContent = 'Log New Trade';
            dom['log-trade-btn'].textContent = 'Log Trade';
            dom['cancel-edit-btn'].classList.add('hidden');
            dom['num-positions-container'].classList.remove('hidden');
            dom['realtime-pl-display'].innerHTML = '';
            dom['realtime-pl-display'].className = 'p-2 text-center rounded-lg h-10 transition-all';
            renderChecklists(); renderChecklistOnForm();
        };

        const enterEditMode = (tradeId) => {
            const tradeToEdit = getActiveTrades().find(t => t.id === tradeId);
            if (!tradeToEdit) return;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            dom['form-title'].textContent = 'Editing Trade';
            dom['log-trade-btn'].textContent = 'Save Changes';
            dom['cancel-edit-btn'].classList.remove('hidden');
            dom['editing-trade-id'].value = tradeToEdit.id;
            dom['index-selector'].value = tradeToEdit.indexName;
            dom['lot-size'].value = tradeToEdit.lotSize;
            dom['num-positions-container'].classList.add('hidden');
            dom['entry-price'].value = tradeToEdit.entryPrice;
            dom['exit-price'].value = tradeToEdit.exitPrice !== null ? tradeToEdit.exitPrice : '';
            dom['stop-loss'].value = tradeToEdit.stopLoss || '';
            dom['take-profit'].value = tradeToEdit.takeProfit || '';
           dom['calculate-sl-from-risk-btn'].addEventListener('click', handleCalculateSLFromRisk);
            calculatePipsFromPrice('sl');
            calculatePipsFromPrice('tp');
            dom['peak-price'].value = tradeToEdit.peakPrice !== null ? tradeToEdit.peakPrice : '';
            dom['mae-price'].value = tradeToEdit.maePrice !== null ? tradeToEdit.maePrice : '';
            dom['fees'].value = tradeToEdit.fees || '';
            dom['trade-comments-editor'].innerHTML = tradeToEdit.notesHTML || '';
            dom['playbook-select'].value = tradeToEdit.playId || '';
            dom['entry-timeframe'].value = tradeToEdit.timeframe || '15m'; // Default to 15m if not set
           setTradeTypeUI(tradeToEdit.tradeType);
            console.log('Editing trade, checklist data:', tradeToEdit.checklistMet);   
            renderChecklists(tradeToEdit.tags || [], tradeToEdit.psychologyTags || []);
            renderChecklistOnForm(tradeToEdit.checklistMet || []);
            updateRealtimePL();
        };
        
        const handleLogTrade = () => {
             const lotSize = parseFloat(dom['lot-size'].value);
             const entryPrice = parseFloat(dom['entry-price'].value);
             const numPositions = parseInt(dom['num-positions'].value) || 1;
             const exitPrice = dom['exit-price'].value.trim() === '' ? null : parseFloat(dom['exit-price'].value);
             const stopLoss = dom['stop-loss'].value.trim() === '' ? null : parseFloat(dom['stop-loss'].value);
             const takeProfit = dom['take-profit'].value.trim() === '' ? null : parseFloat(dom['take-profit'].value);
             const peakPrice = dom['peak-price'].value.trim() === '' ? null : parseFloat(dom['peak-price'].value);
             const maePrice = dom['mae-price'].value.trim() === '' ? null : parseFloat(dom['mae-price'].value);
             const fees = dom['fees'].value.trim() === '' ? 0 : parseFloat(dom['fees'].value);
             const notesHTML = dom['trade-comments-editor'].innerHTML.trim();
             const playId = dom['playbook-select'].value || null;
             const timeframe = dom['entry-timeframe'].value;

             const selectedTags = Array.from(dom['tags-checklist'].querySelectorAll('input:checked')).map(cb => cb.value);
             const selectedPsychologyTags = Array.from(dom['psychology-tags-checklist'].querySelectorAll('input:checked')).map(cb => cb.value);
              const checkedChecklistItems = Array.from(dom['trade-checklist'].querySelectorAll('input:checked')).map(cb => cb.value);
 console.log('Items checked on save:', checkedChecklistItems); 
             if (isNaN(lotSize) || isNaN(entryPrice) || lotSize <= 0) { showToast("Please enter a valid Lot Size and Entry Price.", "error"); return; }
             
             const editingId = dom['editing-trade-id'].value;
             const activeAccount = getActiveAccount();

             if (editingId) {
                  const tradeIndex = activeAccount.trades.findIndex(t => t.id === editingId);
                  if (tradeIndex > -1) {
                      const originalTrade = activeAccount.trades[tradeIndex];
                      let exitTimestamp = originalTrade.exitTimestamp;
                      if (originalTrade.exitPrice === null && exitPrice !== null) exitTimestamp = new Date().toISOString();
                      if (originalTrade.exitPrice !== null && exitPrice === null) exitTimestamp = null;
                      
                      let { profit: profitLoss, movement: pointsMoved } = calculatePL(tradeType, lotSize, entryPrice, exitPrice, dom['index-selector'].value);
                      if(profitLoss !== null) profitLoss -= fees;
                      const rrRatio = calculateRR(tradeType, entryPrice, stopLoss, takeProfit);
                      
                     // THIS IS THE CORRECTED LINE
activeAccount.trades[tradeIndex] = { ...originalTrade, indexName: dom['index-selector'].value, tradeType, lotSize, entryPrice, exitPrice, exitTimestamp, stopLoss, takeProfit, peakPrice, maePrice, fees, profitLoss, pointsMoved, rrRatio, tags: selectedTags, psychologyTags: selectedPsychologyTags, notesHTML, playId, checklistMet: checkedChecklistItems, timeframe };
                      showToast("Trade updated successfully!", "success");
                  }
             } else {
                   for (let i = 0; i < numPositions; i++) {
                       let { profit: profitLoss, movement: pointsMoved } = calculatePL(tradeType, lotSize, entryPrice, exitPrice, dom['index-selector'].value);
                       if(profitLoss !== null) profitLoss -= fees;
                       const rrRatio = calculateRR(tradeType, entryPrice, stopLoss, takeProfit);
                       
                       activeAccount.trades.push({
                           id: crypto.randomUUID(),
                           timestamp: new Date().toISOString(),
                           exitTimestamp: exitPrice !== null ? new Date().toISOString() : null,
                           indexName: dom['index-selector'].value, tradeType, lotSize, entryPrice, exitPrice, stopLoss, takeProfit, peakPrice, maePrice, fees, profitLoss, pointsMoved, rrRatio, tags: selectedTags, psychologyTags: selectedPsychologyTags, playId, notesHTML,  checklistMet: checkedChecklistItems, timeframe
                       });
                   }
                   showToast(`${numPositions} trade(s) logged successfully!`, "success");
             }
             saveAppData();
             refreshUI();
             resetForm();
        };
        
        const updateRealtimePL = () => {
            const display = dom['realtime-pl-display'];
            const lot = parseFloat(dom['lot-size'].value);
            const entry = parseFloat(dom['entry-price'].value);
            const exit = parseFloat(dom['exit-price'].value);
            const index = dom['index-selector'].value;

            const { profit } = calculatePL(tradeType, lot, entry, exit, index);

            if (profit === null) {
                display.innerHTML = '';
                display.className = 'p-2 text-center rounded-lg h-10 transition-all';
                return;
            }

            const plText = `P/L: $${profit.toFixed(2)}`;
            if (profit > 0) {
                display.className = 'p-2 text-center rounded-lg h-10 transition-all bg-green-900/50 text-green-400 font-semibold';
            } else if (profit < 0) {
                display.className = 'p-2 text-center rounded-lg h-10 transition-all bg-red-900/50 text-red-400 font-semibold';
            } else {
                display.className = 'p-2 text-center rounded-lg h-10 transition-all bg-gray-700 font-semibold';
            }
            display.innerHTML = plText;
        };

        // --- Event Listeners Setup ---
        const applyDrillDown = (filterType, filterValue) => {
    // This function sets the global filter variable
    analyticsDrillDownFilter = { type: filterType, value: filterValue };
    
    // Scroll to the top of the content area to see the status bar
    dom['main-content'].scrollTo({ top: 0, behavior: 'smooth' });
    
    // Refresh the UI to apply the new filter
    refreshUI();
};

const clearDrillDown = () => {
    // This function resets the filter to null
    analyticsDrillDownFilter = null;
    
    // Refresh the UI to show all data again
    refreshUI();
};
        // ADD THESE FOUR FUNCTIONS HERE

// REPLACE THE EMPTY FUNCTIONS WITH THIS COMPLETE BLOCK

const setupChecklistManager = () => {
    dom['manage-checklist-btn'].addEventListener('click', () => {
        renderChecklistList();
        dom['checklist-modal'].classList.add('open');
    });
    dom['close-checklist-modal-btn'].addEventListener('click', () => dom['checklist-modal'].classList.remove('open'));
    dom['add-checklist-item-btn'].addEventListener('click', () => {
        const newItem = dom['new-checklist-item-name'].value.trim();
        const activeAccount = getActiveAccount();
        if (newItem && !activeAccount.checklist.includes(newItem)) {
            activeAccount.checklist.push(newItem);
            saveAppData();
            renderChecklistList();
            renderChecklistOnForm();
            dom['new-checklist-item-name'].value = '';
        }
    });
};

const renderChecklistList = () => {
    const container = dom['checklist-list'];
    const checklist = getActiveAccount()?.checklist || [];
    container.innerHTML = '';
    checklist.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 bg-tertiary rounded-md';
        div.innerHTML = `<span class="font-semibold">${item}</span>
                         <button class="delete-checklist-item-btn p-1 text-text-secondary hover:text-red-500" data-index="${index}">&times;</button>`;
        container.appendChild(div);
    });

    container.querySelectorAll('.delete-checklist-item-btn').forEach(btn => btn.addEventListener('click', e => {
        const index = e.currentTarget.dataset.index;
        getActiveAccount().checklist.splice(index, 1);
        saveAppData();
        renderChecklistList();
        renderChecklistOnForm();
    }));
};

// PASTE THIS ENTIRE CORRECTED FUNCTION IN PLACE OF THE OLD ONE
const renderChecklistOnForm = (checkedItems) => {
    const container = dom['trade-checklist'];
    
    // --- START OF NEW APPROACH: Simplified & Safer State Preservation ---
    let itemsToKeepChecked;

    if (checkedItems !== undefined) {
        // We are editing a trade. Use the checked items passed from that trade.
        // `checkedItems` is guaranteed to be an array here (e.g., [] or ['item1']).
        itemsToKeepChecked = checkedItems;
    } else {
        // We are NOT editing. This is a general UI refresh (e.g., theme change).
        // Preserve whatever the user has already checked on the form.
        itemsToKeepChecked = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
    }
    // --- END OF NEW APPROACH ---

    const checklist = getActiveAccount()?.checklist || [];
    container.innerHTML = '';
    if (checklist.length === 0) {
        container.innerHTML = `<p class="text-xs text-center text-text-secondary">No checklist items. Click "Manage" to add some.</p>`;
        return;
    }

    checklist.forEach(item => {
        // This logic is now 100% safe because `itemsToKeepChecked` is always a valid array.
        const isChecked = itemsToKeepChecked.includes(item);
        const id = `checklist-${item.replace(/\s+/g, '-')}`;
        container.innerHTML += `
            <div class="flex items-center">
                <input type="checkbox" id="${id}" value="${item}" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-accent-color bg-tertiary border-border-color rounded focus:ring-accent-color ring-offset-bg-secondary focus:ring-2">
                <label for="${id}" class="ml-2 text-sm font-medium">${item}</label>
            </div>`;
    });
};

const updateChecklistAnalysis = (trades) => {
            const body = dom['checklist-analysis-body'];
            const checklist = getActiveAccount().checklist;
            body.innerHTML = '';

            if (!checklist || checklist.length === 0) {
                body.innerHTML = '<p class="text-center text-text-secondary col-span-full">No checklist rules found for this account. Click "Manage" on the main Journal page to add your rules and enable this analysis.</p>';
                return;
            }

            const analyzableTrades = trades.filter(t => t.profitLoss !== null && Array.isArray(t.checklistMet));

            if (analyzableTrades.length === 0) {
                body.innerHTML = '<p class="text-center text-text-secondary col-span-full">Log some closed trades with your checklist to see the analysis.</p>';
                return;
            }

            // --- START OF THE CORRECTED LOGIC ---
            // Instead of just comparing the number of items, we now check if every item
            // from the current master checklist is included in the trade's saved items.
            // This correctly handles cases where you add new rules to your master list later on.
            const compliantTrades = analyzableTrades.filter(trade => {
                return checklist.every(masterItem => trade.checklistMet.includes(masterItem));
            });
            
            // A non-compliant trade is simply one that isn't in the compliant list.
            const nonCompliantTrades = analyzableTrades.filter(trade => !compliantTrades.includes(trade));
            // --- END OF THE CORRECTED LOGIC ---

            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

            const calculateStats = (tradeSet) => {
                const totalPL = tradeSet.reduce((sum, t) => sum + t.profitLoss, 0);
                const wins = tradeSet.filter(t => t.profitLoss > breakevenThreshold).length;
                const winRate = tradeSet.length > 0 ? (wins / tradeSet.length) * 100 : 0;
                return { totalPL, winRate };
            };

            const compliantStats = calculateStats(compliantTrades);
            const nonCompliantStats = calculateStats(nonCompliantTrades);

            const itemAnalysis = checklist.reduce((acc, item) => {
                acc[item] = { skipped: 0, totalPL: 0 };
                return acc;
            }, {});

            nonCompliantTrades.forEach(trade => {
                const checkedItems = trade.checklistMet || [];
                // This part correctly finds which items from the CURRENT master list were skipped
                const skippedItems = checklist.filter(item => !checkedItems.includes(item));
                skippedItems.forEach(item => {
                    if (itemAnalysis[item]) {
                        itemAnalysis[item].skipped++;
                        itemAnalysis[item].totalPL += trade.profitLoss;
                    }
                });
            });
            
            const mostSkipped = Object.keys(itemAnalysis).length > 0 ? Object.entries(itemAnalysis).sort((a, b) => b[1].skipped - a[1].skipped)[0] : ["N/A", {skipped: 0}];
            const mostCostly = Object.keys(itemAnalysis).length > 0 ? Object.entries(itemAnalysis).sort((a, b) => a[1].totalPL - b[1].totalPL)[0] : ["N/A", {totalPL: 0}];
            const complianceRate = analyzableTrades.length > 0 ? (compliantTrades.length / analyzableTrades.length) * 100 : 0;

            body.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="bg-tertiary/50 p-4 rounded-lg border border-border-color">
                            <h3 class="font-semibold text-text-primary">Overall Compliance</h3>
                            <p class="text-3xl font-bold text-accent-color">${complianceRate.toFixed(1)}%</p>
                            <p class="text-xs text-text-secondary">${compliantTrades.length} of ${analyzableTrades.length} tracked trades followed all rules.</p>
                        </div>
                        <div class="bg-tertiary/50 p-4 rounded-lg border border-border-color">
                             <h3 class="font-semibold text-text-primary">Most Skipped Rule</h3>
                             <p class="text-sm font-bold text-yellow-400 mt-1">"${mostSkipped[0]}"</p>
                             <p class="text-xs text-text-secondary">Skipped on ${mostSkipped[1].skipped} non-compliant trades.</p>
                        </div>
                         <div class="bg-tertiary/50 p-4 rounded-lg border border-border-color">
                             <h3 class="font-semibold text-text-primary">Most Costly Skipped Rule</h3>
                             <p class="text-sm font-bold text-red-400 mt-1">"${mostCostly[0]}"</p>
                             <p class="text-xs text-text-secondary">Resulted in a P/L of <span class="font-semibold">$${mostCostly[1].totalPL.toFixed(2)}</span> when skipped.</p>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-tertiary/50 p-4 rounded-lg border border-border-color">
                        <h3 class="font-semibold text-text-primary mb-3">Financial Impact of Discipline</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <h4 class="font-semibold text-green-400">Compliant Trades (${compliantTrades.length})</h4>
                                    <div class="text-right">
                                         <p class="text-lg font-bold text-green-400">$${compliantStats.totalPL.toFixed(2)}</p>
                                         <p class="text-xs text-text-secondary">${compliantStats.winRate.toFixed(1)}% Win Rate</p>
                                    </div>
                                </div>
                            </div>
                             <div>
                                <div class="flex justify-between items-center mb-1">
                                    <h4 class="font-semibold text-red-400">Non-Compliant Trades (${nonCompliantTrades.length})</h4>
                                     <div class="text-right">
                                         <p class="text-lg font-bold text-red-400">$${nonCompliantStats.totalPL.toFixed(2)}</p>
                                         <p class="text-xs text-text-secondary">${nonCompliantStats.winRate.toFixed(1)}% Win Rate</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <hr class="border-border-color my-4">
                         <h3 class="font-semibold text-text-primary mb-3">Individual Rule Performance</h3>
                         <div class="space-y-2 text-xs">
                            ${Object.entries(itemAnalysis).map(([item, data]) => `
                                <div class="grid grid-cols-3 items-center gap-2">
                                    <span class="truncate text-text-secondary col-span-1" title="${item}">${item}</span>
                                    <div class="col-span-2 flex items-center gap-2">
                                        <div class="w-full bg-bg-tertiary rounded-full h-2.5">
                                            <div class="bg-red-500/50 h-2.5 rounded-full" style="width: ${nonCompliantTrades.length > 0 ? (data.skipped / nonCompliantTrades.length) * 100 : 0}%" title="${data.skipped} times skipped"></div>
                                        </div>
                                        <span class="font-mono w-20 text-right ${data.totalPL >= 0 ? 'text-green-500' : 'text-red-500'}">$${data.totalPL.toFixed(0)}</span>
                                    </div>
                                </div>
                            `).join('')}
                         </div>
                    </div>
                </div>
            `;
        };

const setupCollapsibleSections = () => {
        // Key for localStorage
        const storageKey = 'collapsibleStates';
        let states = JSON.parse(localStorage.getItem(storageKey)) || {};

        const collapsibleContainers = document.querySelectorAll('.collapsible-container');

        collapsibleContainers.forEach(container => {
            const header = container.querySelector('.collapsible-header');
            const content = container.querySelector('.collapsible-content');
            const id = container.id;

            // Apply saved state on load. If a state is not saved, default to closed.
            if (id && states[id] === true) {
                container.classList.add('open');
            }

            if (header && content) {
                header.addEventListener('click', () => {
                    const isOpen = container.classList.toggle('open');

                    // Save the new state
                    if (id) {
                        states[id] = isOpen;
                        localStorage.setItem(storageKey, JSON.stringify(states));
                    }
                });
            }
        });
    };
        // --- BULK EDIT LOGIC ---
let selectedTradeIds = new Set();

const toggleTradeSelection = (id) => {
    if (selectedTradeIds.has(id)) {
        selectedTradeIds.delete(id);
    } else {
        selectedTradeIds.add(id);
    }
    updateBulkActionBar();
    // Re-render only to update row styling (optional, but looks nice)
    renderTrades(applyFilters()); 
};

const toggleSelectAll = (checkbox) => {
    const visibleTrades = applyFilters(); // Only select what's visible
    if (checkbox.checked) {
        visibleTrades.forEach(t => selectedTradeIds.add(t.id));
    } else {
        selectedTradeIds.clear();
    }
    updateBulkActionBar();
    renderTrades(visibleTrades);
};

const deselectAllTrades = () => {
    selectedTradeIds.clear();
    const masterCb = document.getElementById('select-all-trades');
    if(masterCb) masterCb.checked = false;
    updateBulkActionBar();
    renderTrades(applyFilters());
};

const updateBulkActionBar = () => {
    const bar = document.getElementById('bulk-action-bar');
    const count = document.getElementById('bulk-count');
    
    if (selectedTradeIds.size > 0) {
        bar.classList.remove('hidden');
        bar.classList.add('flex');
        count.textContent = selectedTradeIds.size;
    } else {
        bar.classList.add('hidden');
        bar.classList.remove('flex');
    }
};

const openBulkEditModal = () => {
    const modal = document.getElementById('bulk-edit-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Populate Dropdowns with user's settings
    const strategySelect = document.getElementById('bulk-strategy');
    const psychologySelect = document.getElementById('bulk-psychology');
    const checklistContainer = document.getElementById('bulk-checklist-container');
    
    // Clear and Default
    strategySelect.innerHTML = '<option value="">(Do not change)</option>';
    psychologySelect.innerHTML = '<option value="">(Do not change)</option>';
    checklistContainer.innerHTML = '';
    
    // Fill Strategy
    (appData.settings.tags || []).forEach(tag => {
        strategySelect.innerHTML += `<option value="${tag.name}">${tag.name}</option>`;
    });
    
    // Fill Psychology
    (appData.settings.psychologyTags || []).forEach(tag => {
        psychologySelect.innerHTML += `<option value="${tag.name}">${tag.name}</option>`;
    });
    
    // Fill Checklist
    (appData.settings.checklist || []).forEach(item => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2';
        div.innerHTML = `
            <input type="checkbox" id="bulk-check-${item.id}" value="${item.text}" class="rounded border-border-color bg-bg-tertiary">
            <label for="bulk-check-${item.id}" class="text-sm text-text-secondary">${item.text}</label>
        `;
        checklistContainer.appendChild(div);
    });
};

const closeBulkEditModal = () => {
    document.getElementById('bulk-edit-modal').classList.add('hidden');
    document.getElementById('bulk-edit-modal').classList.remove('flex');
};
// --- DRAGGABLE LOGIC ---
const makeDraggable = (elmnt) => {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    if(!elmnt) return;

    elmnt.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e = e || window.event;
        // Don't drag if user clicks a button inside the bar
        if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
        
        e.preventDefault();
        
        // Get initial mouse position
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // CRITICAL: If this is the first move, convert CSS positioning to fixed pixels
        // This prevents the bar from "jumping" when we remove the centering classes
        if (elmnt.classList.contains('-translate-x-1/2')) {
            const rect = elmnt.getBoundingClientRect();
            
            // Remove the CSS centering classes
            elmnt.classList.remove('transform', '-translate-x-1/2', 'left-1/2', 'bottom-10');
            
            // Apply the exact current pixel position
            elmnt.style.left = rect.left + "px";
            elmnt.style.top = rect.top + "px";
            elmnt.style.position = 'fixed';
            elmnt.style.bottom = 'auto'; // clear bottom constraint
        }

        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        // Calculate new position
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // Set new position
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        // Stop moving when mouse button is released
        document.onmouseup = null;
        document.onmousemove = null;
    }
};

const applyBulkEdit = async () => {
    const activeAccount = getActiveAccount();
    const timeframe = document.getElementById('bulk-timeframe').value;
    const strategy = document.getElementById('bulk-strategy').value;
    const psychology = document.getElementById('bulk-psychology').value;
    
    // Get checked checklist items
    const checklistInputs = document.querySelectorAll('#bulk-checklist-container input:checked');
    const checklistToAdd = Array.from(checklistInputs).map(cb => cb.value);

    let updateCount = 0;

    activeAccount.trades.forEach(trade => {
        if (selectedTradeIds.has(trade.id)) {
            // Only update if value is not empty ("(Do not change)")
            if (timeframe) trade.timeframe = timeframe;
            
            // For tags, we overwrite if a new one is selected
            if (strategy) trade.tags = [strategy];
            if (psychology) trade.psychologyTags = [psychology];
            
           // For checklist, we merge new checks with existing ones
            if (checklistToAdd.length > 0) {
                const currentChecks = trade.checklistMet || []; // <--- Fixed: No space
                const merged = [...new Set([...currentChecks, ...checklistToAdd])]; // <--- Fixed: Matching name
                trade.checklistMet = merged;
            }
            updateCount++;
        }
    });

    await saveAppData();
    closeBulkEditModal();
    deselectAllTrades();
    refreshUI();
    showToast(`Successfully updated ${updateCount} trades!`, 'success');
};
        const setupEventListeners = () => {
           
            // Helper to clear inputs
            const clearPipAndPriceInputs = () => {
                ['stop-loss', 'sl-pips', 'take-profit', 'tp-pips'].forEach(id => dom[id].value = '');
            };

            // Analytics Page Tab Logic
const tabButtons = document.querySelectorAll('.analytics-tabs .tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
setupCollapsibleSections();

tabButtons.forEach(button => {
    button.addEventListener('click', () => {
        // 1. Switch Active Classes
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const tabId = button.dataset.tab + '-tab';
        tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
        
        // 2. FORCE REDRAW: If clicking "Risk & Execution", redraw the tracker
        if (button.dataset.tab === 'risk-execution') {
             setTimeout(() => {
                 const trades = applyFilters(); 
                 updateRiskConsistencyTracker(trades);
                 updateExcursionAnalysis(trades); // <--- ADD THIS LINE
             }, 50);
        }
    });
});
            setupChecklistManager();
dom['analytics-page'].addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('[data-excursion-toggle]');
                if (toggleBtn) {
                    const type = toggleBtn.dataset.excursionToggle; // 'mae' or 'mfe'
                    const usdEl = document.querySelector(`.${type}-value-usd`);
                    const pctEl = document.querySelector(`.${type}-value-pct`);
                    if (usdEl && pctEl) {
                        usdEl.classList.toggle('hidden');
                        pctEl.classList.toggle('hidden');
                    }
                }
                
                const link = e.target.closest('.drill-down-link');
                if (link) {
                    e.preventDefault();
                    applyDrillDown(link.dataset.filterType, link.dataset.filterValue);
                }
            });

            // --- Trade Type Buttons ---
            // --- Replace with this new block ---
dom['buy-btn'].addEventListener('click', () => {
    setTradeTypeUI('Buy');
    // Recalculate prices based on existing pip values
    calculatePriceFromPips('sl');
    calculatePriceFromPips('tp');
});
dom['sell-btn'].addEventListener('click', () => {
    setTradeTypeUI('Sell');
    // Recalculate prices based on existing pip values
    calculatePriceFromPips('sl');
    calculatePriceFromPips('tp');
});
            
            // --- Realtime P/L and Input Clearing ---
            ['lot-size', 'exit-price'].forEach(id => dom[id]?.addEventListener('input', updateRealtimePL));
            
           if (dom['entry-price']) {
    dom['entry-price'].addEventListener('input', () => {
        updateRealtimePL();
        // RECALCULATE SL/TP from pips instead of clearing them.
        // This is the core of the fix.
        calculatePriceFromPips('sl');
        calculatePriceFromPips('tp');
    });
}

if (dom['index-selector']) {
    dom['index-selector'].addEventListener('input', () => {
        updateRealtimePL();
        // Changing the instrument SHOULD clear the fields, as pip values change.
        clearPipAndPriceInputs();
    });
}

            // --- ADVANCED PIPS/PRICE EVENT LISTENERS ---
            dom['sl-pips'].addEventListener('input', () => calculatePriceFromPips('sl'));
            dom['tp-pips'].addEventListener('input', () => calculatePriceFromPips('tp'));
            dom['stop-loss'].addEventListener('input', () => calculatePipsFromPrice('sl'));
            dom['take-profit'].addEventListener('input', () => calculatePipsFromPrice('tp'));

            // --- Main Buttons ---
            // Add this line inside the setupEventListeners function
dom['calculate-sl-from-risk-btn'].addEventListener('click', handleCalculateSLFromRisk);
            dom['log-trade-btn'].addEventListener('click', handleLogTrade);
            dom['cancel-edit-btn'].addEventListener('click', resetForm);
            dom['save-balance-btn'].addEventListener('click', () => {
                const newBalance = parseFloat(dom['starting-balance'].value);
                if (isNaN(newBalance) || newBalance < 0) { showToast('Please enter a valid starting balance.', 'error'); return; }
                getActiveAccount().startingBalance = newBalance;
                saveAppData();
                refreshUI();
                showToast('Balance saved!', 'success');
            });
            dom['save-data-btn'].addEventListener('click', () => {
                saveAppData();
                showToast("Data saved successfully!", "success");
            });
            
            // --- Sidebar and Page Navigation ---
            dom.sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    dom.sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const pageTitles = {
                        journal: { title: 'Journal', subtitle: 'Log and review your trading performance.' },
                        playbook: { title: 'Playbook', subtitle: 'Document and analyze your trading setups.' },
                        goals: { title: 'Goals', subtitle: 'Set and track your trading objectives.' },
                        analytics: { title: 'Analytics', subtitle: 'Deep dive into your trading data.' },
                        chart: { title: 'TradingView Chart', subtitle: 'Live market analysis and charting.' }
                    };
                    dom['page-title'].textContent = pageTitles[page].title;
                    dom['page-title'].nextElementSibling.textContent = pageTitles[page].subtitle;
                    ['journal-page', 'analytics-page', 'goals-page', 'playbook-page', 'chart-page'].forEach(p => {
                        dom[p].classList.toggle('hidden', p !== `${page}-page`);
                    });
                    refreshUI();
                });
            });
            
            // --- Settings Panel (Slide-Over) ---
            const settingsMenuBtn = dom['settings-menu-btn'];
            const settingsMenuPanel = dom['settings-menu-panel'];
            const settingsBackdrop = document.getElementById('settings-backdrop');
            const closeSettingsBtn = document.getElementById('close-settings-btn');

            const openSettings = () => {
                // Show backdrop
                settingsBackdrop.classList.remove('hidden');
                // Small delay to allow transition to render
                setTimeout(() => settingsBackdrop.classList.remove('opacity-0'), 10);
                
                // Slide in panel
                settingsMenuPanel.classList.remove('translate-x-full');
            };

            const closeSettings = () => {
                // Slide out panel
                settingsMenuPanel.classList.add('translate-x-full');
                
                // Fade out backdrop
                settingsBackdrop.classList.add('opacity-0');
                
                // Hide backdrop after animation finishes
                setTimeout(() => {
                    settingsBackdrop.classList.add('hidden');
                }, 300);
            };

            settingsMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openSettings();
            });

            closeSettingsBtn.addEventListener('click', closeSettings);
            settingsBackdrop.addEventListener('click', closeSettings);
            
            // Pip Analysis Settings Toggle logic (Keep existing logic if any, or add this)
            const pipSettingsBtn = document.getElementById('pip-analysis-settings-btn');
            const pipSettingsPanel = document.getElementById('pip-analysis-settings-panel');
            
            if(pipSettingsBtn && pipSettingsPanel) {
                pipSettingsBtn.addEventListener('click', () => {
                   const isHidden = pipSettingsPanel.classList.contains('hidden');
                   pipSettingsPanel.classList.toggle('hidden');
                   pipSettingsBtn.textContent = isHidden ? 'Hide Rules' : 'Edit Rules';
                });
            }

            // Radio & Slider logic for Pip Analysis
            document.querySelectorAll('input[name="pip-analysis-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    appData.settings.pipAnalysisMode = e.target.value;
                    dom['pip-analysis-tolerance-container'].classList.toggle('hidden', e.target.value !== 'flexible');
                    saveAppData();
                    if(typeof updatePipAnalysis === 'function') updatePipAnalysis(applyFilters());
                });
            });

            const pipToleranceSlider = document.getElementById('pip-analysis-tolerance');
            if(pipToleranceSlider) {
                pipToleranceSlider.addEventListener('input', (e) => {
                    const val = parseInt(e.target.value);
                    document.getElementById('pip-analysis-tolerance-value').textContent = val;
                    appData.settings.pipAnalysisTolerance = val;
                    saveAppData();
                     if(typeof updatePipAnalysis === 'function') updatePipAnalysis(applyFilters());
                });
            }
            
            // --- Analytics & Tools ---
            dom['run-mc-btn'].addEventListener('click', runMonteCarlo);
            const editor = dom['trade-comments-editor'];
            editor.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); editor.classList.add('dragover'); });
            editor.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); editor.classList.remove('dragover'); });
            editor.addEventListener('drop', handleImageDrop);
            editor.addEventListener('paste', handleImagePaste);

            // --- Goals & Playbook ---
            dom['add-goal-btn'].addEventListener('click', handleSaveGoal);
            dom['cancel-goal-edit-btn'].addEventListener('click', resetGoalForm);
            dom['save-play-btn'].addEventListener('click', handleSavePlay);
            dom['cancel-play-edit-btn'].addEventListener('click', resetPlayForm);
            setupImageDropzone('play-before-image', 'play-before-file');
            setupImageDropzone('play-after-image', 'play-after-file');

            // --- Settings ---
            dom['accent-color-picker'].addEventListener('input', (e) => {
                const newColor = e.target.value;
                appData.settings.accentColor = newColor;
                applyAccentColor(newColor);
                saveAppData();
            });
            dom['breakeven-slider'].addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                appData.settings.breakevenThreshold = value;
                dom['breakeven-value'].textContent = `$${value.toFixed(2)}`;
                saveAppData();
                refreshUI();
            });
            dom['theme-toggle'].addEventListener('change', (e) => {
                const newTheme = e.target.checked ? 'light' : 'dark';
                appData.settings.theme = newTheme;
                setTheme(newTheme);
                saveAppData();
            });
            
            // --- Calendar ---
            dom['close-day-modal-btn'].addEventListener('click', () => dom['calendar-day-modal'].classList.remove('open'));
            dom['calendar-prev-btn'].addEventListener('click', () => {
                if (calendarViewMode === 'day') calendarDate.setMonth(calendarDate.getMonth() - 1);
                else if (calendarViewMode === 'month') calendarDate.setFullYear(calendarDate.getFullYear() - 1);
                else if (calendarViewMode === 'year') calendarDate.setFullYear(calendarDate.getFullYear() - 10);
                updateTradeCalendar();
            });
            dom['calendar-next-btn'].addEventListener('click', () => {
                if (calendarViewMode === 'day') calendarDate.setMonth(calendarDate.getMonth() + 1);
                else if (calendarViewMode === 'month') calendarDate.setFullYear(calendarDate.getFullYear() + 1);
                else if (calendarViewMode === 'year') calendarDate.setFullYear(calendarDate.getFullYear() + 10);
                updateTradeCalendar();
            });
            dom['calendar-title'].addEventListener('click', () => {
                if (calendarViewMode === 'day') calendarViewMode = 'month';
                else if (calendarViewMode === 'month') calendarViewMode = 'year';
                updateTradeCalendar();
            });
            dom['calendar-view-toggle'].addEventListener('click', (e) => {
                if (e.target.matches('.calendar-view-btn')) {
                    calendarViewMode = e.target.dataset.view;
                    updateTradeCalendar();
                }
            });

            // --- Tag Management ---
            setupTagManager('tags', dom['tags-modal'], dom['manage-tags-btn'], dom['close-tags-modal-btn'], dom['add-tag-btn'], dom['new-tag-name'], dom['new-tag-color'], dom['tags-list']);
            setupTagManager('psychologyTags', dom['psychology-tags-modal'], dom['manage-psychology-tags-btn'], dom['close-psychology-tags-modal-btn'], dom['add-psychology-tag-btn'], dom['new-psychology-tag-name'], dom['new-psychology-tag-color'], dom['psychology-tags-list']);
            
            // --- Drill-Down & Trade History Actions ---
            dom['clear-drilldown-btn'].addEventListener('click', clearDrillDown);
            dom['analytics-page'].addEventListener('click', (e) => {
                const link = e.target.closest('.drill-down-link');
                if (link) {
                    e.preventDefault();
                    applyDrillDown(link.dataset.filterType, link.dataset.filterValue);
                }
            });
            dom['trade-history-body'].addEventListener('click', async (e) => {
                const detailsBtn = e.target.closest('.details-btn');
                if (detailsBtn) detailsBtn.closest('tr').nextElementSibling.classList.toggle('open');
                
                const editBtn = e.target.closest('.edit-trade-btn');
                if (editBtn) enterEditMode(editBtn.dataset.id);

                const deleteBtn = e.target.closest('.delete-trade-btn');
                if (deleteBtn) {
                    const confirmed = await showCustomModal({
                        title: 'Delete Trade',
                        text: 'Are you sure you want to delete this trade? This action cannot be undone.',
                        confirmText: 'Delete',
                    });
                    if (confirmed) {
                        const activeAccount = getActiveAccount();
                        const tradeIndex = activeAccount.trades.findIndex(t => t.id === deleteBtn.dataset.id);
                        if(tradeIndex > -1) {
                            activeAccount.trades.splice(tradeIndex, 1);
                            saveAppData();
                            refreshUI();
                            showToast("Trade deleted", "info");
                        }
                    }
                }
                const toggleBtn = e.target.closest('.toggle-review-btn');
                if (toggleBtn) {
                    const grid = toggleBtn.closest('.trade-details-grid');
                    grid?.classList.toggle('review-collapsed');
                    const isCollapsed = grid.classList.contains('review-collapsed');
                    toggleBtn.title = isCollapsed ? 'Show Review Panel' : 'Hide Review Panel';
                    toggleBtn.innerHTML = isCollapsed ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
                }
            });
        }; 
        
        const handleImageDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const editor = dom['trade-comments-editor'];
            editor.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        editor.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        };

        const handleImagePaste = (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                         document.execCommand('insertHTML', false, `<img src="${e.target.result}" style="max-width: 100%; border-radius: 0.5rem; margin: 1rem 0;">`);
                    };
                    reader.readAsDataURL(file);
                    e.preventDefault();
                    break;
                }
            }
        };

       // --- FIXED: Safe Deep Dive Renderer ---
const renderDeepDiveSafe = (trades) => {
    // Helper: Safely group trades
    const safeGroupBy = (trades, prop) => {
        const groups = {};
        trades.forEach(t => {
            let val = t[prop];
            
            // Handle missing/empty data gracefully
            if (val === undefined || val === null || val === "") {
                val = "Unspecified";
            }
            
            // Handle Arrays (Tags/Psychology) vs Strings (Timeframe/Index)
            const keys = Array.isArray(val) ? (val.length ? val : ["Unspecified"]) : [val];
            
            keys.forEach(k => {
                if (!groups[k]) groups[k] = [];
                groups[k].push(t);
            });
        });
        return groups;
    };

    // Helper: Generate Card HTML
    const createCard = (title, subset) => {
        const wins = subset.filter(t => t.profitLoss > 0).length;
        const total = subset.length;
        const winRate = total > 0 ? (wins / total) * 100 : 0;
        const netPnL = subset.reduce((sum, t) => sum + t.profitLoss, 0);
        
        // Safe Profit Factor Calc
        const grossProfit = subset.filter(t => t.profitLoss > 0).reduce((s, t) => s + t.profitLoss, 0);
        const grossLoss = Math.abs(subset.filter(t => t.profitLoss < 0).reduce((s, t) => s + t.profitLoss, 0));
        const profitFactor = grossLoss === 0 ? (grossProfit > 0 ? "" : "0.00") : (grossProfit / grossLoss).toFixed(2);

        const pnlClass = netPnL >= 0 ? 'text-green-400' : 'text-red-400';
        const winRateColor = winRate >= 50 ? 'text-green-400' : (winRate >= 30 ? 'text-yellow-400' : 'text-red-400');
        
        // Visual cue for Unspecified cards
        const cardBorder = title === "Unspecified" ? "border-dashed border-gray-600 opacity-70" : "border-border-color";

        return `
            <div class="bg-bg-secondary p-4 rounded-lg border ${cardBorder}">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-semibold text-sm text-text-primary truncate" title="${title}">${title}</h4>
                    <span class="text-xs font-mono text-text-secondary">${total} trades</span>
                </div>
                <div class="grid grid-cols-2 gap-y-2 text-sm">
                    <div class="text-text-secondary">Win Rate</div>
                    <div class="text-right font-bold ${winRateColor}">${winRate.toFixed(1)}%</div>
                    
                    <div class="text-text-secondary">Net P&L</div>
                    <div class="text-right font-bold ${pnlClass}">$${netPnL.toFixed(2)}</div>
                    
                    <div class="text-text-secondary">Profit Factor</div>
                    <div class="text-right font-mono">${profitFactor}</div>
                </div>
            </div>
        `;
    };

    // --- CONFIGURATION: Map HTML IDs to correct Data Properties ---
    const sections = [
        { id: 'index-performance-body', prop: 'indexName' },       // Automatic
        { id: 'tag-performance-body', prop: 'tags' },              // Manual
        { id: 'psychology-performance-body', prop: 'psychologyTags' }, // Manual
        { id: 'timeframe-performance-body', prop: 'timeframe' }    // Manual (Correct property name now)
    ];

    sections.forEach(section => {
        const container = document.getElementById(section.id);
        if (!container) return;

        const groups = safeGroupBy(trades, section.prop);
        
        // Sort keys: Unspecified always last, others alphabetical
        const sortedKeys = Object.keys(groups).sort((a, b) => {
            if(a === 'Unspecified') return 1;
            if(b === 'Unspecified') return -1;
            return a.localeCompare(b);
        });

        container.innerHTML = sortedKeys.map(key => createCard(key, groups[key])).join('');
        
        if (sortedKeys.length === 0) {
            container.innerHTML = `<p class="text-text-secondary text-sm col-span-full text-center py-4">No data available.</p>`;
        }
    });
};
        // --- UI Rendering ---
        const refreshUI = () => {
            const filteredTrades = applyFilters();
            const allTrades = getActiveTrades();
            
            renderTrades(filteredTrades);
            renderChecklists();
            updateFilterDropdowns();
            populatePlaybookSelect();
            renderChecklistOnForm();    
        
            updateSummary(filteredTrades);
            updateAccountGrowth(allTrades);
            
            
          
// PASTE THIS CORRECTED BLOCK IN ITS PLACE

if (!dom['analytics-page'].classList.contains('hidden')) {
      let tradesForAnalytics = applyFilters(); 

    if (analyticsDrillDownFilter) {
        tradesForAnalytics = tradesForAnalytics.filter(trade => {
            const tradeValue = trade[analyticsDrillDownFilter.type];
            if (Array.isArray(tradeValue)) {
                return tradeValue.includes(analyticsDrillDownFilter.value);
            }
            return tradeValue === analyticsDrillDownFilter.value;
        });

        dom['drilldown-status-bar'].classList.remove('hidden');
        dom['drilldown-status-bar'].classList.add('flex');
        dom['drilldown-filter-name'].textContent = analyticsDrillDownFilter.value;
    } else {
        dom['drilldown-status-bar'].classList.add('hidden');
        dom['drilldown-status-bar'].classList.remove('flex');
    }
    updateAdviser(tradesForAnalytics);

    setTimeout(() => {
        if (!dom['analytics-page'].classList.contains('hidden')) {
            // updateEquityCurveChart(tradesForAnalytics); // Commented out until we build it
            const { maxDrawdownUSD } = updateDrawdownAnalysis(tradesForAnalytics);
            updateEquityCurveChart(tradesForAnalytics);
            updateAdvancedAnalytics(tradesForAnalytics, maxDrawdownUSD);
            renderDeepDiveSafe(tradesForAnalytics);
            updateRRAnalysis(tradesForAnalytics);
            updateRRPerformanceAnalysis(tradesForAnalytics);
            updateTradeCalendar(); 
            updateReversalAnalysis(tradesForAnalytics);
            updateExcursionAnalysis(tradesForAnalytics);
            updateRiskConsistencyTracker(tradesForAnalytics);
            updateAvgWinLossComparison(tradesForAnalytics);
            updatePipAnalysis(tradesForAnalytics);
        }
    }, 0);
}
            if (!dom['goals-page'].classList.contains('hidden')) {
                updateGoals();
            }

            if (!dom['playbook-page'].classList.contains('hidden')) {
                updatePlaybook();
            }
        };

        const renderTrades = (tradesToRender) => {
    const tradeHistoryBody = dom['trade-history-body'];
    tradeHistoryBody.innerHTML = '';
    if (tradesToRender.length === 0) { 
        tradeHistoryBody.innerHTML = `<tr><td colspan="5" class="text-center text-text-secondary py-8">No trades match the current filters.</td></tr>`; 
        return;
    }
    
    const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

    const fragment = document.createDocumentFragment();
    tradesToRender.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(trade => {
        const row = document.createElement('tr');
        row.className = 'border-b border-border-color';
        // Check if this trade is currently selected
            const isSelected = selectedTradeIds.has(trade.id);
            const checkState = isSelected ? 'checked' : '';
            const rowBg = isSelected ? 'bg-accent-color/5' : '';
            row.className = `border-b border-border-color hover:bg-bg-tertiary/50 transition-colors ${rowBg}`;
        
        const isClosed = trade.profitLoss !== null;
        let plText, plClass;
        if (!isClosed) { plText = 'Open'; plClass = 'text-text-secondary'; } 
        else if (trade.profitLoss > 0 && trade.profitLoss <= breakevenThreshold) { plText = 'Breakeven'; plClass = 'text-blue-500'; }
        else if (trade.profitLoss > breakevenThreshold) { plText = `$${trade.profitLoss.toFixed(2)}`; plClass = 'text-green-500'; }
        else { plText = `$${trade.profitLoss.toFixed(2)}`; plClass = 'text-red-500'; }
        
        
        const typeClass = trade.tradeType === 'Buy' ? 'bg-blue-900/50 text-blue-300' : 'bg-red-900/50 text-red-300';
        const tradeDate = new Date(trade.timestamp).toLocaleString('en-GB', { timeZone: 'Africa/Accra', dateStyle: 'medium', timeStyle: 'short' });
        
        const allTags = getActiveAccount().tags || [];
        const allPsychologyTags = getActiveAccount().psychologyTags || [];

        const tagSpans = (trade.tags && trade.tags.length > 0) ? `<div class="flex flex-wrap gap-1 mt-1">${trade.tags.map(tagName => {
            const tagInfo = allTags.find(t => t.name === tagName);
            const color = tagInfo ? tagInfo.color : '#8B5CF6';
            return `<span class="text-xs px-2 py-0.5 rounded-full font-semibold" style="background-color: ${color}33; color: ${color};">${tagName}</span>`;
        }).join('')}</div>` : '';

        const psychologyTagSpans = (trade.psychologyTags && trade.psychologyTags.length > 0) ? `<div class="flex flex-wrap gap-1 mt-1">${trade.psychologyTags.map(tagName => {
            const tagInfo = allPsychologyTags.find(t => t.name === tagName);
            const color = tagInfo ? tagInfo.color : '#EC4899';
            return `<span class="text-xs px-2 py-0.5 rounded-full font-semibold" style="background-color: ${color}33; color: ${color};">${tagName}</span>`;
        }).join('')}</div>` : '';

        row.innerHTML = `
            <td class="px-4 py-3 align-top">
                <input type="checkbox" 
                           class="trade-checkbox w-4 h-4 rounded border-border-color bg-bg-primary text-accent-color focus:ring-accent-color cursor-pointer mt-1" 
                           data-id="${trade.id}" 
                           onclick="toggleTradeSelection('${trade.id}')"
                           ${checkState}>
                </td>
                
                <td class="px-4 py-3 align-top">
                <div class="font-medium text-text-primary flex items-center gap-2">
    ${trade.indexName}
    ${!isClosed ? '<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse" title="Trade is Open"></span>' : ''}
</div>
                <div class="text-xs text-text-secondary">${tradeDate}</div>
                 <div class="text-xs font-semibold text-accent-color mt-1">${trade.timeframe || ''}</div>
                ${tagSpans}
                ${psychologyTagSpans}
            </td>
            <td class="px-4 py-3 align-top"><span class="px-2 py-1 text-xs font-semibold rounded-full ${typeClass}">${trade.tradeType}</span></td>
            <td class="px-4 py-3 font-bold align-top ${plClass}">${plText}</td>
            <td class="px-4 py-3 align-top">
                <div class="flex items-center space-x-2">
                    <button class="details-btn text-accent-color hover:underline text-sm font-semibold">View</button>
                    <button class="edit-trade-btn text-text-secondary hover:text-green-500" data-id="${trade.id}" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    <button class="delete-trade-btn text-text-secondary hover:text-red-500" data-id="${trade.id}" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>
            </td>`;
        
        const detailsRow = document.createElement('tr');
        detailsRow.className = 'details-row bg-bg-primary';

        const { grade, insights } = generateAdvancedInsights(trade);
        const insightIconMap = {
            positive: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>',
            negative: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>',
            warning: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>',
            info: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>',
            neutral: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-text-secondary" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 5.168A1 1 0 008 6v1a1 1 0 002 0V6a1 1 0 00-1-1h-.445zM10 14a1 1 0 100-2 1 1 0 000 2zM8 9a1 1 0 112 0v1a1 1 0 11-2 0V9z" clip-rule="evenodd" /></svg>'
        };
        const insightsHTML = insights.map(insight => `
            <li class="flex items-start gap-2 text-sm text-text-secondary insight-item">
                ${insightIconMap[insight.type] || insightIconMap.neutral}
                <span>${insight.text}</span>
            </li>
        `).join('');

        detailsRow.innerHTML = `
        <td colspan="5">
            <div class="details-content">
                <div class="trade-details-grid grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="rendered-notes prose dark:prose-invert max-w-none">${trade.notesHTML || '<p class="text-text-secondary">No notes or screenshots added.</p>'}</div>
                    <div class="trade-insight-card p-4 rounded-lg">
                        <h4 class="font-bold text-base text-text-primary mb-3 flex items-center justify-between">
                            <span>Trade Management Review</span>
                            <div class="flex items-center gap-2">
                                ${grade !== 'N/A' ? `<span class="insight-grade grade-${grade.toLowerCase()}">${grade}</span>` : ''}
                                <button class="toggle-review-btn p-1 rounded-full hover:bg-tertiary" title="Hide Review Panel">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </h4>
                        <ul class="space-y-2.5 list-none p-0">
                            ${insightsHTML}
                        </ul>
                    </div>
                </div>
            </div>
        </td>`;
        
        fragment.appendChild(row);
        fragment.appendChild(detailsRow);
    });

    tradeHistoryBody.appendChild(fragment);
};
        
     const updateSummary = (allTrades) => {
    const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
    dom['total-trades'].textContent = allTrades.length;

    const closedTrades = allTrades.filter(t => t.profitLoss !== null);
    const totalPL = closedTrades.reduce((acc, trade) => acc + trade.profitLoss, 0);
    const winningTrades = closedTrades.filter(trade => trade.profitLoss > breakevenThreshold);
    const losingTrades = closedTrades.filter(trade => trade.profitLoss <= 0);

    const totalProfit = winningTrades.reduce((acc, trade) => acc + trade.profitLoss, 0);
    const totalLoss = losingTrades.reduce((acc, trade) => acc + trade.profitLoss, 0);

    const avgProfit = winningTrades.length > 0 ? totalProfit / winningTrades.length : 0;
    const avgLoss = losingTrades.length > 0 ? Math.abs(totalLoss / losingTrades.length) : 0;

    const countableTrades = winningTrades.length + losingTrades.length;
    const winRate = countableTrades > 0 ? (winningTrades.length / countableTrades) * 100 : 0;
    const realizedRR = avgLoss > 0 ? avgProfit / avgLoss : 0;
    const profitFactor = Math.abs(totalLoss) > 0 ? totalProfit / Math.abs(totalLoss) : 0;

    // Prolific Score Calculation
    const winRateComponent = winRate;
    const profitFactorComponent = Math.min(profitFactor / 5, 1) * 100; // Cap at 5 for scoring
    const rrComponent = Math.min(realizedRR / 3, 1) * 100; // Cap at 3 for scoring
    const prolificScore = (winRateComponent * 0.4) + (profitFactorComponent * 0.4) + (rrComponent * 0.2);

    // --- Update Text Content ---
    const totalPlEl = dom['total-pl'];
    totalPlEl.textContent = `$${totalPL.toFixed(2)}`;
    totalPlEl.className = `text-2xl font-bold ${totalPL >= 0 ? 'text-green-500' : 'text-red-500'}`;
    dom['win-rate'].textContent = `${winRate.toFixed(1)}%`;
    const realizedRrEl = dom['realized-rr'];
    realizedRrEl.textContent = `1 : ${realizedRR.toFixed(2)}`;
    realizedRrEl.className = `text-2xl font-bold ${realizedRR >= 1 ? 'text-green-500' : 'text-red-500'}`;
    dom['avg-profit'].textContent = `$${avgProfit.toFixed(2)}`;
    dom['avg-loss'].textContent = `$${avgLoss.toFixed(2)}`;
    dom['prolific-score'].textContent = Math.round(prolificScore);

    // --- Call the SVG rendering functions ---
    renderTotalPLSparkline(allTrades);
    renderWinRateDonut(winRate);
    renderRRBarChart(avgProfit, avgLoss);
    renderAvgWinLossBars(avgProfit, avgLoss);
    renderProlificScoreGauge(prolificScore);
};
        
       // REPLACE YOUR OLD updateTradeCalendar FUNCTION WITH THIS NEW, EXPANDED VERSION
const updateTradeCalendar = () => {
    const isLightMode = document.documentElement.classList.contains('light');
    const winColor = isLightMode ? 'text-green-800' : 'text-green-300';
    const lossColor = isLightMode ? 'text-red-800' : 'text-red-300';
    const allTrades = getActiveTrades().filter(t => t.profitLoss !== null);
    const calendarBody = dom['calendar-body'];
    calendarBody.innerHTML = '';

    // Update view toggle button styles
    dom['calendar-view-toggle'].querySelectorAll('.calendar-view-btn').forEach(btn => {
        const isSelected = btn.dataset.view === calendarViewMode;
        btn.classList.toggle('bg-accent-color', isSelected);
        btn.classList.toggle('text-white', isSelected);
        btn.classList.toggle('text-text-secondary', !isSelected);
    });

   // --- VIEW-SPECIFIC RENDERING ---
    if (calendarViewMode === 'day') {
        renderDayView(allTrades, calendarBody, winColor, lossColor);
    } else if (calendarViewMode === 'month') {
        renderMonthView(allTrades, calendarBody, winColor, lossColor);
    } else if (calendarViewMode === 'year') {
        renderYearView(allTrades, calendarBody, winColor, lossColor);
    }
};

// --- SMART CALENDAR: 8-Column Grid (Days + Weekly Total) ---
const renderDayView = (allTrades, container, winColor, lossColor) => {
    // 1. Set Title
    dom['calendar-title'].textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    // 2. Setup Headers (Switch to 8 Columns)
    const headers = dom['calendar-day-headers'];
    headers.style.display = 'grid';
    // Note: grid-cols-8 to make room for the summary
    headers.className = 'grid grid-cols-8 gap-2 text-center text-xs text-text-secondary mb-2 font-bold uppercase tracking-wider';
    headers.innerHTML = `
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        <div class="text-accent-color">Week</div>
    `;

    // 3. Setup Grid Container
    container.className = 'grid grid-cols-8 gap-2';

    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay(); // 0 (Sun) to 6 (Sat)
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // 4. Pre-calculate Daily P/L
    const dailyPL = allTrades.reduce((acc, trade) => {
        const tradeDate = new Date(trade.timestamp);
        if (tradeDate.getFullYear() === year && tradeDate.getMonth() === month) {
            const day = tradeDate.getDate();
            acc[day] = (acc[day] || 0) + trade.profitLoss;
        }
        return acc;
    }, {});

    // 5. Render The Grid
    let currentWeekPL = 0;
    
    // We calculate total cells needed to complete full rows (weeks)
    // Formula: Round up to nearest multiple of 7
    const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;

    for (let i = 0; i < totalCells; i++) {
        const dayOfMonth = i - firstDay + 1;
        const isValidDay = dayOfMonth > 0 && dayOfMonth <= daysInMonth;
        
        // --- RENDER DAY CELL ---
        if (isValidDay) {
            const pl = dailyPL[dayOfMonth] || 0;
            currentWeekPL += pl;
            
            // Dynamic Coloring
            let bgClass = 'bg-bg-tertiary/30 hover:bg-bg-tertiary border-border-color';
            let textClass = 'text-text-secondary';
            let borderClass = 'border';

            if (pl > 0) {
                bgClass = 'bg-green-500/10 hover:bg-green-500/20';
                textClass = 'text-green-500';
                borderClass = 'border border-green-500/30';
            } else if (pl < 0) {
                bgClass = 'bg-red-500/10 hover:bg-red-500/20';
                textClass = 'text-red-400';
                borderClass = 'border border-red-500/30';
            }

            const dayDiv = document.createElement('div');
            dayDiv.className = `p-2 rounded-lg cursor-pointer transition-all min-h-[70px] flex flex-col justify-between ${bgClass} ${borderClass}`;
            dayDiv.innerHTML = `
                <div class="text-[10px] font-semibold text-text-secondary">${dayOfMonth}</div>
                <div class="text-sm font-bold ${textClass} text-right truncate">
                    ${pl !== 0 ? '$' + pl.toFixed(0) : '-'}
                </div>
            `;
            
          dayDiv.onclick = () => {
                // Get trades for this specific day
                const clickedDateStr = new Date(year, month, dayOfMonth).toLocaleDateString('en-CA');
                const dayTrades = allTrades.filter(t => {
                    return new Date(t.timestamp).toLocaleDateString('en-CA') === clickedDateStr;
                });

                if (dayTrades.length > 0) {
                    openDayModal(clickedDateStr, dayTrades);
                } else {
                    showToast("No trades recorded for this day.", "info");
                }
            };

            container.appendChild(dayDiv);
        } else {
            // Empty Placeholder
            const emptyDiv = document.createElement('div');
            emptyDiv.className = "min-h-[70px] opacity-0 pointer-events-none";
            container.appendChild(emptyDiv);
        }

        // --- RENDER WEEKLY SUMMARY (Every 7th Cell) ---
        if ((i + 1) % 7 === 0) {
            let summaryColor = 'text-text-secondary';
            let summaryBg = 'bg-bg-secondary';
            
            if (currentWeekPL > 0) {
                summaryColor = 'text-green-400';
                summaryBg = 'bg-green-500/5';
            } else if (currentWeekPL < 0) {
                summaryColor = 'text-red-400';
                summaryBg = 'bg-red-500/5';
            }

            const summaryDiv = document.createElement('div');
            summaryDiv.className = `p-2 ${summaryBg} border border-border-color/50 rounded-lg flex flex-col justify-center items-center min-h-[70px] relative overflow-hidden`;
            summaryDiv.innerHTML = `
                <div class="text-[9px] uppercase tracking-wider text-text-secondary/70 font-bold mb-1">Total</div>
                <div class="text-sm font-bold ${summaryColor}">
                    ${currentWeekPL !== 0 ? '$' + currentWeekPL.toFixed(0) : '-'}
                </div>
            `;
            container.appendChild(summaryDiv);
            
            // Reset for next week
            currentWeekPL = 0;
        }
    }
};
// --- DAY SUMMARY MODAL LOGIC ---
const openDayModal = (dateStr, trades) => {
    // 1. Calculate Stats
    const count = trades.length;
    if (count === 0) return; // Don't open for empty days

    const wins = trades.filter(t => t.profitLoss > 0).length;
    const winRate = (wins / count) * 100;
    const netPL = trades.reduce((sum, t) => sum + t.profitLoss, 0);
    
    // Find Best/Worst
    const sortedPL = trades.map(t => t.profitLoss).sort((a, b) => b - a);
    const best = sortedPL[0];
    const worst = sortedPL[sortedPL.length - 1];

    // 2. Populate UI
    document.getElementById('day-modal-date').textContent = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    
    const netEl = document.getElementById('day-modal-net');
    netEl.textContent = `Net P/L: ${netPL >= 0 ? '+' : ''}$${netPL.toFixed(2)}`;
    netEl.className = `text-sm font-mono mt-1 font-bold ${netPL >= 0 ? 'text-green-500' : 'text-red-500'}`;

    document.getElementById('day-modal-count').textContent = count;
    
    const wrEl = document.getElementById('day-modal-winrate');
    wrEl.textContent = `${winRate.toFixed(0)}%`;
    wrEl.className = `text-xl font-black mt-1 ${winRate >= 50 ? 'text-green-500' : 'text-red-500'}`;

    document.getElementById('day-modal-best').textContent = `+$${best.toFixed(2)}`;
    document.getElementById('day-modal-worst').textContent = worst < 0 ? `-$${Math.abs(worst).toFixed(2)}` : `$${worst.toFixed(2)}`;

    // 3. Setup Filter Button
    const btn = document.getElementById('day-modal-filter-btn');
    btn.onclick = () => {
        // Apply Filter
        const filterDate = dateStr; // YYYY-MM-DD
        const startInput = document.getElementById('filter-start-date');
        const endInput = document.getElementById('filter-end-date');
        
        if(startInput && endInput) {
            startInput.value = filterDate;
            endInput.value = filterDate;
            startInput.dispatchEvent(new Event('change'));
            endInput.dispatchEvent(new Event('change'));
            refreshUI();
            
            closeDayModal();
            // Scroll to history
            setTimeout(() => {
                document.getElementById('trade-history-body').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            showToast(`Filtered list to ${filterDate}`, 'info');
        }
    };

    // 4. Show Modal
    const modal = document.getElementById('day-summary-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
};

const closeDayModal = () => {
    const modal = document.getElementById('day-summary-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
};

// Expose to window
window.closeDayModal = closeDayModal;
// --- REDESIGNED: Month View (Premium Cards) ---
const renderMonthView = (allTrades, container, winColor, lossColor) => {
    dom['calendar-title'].textContent = calendarDate.getFullYear();
    dom['calendar-day-headers'].style.display = 'none'; 
    // Switch to 4 columns for a cleaner 3-row layout (Jan-Apr, May-Aug, Sep-Dec)
    container.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';

    const year = calendarDate.getFullYear();
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    months.forEach((monthName, index) => {
        // Filter trades for this specific month
        const monthTrades = allTrades.filter(t => {
            const d = new Date(t.timestamp);
            return d.getFullYear() === year && d.getMonth() === index;
        });

        const monthlyPL = monthTrades.reduce((sum, t) => sum + t.profitLoss, 0);
        const tradeCount = monthTrades.length;

        // Styling
        let bgClass = 'bg-bg-secondary border-border-color';
        let textClass = 'text-text-secondary';
        let glowClass = '';
        
        if (monthlyPL > 0) {
            bgClass = 'bg-green-500/5 border-green-500/30';
            textClass = 'text-green-500';
            glowClass = 'hover:shadow-[0_0_15px_rgba(34,197,94,0.15)]';
        } else if (monthlyPL < 0) {
            bgClass = 'bg-red-500/5 border-red-500/30';
            textClass = 'text-red-400';
            glowClass = 'hover:shadow-[0_0_15px_rgba(248,113,113,0.15)]';
        } else if (tradeCount === 0) {
             bgClass = 'bg-bg-tertiary/30 border-dashed border-border-color opacity-60';
        }

        const div = document.createElement('div');
        div.className = `p-5 rounded-xl border ${bgClass} cursor-pointer transition-all duration-300 transform hover:-translate-y-1 ${glowClass} flex flex-col justify-between h-32`;
        
        div.innerHTML = `
            <div class="flex justify-between items-start">
                <span class="text-sm font-bold text-text-primary uppercase tracking-wider">${monthName}</span>
                <span class="text-xs font-mono text-text-secondary bg-bg-primary px-2 py-0.5 rounded-full border border-border-color">${tradeCount} trds</span>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold ${textClass}">${monthlyPL !== 0 ? (monthlyPL > 0 ? '+' : '') + '$' + monthlyPL.toFixed(0) : '-'}</div>
            </div>
        `;
        
        div.onclick = () => {
            if (tradeCount > 0) {
                calendarDate.setMonth(index);
                calendarViewMode = 'day';
                updateTradeCalendar();
            }
        };
        
        container.appendChild(div);
    });
};

// --- REDESIGNED: Year View (Yearly Report Cards) ---
const renderYearView = (allTrades, container, winColor, lossColor) => {
    dom['calendar-title'].textContent = "Annual Performance";
    dom['calendar-day-headers'].style.display = 'none';
    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

    const yearlyData = {};
    
    // Group and Calculate Stats per Year
    allTrades.forEach(t => {
        const y = new Date(t.timestamp).getFullYear();
        if (!yearlyData[y]) yearlyData[y] = { pl: 0, count: 0, wins: 0 };
        
        yearlyData[y].pl += t.profitLoss;
        yearlyData[y].count++;
        if (t.profitLoss > 0) yearlyData[y].wins++;
    });

    const years = Object.keys(yearlyData).sort((a, b) => b - a);
    if (years.length === 0) years.push(new Date().getFullYear());

    years.forEach(year => {
        const data = yearlyData[year] || { pl: 0, count: 0, wins: 0 };
        const winRate = data.count > 0 ? (data.wins / data.count) * 100 : 0;
        
        let accentColor = 'border-border-color';
        let plColor = 'text-text-secondary';
        let bgGradient = 'bg-bg-secondary';

        if (data.pl > 0) {
            accentColor = 'border-green-500';
            plColor = 'text-green-500';
            bgGradient = 'bg-gradient-to-br from-bg-secondary to-green-900/10';
        } else if (data.pl < 0) {
            accentColor = 'border-red-500';
            plColor = 'text-red-400';
            bgGradient = 'bg-gradient-to-br from-bg-secondary to-red-900/10';
        }

        const div = document.createElement('div');
        div.className = `p-6 rounded-2xl border-l-4 ${accentColor} ${bgGradient} shadow-lg cursor-pointer transition-all hover:scale-[1.02]`;
        
        div.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-3xl font-black text-text-primary opacity-80">${year}</h3>
                <div class="px-3 py-1 rounded-lg bg-bg-tertiary text-xs font-mono text-text-secondary border border-border-color">
                    ${data.count} Trades
                </div>
            </div>
            
            <div class="space-y-2">
                <div class="flex justify-between items-end">
                    <span class="text-sm text-text-secondary">Net Profit</span>
                    <span class="text-2xl font-bold ${plColor}">${data.pl !== 0 ? (data.pl > 0 ? '+' : '') + '$' + data.pl.toFixed(2) : '$0.00'}</span>
                </div>
                <div class="w-full bg-bg-tertiary h-1.5 rounded-full overflow-hidden">
                     <div class="h-full ${data.pl >= 0 ? 'bg-green-500' : 'bg-red-500'}" style="width: ${Math.min(100, Math.abs(data.pl / 100))}%"></div>
                </div>
                <div class="flex justify-between pt-2">
                    <span class="text-xs text-text-secondary">Win Rate</span>
                    <span class="text-xs font-bold ${winRate >= 50 ? 'text-green-500' : 'text-orange-400'}">${winRate.toFixed(1)}%</span>
                </div>
            </div>
        `;
        
        div.onclick = () => {
            calendarDate.setFullYear(year);
            calendarViewMode = 'month'; // Drill down to month view
            updateTradeCalendar();
        };

        container.appendChild(div);
    });
};

        const generatePDF = async () => {
             toggleLoader(true);
             const { jsPDF } = window.jspdf;
             const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4', hotfixes: ['px_scaling'] });

             const content = dom['analytics-content-for-pdf'];
             
             await new Promise(resolve => setTimeout(resolve, 100));

             try {
                 const canvas = await html2canvas(content, { scale: 2, backgroundColor: '#1a1c23', useCORS: true, windowWidth: 1200 });
                 const imgData = canvas.toDataURL('image/jpeg', 0.9);
                 const pdfWidth = pdf.internal.pageSize.getWidth();
                 const pdfHeight = pdf.internal.pageSize.getHeight();
                 const imgProps = pdf.getImageProperties(imgData);
                 const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                 let heightLeft = imgHeight;
                 let position = 0;

                 pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                 heightLeft -= pdfHeight;

                 while (heightLeft > 0) {
                     position = heightLeft - imgHeight;
                     pdf.addPage();
                     pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                     heightLeft -= pdfHeight;
                 }
                 pdf.save(`prolific-journal-report-${new Date().toISOString().split('T')[0]}.pdf`);
                 showToast("PDF report generated!", "success");
             } catch(e) {
                 showToast("Error generating PDF.", "error");
                 console.error(e);
             } finally {
                 toggleLoader(false);
             }
        };
        
        const addAccount = async (accountName) => {
            accountName = accountName.trim();
            if (!accountName) { showToast("Account name cannot be empty.", "error"); return; }
            if (appData.accounts[accountName]) { showToast("An account with this name already exists.", "error"); return; }
            
            const newAccount = { 
                accountName,
                trades: [], 
                startingBalance: null, 
                tags: [
                    { name: 'Strategy', color: '#8B5CF6' },
                    { name: 'Mistake', color: '#EF4444' }
                ],
                psychologyTags: [
                    { name: 'FOMO', color: '#EC4899' },
                    { name: 'Revenge Trading', color: '#F43F5E' }
                ],
                goals: [],
                playbook: [],
                // --- START FIX: UPDATED THE CHECKLIST FOR NEWLY ADDED ACCOUNTS ---
                checklist: [ 
                    'Two positions?',
                    'ATR SL',
                    'At least 1:1 RR'
                ]
                // --- END FIX ---
            };
            
            await saveData('accounts', newAccount);
            appData.accounts[accountName] = newAccount; // Update in-memory state
            populateAccountSwitcher();
            switchAccount(accountName);
            showToast(`Account "${accountName}" created.`, "success");
        };

        const deleteAccount = async (accountName) => {
            if (Object.keys(appData.accounts).length <= 1) { showToast("You cannot delete the only remaining account.", "error"); return; }
            
            await deleteData('accounts', accountName);
            delete appData.accounts[accountName]; // Update in-memory state
            
            const newActiveAccount = Object.keys(appData.accounts)[0];
            appData.activeAccountName = newActiveAccount;
            localStorage.setItem('activeAccountName', newActiveAccount);
            console.log('Active Account on Load:', getActiveAccount());
            
            populateAccountSwitcher();
            switchAccount(appData.activeAccountName);
        };
        
        const renameAccount = async (oldName, newName) => {
            newName = newName.trim();
            if (!newName) { showToast("New name cannot be empty.", "error"); return; }
            if (appData.accounts[newName]) { showToast("An account with this name already exists.", "error"); return; }
            
            const accountData = appData.accounts[oldName];
            accountData.accountName = newName;
            
            await saveData('accounts', accountData);
            await deleteData('accounts', oldName);
            
            delete appData.accounts[oldName];
            appData.accounts[newName] = accountData;
            
            if (appData.activeAccountName === oldName) {
                appData.activeAccountName = newName;
                localStorage.setItem('activeAccountName', newName);
            }
            
            populateAccountSwitcher();
        };

        const renderAccountsList = () => {
            const container = dom['accounts-list'];
            container.innerHTML = '';
            Object.keys(appData.accounts).forEach(name => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-tertiary rounded-md';
                div.innerHTML = `<span class="font-semibold">${name}</span>
                    <div>
                        <button class="rename-account-btn p-1 text-text-secondary hover:text-green-500" data-name="${name}">Rename</button>
                        <button class="delete-account-btn p-1 text-text-secondary hover:text-red-500" data-name="${name}">Delete</button>
                    </div>`;
                container.appendChild(div);
            });

            container.querySelectorAll('.delete-account-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const accountName = e.currentTarget.dataset.name;
                const confirmed = await showCustomModal({
                    title: `Delete Account "${accountName}"`,
                    text: 'Are you sure? All trades and data for this account will be permanently deleted. This action cannot be undone.',
                    confirmText: 'Delete Account'
                });
                if (confirmed) {
                    await deleteAccount(accountName);
                    renderAccountsList();
                }
            }));
            
            container.querySelectorAll('.rename-account-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const oldName = e.currentTarget.dataset.name;
                const newName = await showCustomModal({
                    title: 'Rename Account',
                    text: `Enter a new name for "${oldName}":`,
                    isPrompt: true,
                    promptValue: oldName,
                    confirmText: 'Rename'
                });
                if(newName && newName !== oldName) {
                    await renameAccount(oldName, newName);
                    renderAccountsList();
                }
            }));
        };
         
       
       const updateAdvancedAnalytics = (allTrades, maxDrawdownUSD) => {
    const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
    const closedTrades = allTrades.filter(t => t.profitLoss !== null);

    // --- Reset all fields if there are no trades ---
    if (closedTrades.length === 0) {
        dom['profit-factor'].textContent = '0.00';
        dom['expectancy'].textContent = '$0.00';
        dom['win-streak'].textContent = '0';
        dom['loss-streak'].textContent = '0';
        if (dom['recovery-factor']) dom['recovery-factor'].textContent = '0.00';
        // You might want to clear charts here too if they are not cleared elsewhere
        return;
    }

    const winningTrades = closedTrades.filter(t => t.profitLoss > breakevenThreshold);
    const losingTrades = closedTrades.filter(t => t.profitLoss <= 0);

    const grossProfit = winningTrades.reduce((sum, t) => sum + t.profitLoss, 0);
    const grossLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.profitLoss, 0));
    const totalPL = grossProfit - grossLoss;
    const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : Infinity;

    // --- NEW: Recovery Factor Calculation ---
    let recoveryFactor = 0.00;
    if (maxDrawdownUSD > 0) {
        recoveryFactor = totalPL / maxDrawdownUSD;
    } else if (totalPL > 0) {
        recoveryFactor = Infinity; // No drawdown, but positive profit
    }
    
    if (dom['recovery-factor']) {
        dom['recovery-factor'].textContent = recoveryFactor === Infinity ? '' : recoveryFactor.toFixed(2);
        dom['recovery-factor'].className = `text-2xl font-bold ${recoveryFactor >= 1 ? 'text-green-500' : 'text-red-500'}`;
        if (recoveryFactor < 0 || recoveryFactor === 0) {
            dom['recovery-factor'].className = `text-2xl font-bold text-red-500`;
        }
    }
    // --- End of new logic ---

    const winRate = (winningTrades.length + losingTrades.length) > 0 ? winningTrades.length / (winningTrades.length + losingTrades.length) : 0;
    const lossRate = 1 - winRate;
    const avgWin = winningTrades.length > 0 ? grossProfit / winningTrades.length : 0;
    const avgLoss = losingTrades.length > 0 ? grossLoss / losingTrades.length : 0;
    const expectancy = (winRate * avgWin) - (lossRate * avgLoss);

    dom['profit-factor'].textContent = profitFactor === Infinity ? '' : profitFactor.toFixed(2);
    dom['expectancy'].textContent = `$${expectancy.toFixed(2)}`;

    let maxWinStreak = 0, currentWinStreak = 0, maxLossStreak = 0, currentLossStreak = 0;
    closedTrades.forEach(trade => {
        if (trade.profitLoss > breakevenThreshold) { currentWinStreak++; currentLossStreak = 0; maxWinStreak = Math.max(maxWinStreak, currentWinStreak); } 
        else if (trade.profitLoss <= 0) { currentLossStreak++; currentWinStreak = 0; maxLossStreak = Math.max(maxLossStreak, currentLossStreak); }
    });
    dom['win-streak'].textContent = maxWinStreak;
    dom['loss-streak'].textContent = maxLossStreak;

    // ... (rest of the original chart logic remains the same)
    const chartOptions = getChartColors();
            
    const dailyStats = { 'Sun': 0, 'Mon': 0, 'Tue': 0, 'Wed': 0, 'Thu': 0, 'Fri': 0, 'Sat': 0 };
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    closedTrades.forEach(t => dailyStats[days[new Date(t.timestamp).getDay()]] += t.profitLoss);
    const dailyData = Object.values(dailyStats);
    if(dailyPerfChart) dailyPerfChart.destroy();
    dailyPerfChart = new Chart(dom['dailyPerformanceChart'], {
        type: 'bar',
        data: {
            labels: days,
            datasets: [{
                label: 'Total P/L by Day',
                data: dailyData,
                backgroundColor: dailyData.map(v => v >= 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)'),
            }]
        },
        options: { scales: { y: { beginAtZero: true, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } }, x: { grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } } }, plugins: { legend: { display: false } } }
    });

    const hourlyStats = Array(24).fill(0);
    closedTrades.forEach(t => hourlyStats[new Date(t.timestamp).getHours()] += t.profitLoss);
    if(hourlyPerfChart) hourlyPerfChart.destroy();
    hourlyPerfChart = new Chart(dom['hourlyPerformanceChart'], {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Total P/L by Hour',
                data: hourlyStats,
                backgroundColor: hourlyStats.map(v => v >= 0 ? 'rgba(79, 70, 229, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
            }]
        },
        options: { scales: { y: { beginAtZero: true, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } }, x: { grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } } }, plugins: { legend: { display: false } } }
    });
};
        
       const updateTagAnalysis = (allTrades, tagType, bodyElement) => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            bodyElement.innerHTML = '';
            // Change layout from grid to a vertical flex container
           bodyElement.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4';

            const tradesWithTags = allTrades.filter(t => t.profitLoss !== null && t[tagType] && t[tagType].length > 0);
            if(tradesWithTags.length === 0) { 
                bodyElement.innerHTML = `<p class="text-center text-text-secondary py-4 col-span-full">No trades with these tags to analyze.</p>`; 
                bodyElement.className = 'grid grid-cols-1'; // Revert class if empty
                return; 
            }

            const stats = tradesWithTags.reduce((acc, trade) => {
                trade[tagType].forEach(tag => {
                    if(!acc[tag]) acc[tag] = { trades: 0, totalPL: 0, wins: 0, grossProfit: 0, grossLoss: 0 };
                    acc[tag].trades++;
                    acc[tag].totalPL += trade.profitLoss;
                    if(trade.profitLoss > breakevenThreshold) {
                        acc[tag].wins++;
                        acc[tag].grossProfit += trade.profitLoss;
                    } else if (trade.profitLoss <= 0) {
                        acc[tag].grossLoss += Math.abs(trade.profitLoss);
                    }
                });
                return acc;
            }, {});
            
            const maxAbsPL = Math.max(...Object.values(stats).map(s => Math.abs(s.totalPL)), 1);
            const allAccountTags = getActiveAccount()[tagType] || [];

            Object.entries(stats).sort((a,b) => b[1].totalPL - a[1].totalPL).forEach(([tag, data]) => {
                const isWin = data.totalPL >= 0;
                const plClass = isWin ? 'text-green-400' : 'text-red-400';
                const barClass = isWin ? 'win' : 'loss';
                const winRate = data.trades > 0 ? (data.wins / data.trades) * 100 : 0;
                const profitFactor = data.grossLoss > 0 ? (data.grossProfit / data.grossLoss).toFixed(2) : '';
                const barWidth = (Math.abs(data.totalPL) / maxAbsPL) * 100;

                const tagInfo = allAccountTags.find(t => t.name === tag);
                const color = tagInfo ? tagInfo.color : '#8B5CF6';
                
                const statCard = document.createElement('div');
                statCard.className = 'deep-dive-card';
                statCard.style.borderLeftColor = color;
                statCard.innerHTML = `
                    <div class="deep-dive-header">
                        <h3 class="title" style="color: ${color};">${tag}</h3>
                        <div class="total-pl ${plClass}">$${data.totalPL.toFixed(2)}</div>
                    </div>
                    <div class="pl-bar-background">
                        <div class="pl-bar-fill ${barClass}" style="width: ${barWidth}%;"></div>
                    </div>
                    <div class="secondary-stats">
                        <div class="stat-item">
                            <div class="stat-item-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M.5 10a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-1.5H1a.5.5 0 0 1-.5-.5Zm15 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-1.5v1.5a.5.5 0 0 1-1 0v-2ZM10 .5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0V1a.5.5 0 0 1 .5-.5ZM10 15a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-1.5a.5.5 0 0 1 .5-.5Z"/><path d="M3 14.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm-10-2.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5ZM8 12.75a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 8 12.75v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5ZM3 9.75a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 3 9.75v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm-10-2.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Z"/></svg>
                                <span>${winRate.toFixed(1)}%</span>
                            </div>
                            <span class="stat-item-label">Win Rate</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.986 4.423a2.25 2.25 0 00-2.204-2.029A2.25 2.25 0 007.5 4.75v1.295a2.25 2.25 0 001.536 2.158l3.657 1.219A2.25 2.25 0 0114.75 12v1.5a2.25 2.25 0 01-4.5 0V9.72l-3.657-1.219A2.25 2.25 0 004.25 6.045V4.75a2.25 2.25 0 00-2.225-2.247A2.25 2.25 0 00-.25 4.75v11.5c0 .621.504 1.125 1.125 1.125h16.25c.621 0 1.125-.504 1.125-1.125V4.75a2.25 2.25 0 00-2.225-2.247 2.25 2.25 0 00-2.204-2.029zM2.5 6.045a.75.75 0 01.775-.747A.75.75 0 014 6.045v10.205H2.5V6.045zm13.25.747a.75.75 0 00.775.747.75.75 0 00.725-.747V4.75a.75.75 0 00-1.5 0v2.042z" clip-rule="evenodd" /></svg>
                                <span>${profitFactor}</span>
                            </div>
                            <span class="stat-item-label">Profit Factor</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v.75h.75a.5.5 0 0 1 0 1h-.75v.75a.5.5 0 0 1-1 0v-.75h-.75a.5.5 0 0 1 0-1h.75v-.75A.5.5 0 0 1 8 4ZM14 4a.5.5 0 0 1 .5.5v.75h.75a.5.5 0 0 1 0 1h-.75v.75a.5.5 0 0 1-1 0v-.75h-.75a.5.5 0 0 1 0-1h.75v-.75a.5.5 0 0 1 .5-.5ZM5.5 12a.5.5 0 0 1 .5-.5h.75v-.75a.5.5 0 0 1 1 0v.75h.75a.5.5 0 0 1 0 1h-.75v.75a.5.5 0 0 1-1 0v-.75h-.75a.5.5 0 0 1-.5-.5Zm9 0a.5.5 0 0 1 .5-.5h.75v-.75a.5.5 0 0 1 1 0v.75h.75a.5.5 0 0 1 0 1h-.75v.75a.5.5 0 0 1-1 0v-.75h-.75a.5.5 0 0 1-.5-.5Z"/><path d="M3 9.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5Z"/></svg>
                                <span>${data.trades}</span>
                            </div>
                            <span class="stat-item-label">Trades</span>
                        </div>
                    </div>
                `;
                bodyElement.appendChild(statCard);
            });
        };

       // ADD this new function where the old one was
const updateGenericBreakdownAnalysis = (trades, property, bodyElement, title) => {
            bodyElement.innerHTML = '';
            bodyElement.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4'; // Set new layout
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const closedTrades = trades.filter(t => t.profitLoss !== null && t[property]);

            if (closedTrades.length === 0) {
                bodyElement.innerHTML = `<p class="text-center text-text-secondary py-4 col-span-full">No closed trades with ${title} data to analyze.</p>`;
                bodyElement.className = 'grid grid-cols-1'; // Revert if empty
                return;
            }

            const stats = closedTrades.reduce((acc, trade) => {
                const key = trade[property];
                if (!acc[key]) acc[key] = { trades: 0, totalPL: 0, wins: 0, grossProfit: 0, grossLoss: 0 };
                acc[key].trades++;
                acc[key].totalPL += trade.profitLoss;
                if (trade.profitLoss > breakevenThreshold) {
                    acc[key].wins++;
                    acc[key].grossProfit += trade.profitLoss;
                } else if (trade.profitLoss <= 0) {
                    acc[key].grossLoss += Math.abs(trade.profitLoss);
                }
                return acc;
            }, {});

            const maxAbsPL = Math.max(...Object.values(stats).map(s => Math.abs(s.totalPL)), 1);

            Object.entries(stats).sort((a, b) => b[1].totalPL - a[1].totalPL).forEach(([item, data]) => {
                const isWin = data.totalPL >= 0;
                const plClass = isWin ? 'text-green-400' : 'text-red-400';
                const barClass = isWin ? 'win' : 'loss';
                const winRate = data.trades > 0 ? (data.wins / data.trades) * 100 : 0;
                const profitFactor = data.grossLoss > 0 ? (data.grossProfit / data.grossLoss).toFixed(2) : '';
                const barWidth = (Math.abs(data.totalPL) / maxAbsPL) * 100;
                
                const statCard = document.createElement('div');
                statCard.className = 'deep-dive-card';
                statCard.innerHTML = `
                    <div class="deep-dive-header">
                        <h3 class="title"><a href="#" class="drill-down-link" data-filter-type="${property}" data-filter-value="${item}">${item}</a></h3>
                        <div class="total-pl ${plClass}">$${data.totalPL.toFixed(2)}</div>
                    </div>
                    <div class="pl-bar-background">
                        <div class="pl-bar-fill ${barClass}" style="width: ${barWidth}%;"></div>
                    </div>
                    <div class="secondary-stats">
                        <div class="stat-item">
                            <div class="stat-item-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M.5 10a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-1.5H1a.5.5 0 0 1-.5-.5Zm15 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-1.5v1.5a.5.5 0 0 1-1 0v-2ZM10 .5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0V1a.5.5 0 0 1 .5-.5ZM10 15a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-1.5a.5.5 0 0 1 .5-.5Z"/><path d="M3 14.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm-10-2.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5ZM8 12.75a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 8 12.75v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5ZM3 9.75a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 3 9.75v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm-10-2.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm2.5.5a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Z"/></svg>
                                <span>${winRate.toFixed(1)}%</span>
                            </div>
                            <span class="stat-item-label">Win Rate</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.986 4.423a2.25 2.25 0 00-2.204-2.029A2.25 2.25 0 007.5 4.75v1.295a2.25 2.25 0 001.536 2.158l3.657 1.219A2.25 2.25 0 0114.75 12v1.5a2.25 2.25 0 01-4.5 0V9.72l-3.657-1.219A2.25 2.25 0 004.25 6.045V4.75a2.25 2.25 0 00-2.225-2.247A2.25 2.25 0 00-.25 4.75v11.5c0 .621.504 1.125 1.125 1.125h16.25c.621 0 1.125-.504 1.125-1.125V4.75a2.25 2.25 0 00-2.225-2.247 2.25 2.25 0 00-2.204-2.029zM2.5 6.045a.75.75 0 01.775-.747A.75.75 0 014 6.045v10.205H2.5V6.045zm13.25.747a.75.75 0 00.775.747.75.75 0 00.725-.747V4.75a.75.75 0 00-1.5 0v2.042z" clip-rule="evenodd" /></svg>
                                <span>${profitFactor}</span>
                            </div>
                            <span class="stat-item-label">Profit Factor</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v.75h.75a.5.5 0 0 1 0 1h-.75v.75a.5.5 0 0 1-1 0v-.75h-.75a.5.5 0 0 1 0-1h.75v-.75A.5.5 0 0 1 8 4ZM14 4a.5.5 0 0 1 .5.5v.75h.75a.5.5 0 0 1 0 1h-.75v.75a.5.5 0 0 1-1 0v-.75h-.75a.5.5 0 0 1 0-1h.75v-.75a.5.5 0 0 1 .5-.5ZM5.5 12a.5.5 0 0 1 .5-.5h.75v-.75a.5.5 0 0 1 1 0v.75h.75a.5.5 0 0 1 0 1h-.75v.75a.5.5 0 0 1-1 0v-.75h-.75a.5.5 0 0 1-.5-.5Zm9 0a.5.5 0 0 1 .5-.5h.75v-.75a.5.5 0 0 1 1 0v.75h.75a.5.5 0 0 1 0 1h-.75v.75a.5.5 0 0 1-1 0v-.75h-.75a.5.5 0 0 1-.5-.5Z"/><path d="M3 9.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5Z"/></svg>
                                <span>${data.trades}</span>
                            </div>
                            <span class="stat-item-label">Trades</span>
                        </div>
                    </div>
                `;
                bodyElement.appendChild(statCard);
            });
        };
       // --- DASHBOARD UPDATE 1: R:R Stats ---
const updateRRAnalysis = (allTrades) => {
    const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
    const rrTrades = allTrades.filter(t => t.rrRatio !== null && t.rrRatio > 0 && t.profitLoss !== null);

    // Default values
    let avgPlannedRR = 0;
    let realizedRR = 0;
    let realizedColor = 'text-text-primary';

    if (rrTrades.length > 0) {
        const totalPlannedRR = rrTrades.reduce((acc, t) => acc + t.rrRatio, 0);
        avgPlannedRR = totalPlannedRR / rrTrades.length;
        
        const winningTrades = rrTrades.filter(t => t.profitLoss > breakevenThreshold);
        const losingTrades = rrTrades.filter(t => t.profitLoss <= 0);
        
        const totalProfit = winningTrades.reduce((acc, t) => acc + t.profitLoss, 0);
        const totalLoss = Math.abs(losingTrades.reduce((acc, t) => acc + t.profitLoss, 0));
        
        const avgProfit = winningTrades.length > 0 ? totalProfit / winningTrades.length : 0;
        const avgLoss = losingTrades.length > 0 ? totalLoss / losingTrades.length : 0;
        
        realizedRR = avgLoss > 0 ? avgProfit / avgLoss : 0;
        
        if (realizedRR >= avgPlannedRR) realizedColor = 'text-green-500';
        else if (realizedRR < 1) realizedColor = 'text-red-500';
    }

    // Update New Dashboard Elements
    const kpiPlanned = document.getElementById('kpi-planned-rr');
    const kpiRealized = document.getElementById('kpi-realized-rr');
    const kpiRealizedSub = document.getElementById('kpi-realized-sub');

    if (kpiPlanned) kpiPlanned.textContent = `1 : ${avgPlannedRR.toFixed(2)}`;
    if (kpiRealized) {
        kpiRealized.textContent = `1 : ${realizedRR.toFixed(2)}`;
        kpiRealized.className = `text-2xl font-bold ${realizedColor}`;
    }
    if (kpiRealizedSub) {
        const diff = realizedRR - avgPlannedRR;
        kpiRealizedSub.textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(2)} vs Planned`;
        kpiRealizedSub.className = `text-xs mt-1 ${diff >= 0 ? 'text-green-500' : 'text-red-400'}`;
    }
};
        const showTradesForDay = (date) => {
            dom['calendar-day-title'].textContent = `Trades for ${date.toLocaleDateString('en-US', { dateStyle: 'full' })}`;
            const tradesContainer = dom['calendar-day-trades'];
            tradesContainer.innerHTML = '';

            const tradesForDay = getActiveTrades().filter(trade => {
                const tradeDate = new Date(trade.timestamp);
                return tradeDate.getFullYear() === date.getFullYear() &&
                       tradeDate.getMonth() === date.getMonth() &&
                       tradeDate.getDate() === date.getDate();
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (tradesForDay.length === 0) {
                tradesContainer.innerHTML = '<p class="text-center text-text-secondary">No trades on this day.</p>';
            } else {
                const fragment = document.createDocumentFragment();
                tradesForDay.forEach(trade => {
                    const isClosed = trade.profitLoss !== null;
                    let plText, plClass;
                    if (!isClosed) { plText = 'Open'; plClass = 'text-text-secondary'; } 
                    else if (trade.profitLoss > 0) { plText = `$${trade.profitLoss.toFixed(2)}`; plClass = 'text-green-500'; }
                    else { plText = `$${trade.profitLoss.toFixed(2)}`; plClass = 'text-red-500'; }
                    
                    const div = document.createElement('div');
                    div.className = 'bg-tertiary/50 p-3 rounded-lg border border-border-color mb-2 flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold text-text-primary">${trade.indexName} <span class="text-xs ${trade.tradeType === 'Buy' ? 'text-blue-400' : 'text-red-400'}">(${trade.tradeType})</span></p>
                            <p class="text-xs text-text-secondary">Entry: ${trade.entryPrice} | Exit: ${trade.exitPrice || 'N/A'}</p>
                        </div>
                        <p class="font-bold ${plClass}">${plText}</p>
                    `;
                    fragment.appendChild(div);
                });
                tradesContainer.appendChild(fragment);
            }
            dom['calendar-day-modal'].classList.add('open');
        };
        const updateReversalAnalysis = (allTrades) => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const body = dom['reversal-analysis-body'];
            body.innerHTML = '';

            const reversedTrades = allTrades.filter(t => 
    t.profitLoss !== null && 
    t.profitLoss <= breakevenThreshold && 
    t.peakPrice !== null && 
    !isNaN(t.peakPrice) &&
    calculatePL(t.tradeType, t.lotSize, t.entryPrice, t.peakPrice, t.indexName).profit > 0
);
            if (reversedTrades.length === 0) {
                body.innerHTML = '<p class="text-center text-text-secondary py-4 col-span-full">No reversed trades with potential profit to analyze.</p>';
                return;
            }

            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            const weeklyReversals = reversedTrades.filter(t => new Date(t.timestamp) >= startOfWeek);
            const monthlyReversals = reversedTrades.filter(t => new Date(t.timestamp) >= startOfMonth);
            const yearlyReversals = reversedTrades.filter(t => new Date(t.timestamp) >= startOfYear);
            
            const createAnalysisCard = (trades, periodName) => {
                if (trades.length === 0) {
                    return `<div class="bg-tertiary/50 p-4 rounded-lg border border-border-color">
                                <h3 class="font-bold text-lg text-text-primary">${periodName}</h3>
                                <p class="mt-2 text-sm text-text-secondary">No reversals in this period.</p>
                            </div>`;
                }

                let totalPotentialProfit = 0;
                let totalHoldTime = 0;
                const tagFreq = {};
                const assetFreq = {};

                trades.forEach(trade => {
                    const { profit: peakProfit } = calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.peakPrice, trade.indexName);
                    if (peakProfit > 0) totalPotentialProfit += (peakProfit - (trade.profitLoss > 0 ? trade.profitLoss : 0));
                    
                    if(trade.exitTimestamp) {
                        totalHoldTime += new Date(trade.exitTimestamp) - new Date(trade.timestamp);
                    }

                    (trade.tags || []).forEach(t => tagFreq[t] = (tagFreq[t] || 0) + 1);
                    assetFreq[trade.indexName] = (assetFreq[trade.indexName] || 0) + 1;
                });
                
                const findTopItem = (freqMap) => Object.keys(freqMap).length > 0 ? Object.entries(freqMap).sort((a,b) => b[1] - a[1])[0][0] : 'N/A';
                
                const topTag = findTopItem(tagFreq);
                const topAsset = findTopItem(assetFreq);
                const avgHoldTime = totalHoldTime / trades.length;

                return `<div class="reversal-card">
                            <h3 class="reversal-card-header">${periodName} (${trades.length} Reversals)</h3>
                            <div class="mt-2 space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-text-secondary">Profit Slipped:</span><span class="reversal-card-stat-value">$${totalPotentialProfit.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-text-secondary">Avg. Hold Time:</span><span class="reversal-card-stat-value">${formatDuration(avgHoldTime)}</span></div>
                                <hr class="my-1 border-border-color">
                                <div class="flex justify-between"><span class="text-text-secondary">Top Reversed Asset:</span><span class="font-semibold text-text-primary">${topAsset}</span></div>
                                <div class="flex justify-between"><span class="text-text-secondary">Top Associated Tag:</span><span class="font-semibold" style="color: var(--accent-color);">${topTag}</span></div>
                            </div>
                        </div>`;
            };

            body.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${createAnalysisCard(weeklyReversals, 'This Week')}
                    ${createAnalysisCard(monthlyReversals, 'This Month')}
                    ${createAnalysisCard(yearlyReversals, 'This Year')}
                </div>
            `;
        };
       // --- DASHBOARD UPDATE 2: Efficiency & Excursion ---
const updateExcursionAnalysis = (allTrades) => {
    // 1. Safety Check: Ensure elements exist before trying to update them
    const mfeValEl = document.getElementById('dash-mfe-val');
    const mfePctEl = document.getElementById('dash-mfe-pct');
    const maeValEl = document.getElementById('dash-mae-val');
    const maePctEl = document.getElementById('dash-mae-pct');

    if (!mfeValEl || !maeValEl) return; 

    const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
    
    // 2. Filter Trades
    // Only analyze closed trades
    const closedTrades = allTrades.filter(t => t.profitLoss !== null);
    const winningTrades = closedTrades.filter(t => t.profitLoss > breakevenThreshold);
    const losingOrBETrades = closedTrades.filter(t => t.profitLoss <= breakevenThreshold);

    // 3. MAE (Pain) Logic: Analyze "Heat" taken on Winning Trades
    let totalMAE = 0;
    let maeCount = 0;
    
    winningTrades.forEach(trade => {
        const maePrice = parseFloat(trade.maePrice);
        const entryPrice = parseFloat(trade.entryPrice);
        const lotSize = parseFloat(trade.lotSize);
        
        // Only calculate if we have a valid MAE price recorded
        if (!isNaN(maePrice) && !isNaN(entryPrice)) {
            const { profit } = calculatePL(trade.tradeType, lotSize, entryPrice, maePrice, trade.indexName);
            // We are looking for negative numbers (drawdown). 
            // We take the absolute value to show "Avg Heat".
            if (profit !== null && profit < 0) {
                totalMAE += Math.abs(profit);
                maeCount++;
            }
        }
    });

    const avgMAE = maeCount > 0 ? totalMAE / maeCount : 0;
    
    // Context: Compare Avg Heat vs Avg Profit
    const totalProfit = winningTrades.reduce((acc, t) => acc + t.profitLoss, 0);
    const avgProfit = winningTrades.length > 0 ? totalProfit / winningTrades.length : 0;
    const maePct = avgProfit > 0 ? (avgMAE / avgProfit) * 100 : 0;

    // 4. MFE (Gain) Logic: Analyze "Missed Profit" on Losing/BE Trades
    let totalMFE = 0;
    let mfeCount = 0;

    losingOrBETrades.forEach(trade => {
        const peakPrice = parseFloat(trade.peakPrice);
        const entryPrice = parseFloat(trade.entryPrice);
        const lotSize = parseFloat(trade.lotSize);

        // Only calculate if we have a valid Peak price recorded
        if (!isNaN(peakPrice) && !isNaN(entryPrice)) {
            const { profit } = calculatePL(trade.tradeType, lotSize, entryPrice, peakPrice, trade.indexName);
            // We are looking for positive numbers (profit seen before loss).
            if (profit !== null && profit > 0) {
                totalMFE += profit;
                mfeCount++;
            }
        }
    });

    const avgMFE = mfeCount > 0 ? totalMFE / mfeCount : 0;
    
    // Context: Compare Avg Missed Profit vs Avg Actual Loss
    const totalLoss = losingOrBETrades.reduce((acc, t) => acc + Math.abs(t.profitLoss), 0);
    const avgLoss = losingOrBETrades.length > 0 ? totalLoss / losingOrBETrades.length : 0;
    const mfePct = avgLoss > 0 ? (avgMFE / avgLoss) * 100 : 0;

    // 5. Update the DOM
    maeValEl.textContent = `$${avgMAE.toFixed(2)}`;
    if (maePctEl) maePctEl.textContent = `${maePct.toFixed(1)}%`;
    
    mfeValEl.textContent = `$${avgMFE.toFixed(2)}`;
    if (mfePctEl) mfePctEl.textContent = `${mfePct.toFixed(1)}%`;
};

const runMonteCarlo = () => {
            toggleLoader(true);
            setTimeout(() => {
                const tradesToProject = parseInt(dom['mc-trades'].value);
                const numSimulations = parseInt(dom['mc-simulations'].value);
                const closedTrades = getActiveTrades().filter(t => t.profitLoss !== null);

                if (closedTrades.length < 10) {
                    showToast("Need at least 10 closed trades for a meaningful simulation.", "error");
                    toggleLoader(false);
                    return;
                }

                const historicalReturns = closedTrades.map(t => t.profitLoss);
                const initialBalance = getActiveAccount().startingBalance || 0;
                const simulationResults = [];
                let finalEquities = [];

                for (let i = 0; i < numSimulations; i++) {
                    let currentEquity = initialBalance;
                    const path = [{ x: 0, y: initialBalance }];
                    for (let j = 0; j < tradesToProject; j++) {
                        const randomReturn = historicalReturns[Math.floor(Math.random() * historicalReturns.length)];
                        currentEquity += randomReturn;
                        path.push({ x: j + 1, y: currentEquity });
                    }
                    simulationResults.push(path);
                    finalEquities.push(currentEquity);
                }

                finalEquities.sort((a, b) => a - b);

                const medianFinalEquity = finalEquities[Math.floor(numSimulations / 2)];
                const top10Percentile = finalEquities[Math.floor(numSimulations * 0.9)];
                const bottom10Percentile = finalEquities[Math.floor(numSimulations * 0.1)];
                const probOfProfit = (finalEquities.filter(e => e > initialBalance).length / numSimulations) * 100;

                dom['mc-stats'].innerHTML = `
                    <h3 class="font-bold text-lg text-text-primary mb-2">Simulation Stats</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-text-secondary">Median Outcome:</span><span class="font-semibold text-text-primary">$${medianFinalEquity.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-text-secondary">Top 10% Outcome:</span><span class="font-semibold text-green-500">$${top10Percentile.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-text-secondary">Bottom 10% Outcome:</span><span class="font-semibold text-red-500">$${bottom10Percentile.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-text-secondary">Probability of Profit:</span><span class="font-semibold text-accent-color">${probOfProfit.toFixed(1)}%</span></div>
                    </div>
                `;

                const chartColors = getChartColors();
                if (mcChart) mcChart.destroy();
                mcChart = new Chart(dom.mcChart, {
                    type: 'line',
                    data: {
                        datasets: simulationResults.slice(0, 50).map((path, i) => ({
                            label: `Sim ${i + 1}`,
                            data: path,
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            pointRadius: 0
                        }))
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: chartColors.gridColor }, ticks: { color: chartColors.textColor } },
                            x: { title: { display: true, text: 'Number of Trades', color: chartColors.textColor }, grid: { color: chartColors.gridColor }, ticks: { color: chartColors.textColor } }
                        }
                    }
                });
                showToast("Monte Carlo simulation complete!", "success");
                toggleLoader(false);
            }, 50);
        };
        const exportData = async () => {
            try {
                const allAccounts = await getAllData('accounts');
                const settings = await getData('settings', 'appSettings');
                
                const dataToExport = {
                    accounts: allAccounts.reduce((acc, account) => {
                        const { accountName, ...rest } = account;
                        acc[accountName] = rest;
                        return acc;
                    }, {}),
                    settings: settings,
                    activeAccountName: appData.activeAccountName
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `prolific-journal-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showToast("Data exported successfully!", "success");
            } catch (e) {
                showToast("Error exporting data.", "error");
                console.error(e);
            }
        };
        const importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.accounts && importedData.settings) {
                        toggleLoader(true);
                        // Clear existing data
                        // This is a simplification. A more robust import might merge data.
                        const accountsTransaction = db.transaction('accounts', 'readwrite');
                        await accountsTransaction.objectStore('accounts').clear();
                        const settingsTransaction = db.transaction('settings', 'readwrite');
                        await settingsTransaction.objectStore('settings').clear();

                        // Import new data
                        for (const accountName in importedData.accounts) {
                             await saveData('accounts', { accountName, ...importedData.accounts[accountName] });
                        }
                        await saveData('settings', importedData.settings);
                        
                        localStorage.setItem('activeAccountName', importedData.activeAccountName);
                        
                        await loadAppData(); // Reload all data from DB
                        populateAccountSwitcher();
                        refreshUI();
                        
                        showToast("Data imported successfully!", "success");
                    } else {
                        showToast("Invalid backup file format.", "error");
                    }
                } catch (err) {
                    showToast("Could not parse backup file.", "error");
                    console.error(err);
                } finally {
                    toggleLoader(false);
                    event.target.value = ''; 
                }
            };
            reader.readAsText(file);
        };
        const applyFilters = () => {
            const timeframe = dom['filter-timeframe'].value;
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const allTrades = getActiveTrades();
            const instrument = dom['filter-instrument'].value;
            const tag = dom['filter-tag'].value;
            const psychologyTag = dom['filter-psychology-tag'].value;
            const type = dom['filter-type'].value;
            const outcome = dom['filter-outcome'].value;
            const startDateString = dom['filter-start-date'].value;
            const endDateString = dom['filter-end-date'].value;

            const startDate = startDateString ? new Date(startDateString + 'T00:00:00') : null;
            const endDate = endDateString ? new Date(endDateString + 'T23:59:59') : null;

            let activeFilterCount = [instrument, tag, psychologyTag, type, outcome, startDateString, timeframe, endDateString].filter(Boolean).length;

            dom['filter-status'].classList.toggle('hidden', activeFilterCount === 0);
            if(activeFilterCount > 0) dom['filter-status'].textContent = `${activeFilterCount} filter(s) active. Dashboard stats reflect filtered data.`;

            return allTrades.filter(trade => {
                if (timeframe && trade.timeframe !== timeframe) return false;
                if (instrument && trade.indexName !== instrument) return false;
                if (tag && (!trade.tags || !trade.tags.includes(tag))) return false;
                if (psychologyTag && (!trade.psychologyTags || !trade.psychologyTags.includes(psychologyTag))) return false;
                if (type && trade.tradeType !== type) return false;
                if (outcome) {
                    const isWin = trade.profitLoss > breakevenThreshold;
                    const isLoss = trade.profitLoss <= 0;
                    const isBreakeven = trade.profitLoss > 0 && trade.profitLoss <= breakevenThreshold;
                    const isOpen = trade.profitLoss === null;
                    if (outcome === 'win' && !isWin) return false;
                    if (outcome === 'loss' && !isLoss) return false;
                    if (outcome === 'breakeven' && !isBreakeven) return false;
                    if (outcome === 'open' && !isOpen) return false;
                }
                const tradeDate = new Date(trade.timestamp);
                if (startDate && tradeDate < startDate) return false;
                if (endDate && tradeDate > endDate) return false;
                return true;
            });
        };
        const updateFilterDropdowns = () => {
            const allTrades = getActiveTrades();
            const timeframes = [...new Set(allTrades.map(t => t.timeframe).filter(Boolean))].sort();
            const instruments = [...new Set(allTrades.map(t => t.indexName))].sort();
            const tags = getActiveAccount().tags.map(t => t.name).sort();
            const psychologyTags = getActiveAccount().psychologyTags.map(t => t.name).sort();
            
            const updateSelect = (selectEl, options, label) => {
                const currentValue = selectEl.value;
                selectEl.innerHTML = `<option value="">All ${label}</option>`;
                options.forEach(opt => selectEl.innerHTML += `<option value="${opt}">${opt}</option>`);
                selectEl.value = currentValue;
            };
            updateSelect(dom['filter-timeframe'], timeframes, 'Timeframes');
            updateSelect(dom['filter-instrument'], instruments, 'Instruments');
            updateSelect(dom['filter-tag'], tags, 'Tags');
            updateSelect(dom['filter-psychology-tag'], psychologyTags, 'Psychology');
        };
        
        const setupTagManager = (tagType, modal, openBtn, closeBtn, addBtn, nameInput, colorInput, listContainer) => {
            openBtn.addEventListener('click', () => { renderTagList(listContainer, tagType); modal.classList.add('open'); });
            closeBtn.addEventListener('click', () => modal.classList.remove('open'));
            addBtn.addEventListener('click', () => {
                const newName = nameInput.value.trim();
                const newColor = colorInput.value;
                const activeAccount = getActiveAccount();
                const collection = activeAccount[tagType];
                if (newName && !collection.find(t => t.name === newName)) {
                    collection.push({ name: newName, color: newColor });
                    saveAppData();
                    renderTagList(listContainer, tagType);
                    renderChecklists();
                    nameInput.value = '';
                } else {
                    showToast(`Tag name cannot be empty or a duplicate.`, "error");
                }
            });
        };
        const renderTagList = (container, tagType) => {
             container.innerHTML = '';
             getActiveAccount()[tagType].forEach((item, index) => {
                 const div = document.createElement('div');
                 div.className = 'flex items-center justify-between p-2 bg-tertiary rounded-md';
                 div.innerHTML = `<div class="flex items-center gap-2">
                                     <span class="w-4 h-4 rounded-full" style="background-color: ${item.color};"></span>
                                     <span class="font-semibold">${item.name}</span>
                                 </div>
                                <button class="delete-item-btn p-1 text-text-secondary hover:text-red-500" data-index="${index}" data-type="${tagType}">Delete</button>`;
                 container.appendChild(div);
             });
             container.querySelectorAll('.delete-item-btn').forEach(btn => btn.addEventListener('click', e => {
                const {index, type} = e.currentTarget.dataset;
                getActiveAccount()[type].splice(index, 1);
                saveAppData();
                renderTagList(container, type);
                renderChecklists();
             }));
        };

        const renderChecklists = (selectedTags = [], selectedPsychologyTags = []) => {
    // --- START FIX ---
    // Preserve the current state of checked tags if none are explicitly passed.
    // This happens during a general UI refresh, like a theme change.
    let tagsToKeepChecked = selectedTags;
    if (tagsToKeepChecked.length === 0 && dom['tags-checklist'].innerHTML !== '') {
        tagsToKeepChecked = Array.from(dom['tags-checklist'].querySelectorAll('input:checked')).map(cb => cb.value);
    }

    let psychTagsToKeepChecked = selectedPsychologyTags;
    if (psychTagsToKeepChecked.length === 0 && dom['psychology-tags-checklist'].innerHTML !== '') {
        psychTagsToKeepChecked = Array.from(dom['psychology-tags-checklist'].querySelectorAll('input:checked')).map(cb => cb.value);
    }
    // --- END FIX ---

    // Pass the preserved state to the rendering helper function
    renderAChecklist(dom['tags-checklist'], getActiveAccount().tags, tagsToKeepChecked, 'Manage Tags');
    renderAChecklist(dom['psychology-tags-checklist'], getActiveAccount().psychologyTags, psychTagsToKeepChecked, 'Manage Psychology Tags');
};

        const renderAChecklist = (container, tags, selected, manageText) => { 
            container.innerHTML = '';
            if (tags.length === 0) { 
                container.innerHTML = `<p class="text-xs text-center text-text-secondary">No tags. Click "${manageText}".</p>`; 
                return; 
            }
            tags.forEach(tag => {
                const isChecked = selected.includes(tag.name);
                container.innerHTML += `
                    <div class="flex items-center">
                        <input type="checkbox" id="tag-${tag.name.replace(/\s+/g, '-')}" value="${tag.name}" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-accent-color bg-tertiary border-border-color rounded focus:ring-accent-color ring-offset-bg-secondary focus:ring-2">
                        <label for="tag-${tag.name.replace(/\s+/g, '-')}" class="ml-2 text-sm font-medium">${tag.name}</label>
                    </div>`;
            });
        };
        
        const updateAccountGrowth = (allTrades) => { 
            const totalPL = allTrades.filter(t => t.profitLoss !== null).reduce((acc, trade) => acc + trade.profitLoss, 0);
            const balance = getActiveAccount().startingBalance;
            if (balance === null || isNaN(balance)) {
                dom['account-growth'].textContent = '-';
                dom['current-balance'].textContent = 'Set starting balance...';
                return;
            }
            const currentValue = balance + totalPL;
            const growth = balance > 0 ? ((currentValue - balance) / balance) * 100 : (currentValue > 0 ? 100 : 0);
            dom['account-growth'].textContent = `${growth.toFixed(2)}%`;
            dom['account-growth'].className = `text-3xl font-bold ${growth >= 0 ? 'text-green-500' : 'text-red-500'}`;
            dom['current-balance'].textContent = `$${currentValue.toFixed(2)}`;
        };

        const handleSaveGoal = () => {
            const editingId = dom['editing-goal-id'].value;
            const title = dom['goal-title'].value.trim();
            const metric = dom['goal-metric'].value;
            const target = parseFloat(dom['goal-target'].value);
            const timeframe = dom['goal-timeframe'].value;

            if (!title || isNaN(target)) {
                showToast('Please fill out all goal fields correctly.', 'error');
                return;
            }

            const activeAccount = getActiveAccount();
            const goals = activeAccount.goals;

            if (editingId) {
                const goalIndex = goals.findIndex(g => g.id === editingId);
                if(goalIndex > -1) {
                    goals[goalIndex] = { ...goals[goalIndex], title, metric, target, timeframe };
                    showToast('Goal updated!', 'success');
                }
            } else {
                const newGoal = { id: crypto.randomUUID(), title, metric, target, timeframe, createdAt: new Date().toISOString() };
                goals.push(newGoal);
                showToast('Goal added!', 'success');
            }
            
            saveAppData();
            updateGoals();
            resetGoalForm();
        };

        const resetGoalForm = () => {
            dom['add-goal-form'].reset();
            dom['editing-goal-id'].value = '';
            dom['goal-form-title'].textContent = 'Add New Goal';
            dom['add-goal-btn'].textContent = 'Add Goal';
            dom['cancel-goal-edit-btn'].classList.add('hidden');
        };

        const enterGoalEditMode = (goalId) => {
            const goals = getActiveAccount().goals;
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            dom['goal-form-title'].textContent = 'Edit Goal';
            dom['add-goal-btn'].textContent = 'Save Changes';
            dom['cancel-goal-edit-btn'].classList.remove('hidden');
            
            dom['editing-goal-id'].value = goal.id;
            dom['goal-title'].value = goal.title;
            dom['goal-metric'].value = goal.metric;
            dom['goal-target'].value = goal.target;
            dom['goal-timeframe'].value = goal.timeframe;

            dom['add-goal-form'].scrollIntoView({ behavior: 'smooth' });
        };


        const updateGoals = () => {
            const goalsList = dom['goals-list'];
            goalsList.innerHTML = '';
            const goals = getActiveAccount().goals;
            const trades = getActiveTrades();

            if (goals.length === 0) {
                goalsList.innerHTML = '<p class="text-center text-text-secondary">No active goals. Add one to get started!</p>';
                return;
            }

            goals.forEach(goal => {
                const { currentValue } = calculateGoalProgress(goal, trades);
                const progress = goal.target !== 0 ? Math.min(100, (currentValue / goal.target) * 100) : (currentValue > 0 ? 100 : 0);
                const progressColor = progress >= 80 ? 'bg-green-500' : progress >= 40 ? 'bg-yellow-500' : 'bg-red-500';

                const goalEl = document.createElement('div');
                goalEl.className = 'bg-tertiary/50 p-4 rounded-lg border border-border-color';
                goalEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-text-primary">${goal.title}</h3>
                            <p class="text-xs text-text-secondary">${goal.timeframe.charAt(0).toUpperCase() + goal.timeframe.slice(1)} Goal</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-goal-btn text-text-secondary hover:text-accent-color" data-id="${goal.id}">Edit</button>
                            <button class="delete-goal-btn text-text-secondary hover:text-red-500" data-id="${goal.id}">&times;</button>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-text-secondary">Progress</span>
                        <span class="font-semibold text-text-primary">${currentValue.toFixed(2)} / ${goal.target}</span>
                    </div>
                    <div class="w-full bg-bg-tertiary rounded-full h-2.5">
                        <div class="${progressColor} h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                `;
                goalsList.appendChild(goalEl);
            });

            goalsList.querySelectorAll('.delete-goal-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const goalId = e.currentTarget.dataset.id;
                    const goals = getActiveAccount().goals;
                    const index = goals.findIndex(g => g.id === goalId);
                    if (index > -1) {
                        goals.splice(index, 1);
                        saveAppData();
                        updateGoals();
                        showToast('Goal removed.', 'info');
                    }
                });
            });

            goalsList.querySelectorAll('.edit-goal-btn').forEach(btn => {
                btn.addEventListener('click', e => enterGoalEditMode(e.currentTarget.dataset.id));
            });
        };

        const calculateGoalProgress = (goal, allTrades) => {
            const now = new Date();
            let startDate;

            if (goal.timeframe === 'week') {
                startDate = new Date(now);
                startDate.setDate(now.getDate() - now.getDay());
                startDate.setHours(0,0,0,0);
            } else if (goal.timeframe === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else { // year
                startDate = new Date(now.getFullYear(), 0, 1);
            }

            const tradesForPeriod = allTrades.filter(t => new Date(t.timestamp) >= startDate && t.profitLoss !== null);
            let currentValue = 0;

            if (tradesForPeriod.length > 0) {
                if (goal.metric === 'totalPL') {
                    currentValue = tradesForPeriod.reduce((acc, t) => acc + t.profitLoss, 0);
                } else {
                    const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
                    const winningTrades = tradesForPeriod.filter(t => t.profitLoss > breakevenThreshold);
                    const losingTrades = tradesForPeriod.filter(t => t.profitLoss <= 0);
                    if (goal.metric === 'winRate') {
                        const countable = winningTrades.length + losingTrades.length;
                        currentValue = countable > 0 ? (winningTrades.length / countable) * 100 : 0;
                    } else if (goal.metric === 'profitFactor') {
                        const grossProfit = winningTrades.reduce((acc, t) => acc + t.profitLoss, 0);
                        const grossLoss = Math.abs(losingTrades.reduce((acc, t) => acc + t.profitLoss, 0));
                        currentValue = grossLoss > 0 ? grossProfit / grossLoss : Infinity;
                    }
                }
            }
            return { currentValue, tradesForPeriod };
        };

        const updateDrawdownAnalysis = (allTrades) => {
            const closedTrades = allTrades.filter(t => t.profitLoss !== null).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const initialBalance = getActiveAccount().startingBalance || 0;

            let maxDrawdownUSD = 0;
            let maxDrawdownPct = 0;
            let peakEquity = initialBalance;
            let longestDrawdownDays = 0;
            let currentDrawdownStart = null;
            const drawdownData = [];

            let cumulativeEquity = initialBalance;

            closedTrades.forEach(trade => {
                cumulativeEquity += trade.profitLoss;
                if (cumulativeEquity > peakEquity) {
                    peakEquity = cumulativeEquity;
                    if (currentDrawdownStart) {
                        const drawdownEnd = new Date(trade.timestamp);
                        const duration = (drawdownEnd - currentDrawdownStart) / (1000 * 60 * 60 * 24);
                        if (duration > longestDrawdownDays) {
                            longestDrawdownDays = duration;
                        }
                        currentDrawdownStart = null;
                    }
                }

                const drawdown = peakEquity - cumulativeEquity;
                if (drawdown > maxDrawdownUSD) {
                    maxDrawdownUSD = drawdown;
                }
                
                const drawdownPct = peakEquity > 0 ? (drawdown / peakEquity) * 100 : 0;
                if (drawdownPct > maxDrawdownPct) {
                    maxDrawdownPct = drawdownPct;
                }

                if (drawdown > 0 && !currentDrawdownStart) {
                    currentDrawdownStart = new Date(trade.timestamp);
                }

                drawdownData.push({ x: new Date(trade.timestamp), y: -drawdownPct });
            });

            dom['max-drawdown-usd'].textContent = `$${maxDrawdownUSD.toFixed(2)}`;
            dom['max-drawdown-pct'].textContent = `${maxDrawdownPct.toFixed(2)}%`;
            dom['longest-drawdown-period'].textContent = `${Math.ceil(longestDrawdownDays)} days`;

            const chartOptions = getChartColors();
            if (drawdownChart) drawdownChart.destroy();
            drawdownChart = new Chart(dom.drawdownChart, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Drawdown (%)',
                        data: drawdownData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } },
                        y: { beginAtZero: false, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor, callback: (value) => `${-value.toFixed(1)}%` } }
                    },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `Drawdown: ${-ctx.raw.y.toFixed(2)}%` } } }
                }
            });
       return { maxDrawdownUSD };
 };
const updateEquityCurveChart = (allTrades) => {
    const canvas = document.getElementById('equityCurveChart');
    if (!canvas) return;

    const closedTrades = allTrades
        .filter(t => t.profitLoss !== null)
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    if (equityCurveChart) {
        equityCurveChart.destroy();
    }
    
    if (closedTrades.length < 2) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.textAlign = 'center';
        ctx.fillStyle = getChartColors().textColor;
        ctx.fillText('At least 2 closed trades are needed to render the equity curve.', canvas.width / 2, canvas.height / 2);
        ctx.restore();
        return;
    }

    const initialBalance = getActiveAccount().startingBalance || 0;
    let cumulativeEquity = initialBalance;
    let highWaterMark = initialBalance;

    const chartData = {
        equity: [{ x: new Date(closedTrades[0].timestamp).getTime() - 86400000, y: initialBalance }], // Start one day before first trade
        hwm: [{ x: new Date(closedTrades[0].timestamp).getTime() - 86400000, y: initialBalance }],
        winPoints: [],
        lossPoints: []
    };

    closedTrades.forEach(trade => {
        const tradeDate = new Date(trade.timestamp).getTime();
        const prevEquity = cumulativeEquity;
        cumulativeEquity += trade.profitLoss;
        
        if (cumulativeEquity > highWaterMark) {
            highWaterMark = cumulativeEquity;
        }

        chartData.equity.push({ x: tradeDate, y: cumulativeEquity, trade: trade });
        chartData.hwm.push({ x: tradeDate, y: highWaterMark });
        
        if (trade.profitLoss > (appData.settings.breakevenThreshold || 2.0)) {
            chartData.winPoints.push({ x: tradeDate, y: cumulativeEquity, trade: trade });
        } else if (trade.profitLoss <= 0) {
            chartData.lossPoints.push({ x: tradeDate, y: cumulativeEquity, trade: trade });
        }
    });

    const chartColors = getChartColors();
    const drawdownGradient = canvas.getContext('2d').createLinearGradient(0, 0, 0, 400);
    drawdownGradient.addColorStop(0, 'rgba(239, 68, 68, 0.4)');
    drawdownGradient.addColorStop(1, 'rgba(239, 68, 68, 0)');

    equityCurveChart = new Chart(canvas, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'High-Water Mark',
                    data: chartData.hwm,
                    borderColor: chartColors.gridColor,
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [5, 5],
                    fill: false,
                    order: 1,
                },
                {
                    label: 'Equity',
                    data: chartData.equity,
                    borderColor: 'var(--accent-color)',
                    backgroundColor: drawdownGradient,
                    borderWidth: 2.5,
                    pointRadius: 0,
                    tension: 0.4, // For smooth curves
                    fill: {
                        target: 0, // Fill between equity line and HWM
                        above: 'rgba(79, 70, 229, 0.05)', // Optional fill for growth periods
                        below: drawdownGradient // Fill for drawdown periods
                    },
                    order: 2
                },
                {
                    label: 'Winning Trades',
                    data: chartData.winPoints,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgba(255, 255, 255, 0.5)',
                    borderWidth: 1,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    type: 'bubble',
                    order: 0,
                },
                {
                    label: 'Losing Trades',
                    data: chartData.lossPoints,
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgba(255, 255, 255, 0.5)',
                    borderWidth: 1,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    type: 'bubble',
                    order: 0,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                        mode: 'nearest',
                        intersect: true,
                        axis: 'x'
                    },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day' },
                    grid: { color: 'transparent' },
                    ticks: { color: chartColors.textColor }
                },
                y: {
                    beginAtZero: false,
                    grid: { color: chartColors.gridColor },
                    ticks: { 
                        color: chartColors.textColor,
                        callback: (value) => `$${value.toLocaleString()}`
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: (context) => new Date(context[0].parsed.x).toLocaleDateString(),
                        label: (context) => {
                            const point = context.dataset.data[context.dataIndex];
                            if (point.trade) { // This is a win/loss point
                                const { tradeType, indexName, profitLoss } = point.trade;
                                const outcome = profitLoss > 0 ? 'Win' : 'Loss';
                                return `${outcome}: $${profitLoss.toFixed(2)} (${tradeType} on ${indexName})`;
                            }
                            // This is the equity line or HWM
                            return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });

    // Add event listeners for the toggles
    document.getElementById('toggle-hwm').onchange = (e) => {
        equityCurveChart.setDatasetVisibility(0, e.target.checked); // Dataset 0 is HWM
        equityCurveChart.update();
    };
    document.getElementById('toggle-trades').onchange = (e) => {
        equityCurveChart.setDatasetVisibility(2, e.target.checked); // Dataset 2 is Wins
        equityCurveChart.setDatasetVisibility(3, e.target.checked); // Dataset 3 is Losses
        equityCurveChart.update();
    };
};        
        const handleSavePlay = () => {
             const editingId = dom['editing-play-id'].value;
             const title = dom['play-title'].value.trim();
             const instruments = Array.from(dom['play-instruments'].selectedOptions).map(opt => opt.value);
             const marketCondition = dom['play-market-condition'].value;
             const entryCriteria = dom['play-entry-criteria'].innerHTML;
             const slRules = dom['play-sl-rules'].innerHTML;
             const managementRules = dom['play-management-rules'].innerHTML;
             const confidence = document.querySelector('input[name="rating"]:checked')?.value || 0;
             const reviewNotes = dom['play-review-notes'].innerHTML;
             const beforeImage = dom['play-before-image'].querySelector('img')?.src || null;
             const afterImage = dom['play-after-image'].querySelector('img')?.src || null;
             
             if (!title) {
                 showToast('Play title is required.', 'error');
                 return;
             }
             
             const activeAccount = getActiveAccount();
             const playbook = activeAccount.playbook;

             if (editingId) {
                 const playIndex = playbook.findIndex(p => p.id === editingId);
                 if (playIndex > -1) {
                     playbook[playIndex] = { ...playbook[playIndex], title, instruments, marketCondition, entryCriteria, slRules, managementRules, confidence, reviewNotes, beforeImage, afterImage };
                     showToast('Play updated!', 'success');
                 }
             } else {
                 const newPlay = { id: crypto.randomUUID(), title, instruments, marketCondition, entryCriteria, slRules, managementRules, confidence, reviewNotes, beforeImage, afterImage };
                 playbook.push(newPlay);
                 showToast('New play added to your playbook!', 'success');
             }

             saveAppData();
             updatePlaybook();
             resetPlayForm();
             populatePlaybookSelect();
        };

        const resetPlayForm = () => {
             dom['editing-play-id'].value = '';
             dom['play-form-title'].textContent = 'Add New Play';
             dom['save-play-btn'].textContent = 'Save Play';
             dom['cancel-play-edit-btn'].classList.add('hidden');
             dom['play-title'].value = '';
             Array.from(dom['play-instruments'].options).forEach(opt => opt.selected = false);
             dom['play-market-condition'].value = 'Trending';
             dom['play-entry-criteria'].innerHTML = '';
             dom['play-sl-rules'].innerHTML = '';
             dom['play-management-rules'].innerHTML = '';
             dom['play-review-notes'].innerHTML = '';
             document.querySelectorAll('input[name="rating"]').forEach(radio => radio.checked = false);
             dom['play-before-image'].innerHTML = 'Click or Drag Image Here';
             dom['play-after-image'].innerHTML = 'Click or Drag Image Here';
        };

        const setupImageDropzone = (dropzoneId, fileInputId) => {
            const dropzone = dom[dropzoneId];
            const fileInput = dom[fileInputId];
            
            const handleFiles = (files) => {
                const file = files[0];
                if(file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        dropzone.innerHTML = `<img src="${e.target.result}" class="playbook-image object-contain h-full w-full">`;
                    };
                    reader.readAsDataURL(file);
                }
            }

            dropzone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        };

        const updatePlaybook = () => {
            const list = dom['playbook-list'];
            list.innerHTML = '';
            const playbook = getActiveAccount().playbook;
            const trades = getActiveTrades();
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

            if (playbook.length === 0) {
                list.innerHTML = '<p class="text-center text-text-secondary">Your playbook is empty. Add a new play to document your best setups!</p>';
                return;
            }

            playbook.forEach(play => {
                const linkedTrades = trades.filter(t => t.playId === play.id && t.profitLoss !== null);
                const wins = linkedTrades.filter(t => t.profitLoss > breakevenThreshold).length;
                const losses = linkedTrades.filter(t => t.profitLoss <= 0).length;
                const winRate = (wins + losses) > 0 ? (wins / (wins + losses)) * 100 : 0;
                const totalPL = linkedTrades.reduce((acc, t) => acc + t.profitLoss, 0);

                const starHtml = Array(5).fill(0).map((_, i) => `<span class="${i < play.confidence ? 'text-yellow-400' : 'text-gray-600'}"></span>`).join('');

                const playEl = document.createElement('div');
                playEl.className = 'bg-tertiary/50 p-4 rounded-lg border border-border-color';
                playEl.innerHTML = `
                      <div class="flex justify-between items-start mb-2">
                          <div>
                              <h3 class="font-bold text-xl text-text-primary">${play.title}</h3>
                              <div class="text-2xl">${starHtml}</div>
                          </div>
                          <div class="flex gap-2">
                            <button class="view-play-btn text-text-secondary hover:text-accent-color" data-id="${play.id}">View</button>
                             <button class="edit-play-btn text-text-secondary hover:text-accent-color" data-id="${play.id}">Edit</button>
                             <button class="delete-play-btn text-text-secondary hover:text-red-500" data-id="${play.id}">Delete</button>
                          </div>
                      </div>
                      <div class="grid grid-cols-3 gap-2 text-center text-sm mb-4">
                          <div class="bg-bg-tertiary p-2 rounded">
                              <p class="text-xs text-text-secondary">Win Rate</p>
                              <p class="font-bold text-lg">${winRate.toFixed(1)}%</p>
                          </div>
                          <div class="bg-bg-tertiary p-2 rounded">
                              <p class="text-xs text-text-secondary">Total P/L</p>
                              <p class="font-bold text-lg ${totalPL >= 0 ? 'text-green-500' : 'text-red-500'}">$${totalPL.toFixed(2)}</p>
                          </div>
                           <div class="bg-bg-tertiary p-2 rounded">
                              <p class="text-xs text-text-secondary">Trades</p>
                              <p class="font-bold text-lg">${linkedTrades.length}</p>
                          </div>
                      </div>
                      <div class="details-row">
                          <div class="details-content prose prose-invert max-w-none prose-sm">
                              <h4>Entry Criteria</h4>
                              <div>${play.entryCriteria}</div>
                              <h4>Stop Loss Rules</h4>
                              <div>${play.slRules}</div>
                              <h4>Trade Management</h4>
                              <div>${play.managementRules}</div>
                              <h4>Review Notes</h4>
                              <div>${play.reviewNotes}</div>
                              <div class="grid grid-cols-2 gap-4 mt-4">
                                  <div>
                                      <h4>Before</h4>
                                      ${play.beforeImage ? `<img src="${play.beforeImage}" class="playbook-image">` : '<p>No image</p>'}
                                  </div>
                                  <div>
                                      <h4>After</h4>
                                      ${play.afterImage ? `<img src="${play.afterImage}" class="playbook-image">` : '<p>No image</p>'}
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
                list.appendChild(playEl);
            });
            
            list.querySelectorAll('.delete-play-btn').forEach(btn => {
                btn.addEventListener('click', async e => {
                    const playId = e.currentTarget.dataset.id;
                    const confirmed = await showCustomModal({
                        title: 'Delete Play',
                        text: 'Are you sure you want to delete this play from your playbook?',
                        confirmText: 'Delete'
                    });
                    if (confirmed) {
                        const playbook = getActiveAccount().playbook;
                        const index = playbook.findIndex(p => p.id === playId);
                        if (index > -1) {
                            playbook.splice(index, 1);
                            saveAppData();
                            updatePlaybook();
                            populatePlaybookSelect();
                            showToast('Play removed from playbook.', 'info');
                        }
                    }
                });
            });
            list.querySelectorAll('.edit-play-btn').forEach(btn => btn.addEventListener('click', e => enterPlayEditMode(e.currentTarget.dataset.id)));
            list.querySelectorAll('.view-play-btn').forEach(btn => btn.addEventListener('click', e => e.currentTarget.closest('.p-4').querySelector('.details-row').classList.toggle('open')));
        };

        const enterPlayEditMode = (playId) => {
            const play = getActiveAccount().playbook.find(p => p.id === playId);
            if (!play) return;
            resetPlayForm();

            dom['editing-play-id'].value = play.id;
            dom['play-form-title'].textContent = 'Edit Play';
            dom['save-play-btn'].textContent = 'Save Changes';
            dom['cancel-play-edit-btn'].classList.remove('hidden');

            dom['play-title'].value = play.title;
            Array.from(dom['play-instruments'].options).forEach(opt => {
                if(play.instruments.includes(opt.value)) opt.selected = true;
            });
            dom['play-market-condition'].value = play.marketCondition;
            dom['play-entry-criteria'].innerHTML = play.entryCriteria;
            dom['play-sl-rules'].innerHTML = play.slRules;
            dom['play-management-rules'].innerHTML = play.managementRules;
            dom['play-review-notes'].innerHTML = play.reviewNotes;
            if (play.confidence > 0) document.getElementById(`star${play.confidence}`).checked = true;
            if (play.beforeImage) dom['play-before-image'].innerHTML = `<img src="${play.beforeImage}" class="playbook-image object-contain h-full w-full">`;
            if (play.afterImage) dom['play-after-image'].innerHTML = `<img src="${play.afterImage}" class="playbook-image object-contain h-full w-full">`;
            
            dom['play-form-title'].scrollIntoView({ behavior: 'smooth' });
        };


        const populatePlaybookSelect = () => {
            const select = dom['playbook-select'];
            const currentVal = select.value;
            select.innerHTML = '<option value="">None</option>';
            const activeAccount = getActiveAccount();
            if (activeAccount && activeAccount.playbook) {
                activeAccount.playbook.forEach(play => {
                    select.innerHTML += `<option value="${play.id}">${play.title}</option>`;
                });
            }
            select.value = currentVal;
        };
        
        const applyAccentColor = (color) => {
            document.documentElement.style.setProperty('--accent-color', color);
            dom['accent-color-picker'].value = color;
            refreshUI(); // Redraw charts with new color
        };
        const setTradeTypeUI = (type) => {
            tradeType = type;
            if (type === 'Buy') {
                dom['buy-btn'].className = 'trade-type-btn bg-blue-500 text-white p-2 rounded-lg btn';
                dom['sell-btn'].className = 'trade-type-btn bg-tertiary text-text-secondary p-2 rounded-lg btn';
            } else {
                dom['sell-btn'].className = 'trade-type-btn bg-red-500 text-white p-2 rounded-lg btn';
                dom['buy-btn'].className = 'trade-type-btn bg-tertiary text-text-secondary p-2 rounded-lg btn';
            }
            updateRealtimePL();
        };
        // ===== REPLACE THE OLD getPipMultiplier WITH THIS NEW VERSION =====

        // REPLACE your old getPipMultiplier function with this one
const getPipMultiplier = (instrument, entryPrice) => {
    if (!instrument) return 1;

    // --- Forex Pairs ---
    if (instrument.includes('/')) { 
        // JPY pairs have 2 decimal pips, others have 4.
        return instrument.includes('JPY') ? 0.01 : 0.0001;
    }
    
    // --- NEW: Handle DEX Indices specifically ---
    if (instrument.includes('DEX')) {
        // DEX indices have 3 decimal places for their point value.
        return 0.001;
    }
            
    // --- NEW: Smarter logic for Volatility Indices ---
    // Instead of guessing, we check the actual decimal places of the entry price.
    if (instrument.startsWith('Volatility')) {
        const priceStr = (entryPrice || 0).toString();
        if (priceStr.includes('.')) {
            const decimalPlaces = priceStr.split('.')[1].length;
            // If it has 2 or more decimals, the multiplier is 0.01. Otherwise, it's 1.
            return decimalPlaces >= 2 ? 0.01 : 1;
        }
        // If no decimal point, it's a whole number index.
        return 1;
    }

    // --- Default for everything else (Crash, Boom, Gold, US 500, etc.) ---
    // For these, 1 point of movement = a price change of 1.
    return 1;
};

       // REPLACE this function
const calculatePipsFromPrice = (type) => {
    const entryPrice = parseFloat(dom['entry-price'].value);
    const levelPrice = parseFloat(dom[type === 'sl' ? 'stop-loss' : 'take-profit'].value);
    const instrument = dom['index-selector'].value;

    if (isNaN(entryPrice) || isNaN(levelPrice)) {
        if (isNaN(levelPrice)) dom[`${type}-pips`].value = '';
        return;
    }

    // This is the updated line
    const multiplier = getPipMultiplier(instrument, entryPrice);
    if (multiplier === 0) return;

    const priceDiff = Math.abs(entryPrice - levelPrice);
    const pips = priceDiff / multiplier;

    dom[`${type}-pips`].value = pips.toFixed(1);
};

        const clearPipInputs = () => {
            dom['sl-pips'].value = '';
            dom['tp-pips'].value = '';
        };

        // REPLACE this function
const calculatePriceFromPips = (type) => {
    const entryPrice = parseFloat(dom['entry-price'].value);
    const pips = parseFloat(dom[`${type}-pips`].value);
    const instrument = dom['index-selector'].value;

    const priceInput = dom[type === 'sl' ? 'stop-loss' : 'take-profit'];

    if (isNaN(entryPrice) || isNaN(pips)) {
        if (isNaN(pips)) priceInput.value = '';
        return;
    }

    // This is the updated line
    const multiplier = getPipMultiplier(instrument, entryPrice);
    const priceChange = pips * multiplier;
    let finalPrice;

    if (type === 'sl') {
        finalPrice = tradeType === 'Buy' ? entryPrice - priceChange : entryPrice + priceChange;
    } else { // 'tp'
        finalPrice = tradeType === 'Buy' ? entryPrice + priceChange : entryPrice - priceChange;
    }
    
    const decimalPlaces = (entryPrice.toString().split('.')[1] || '').length;
    priceInput.value = finalPrice.toFixed(decimalPlaces);
};

       const updateRiskConsistencyTracker = (allTrades) => {
    // 1. Filter for trades that have a valid numeric Stop Loss and Entry
    const riskTrades = allTrades
        .filter(t => {
            const hasSL = t.stopLoss !== null && t.stopLoss !== '' && !isNaN(parseFloat(t.stopLoss));
            const hasEntry = t.entryPrice !== null && t.entryPrice !== '' && !isNaN(parseFloat(t.entryPrice));
            return hasSL && hasEntry;
        })
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    // 2. Destroy previous chart instance
    if (riskConsistencyChart) {
        riskConsistencyChart.destroy();
        riskConsistencyChart = null;
    }
    
    const canvas = document.getElementById('riskConsistencyChart');
    if (!canvas) return;

    // 3. If not enough data, clear canvas and exit
    if (riskTrades.length < 2) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }

    // 4. Calculate Risk Data
    const riskData = riskTrades.map(trade => {
        const { profit } = calculatePL(
            trade.tradeType, 
            parseFloat(trade.lotSize), 
            parseFloat(trade.entryPrice), 
            parseFloat(trade.stopLoss), 
            trade.indexName
        );
        
        // Handle potential calculation errors safely
        const riskAmount = (profit !== null && !isNaN(profit)) ? Math.abs(profit) : 0;
        return { x: new Date(trade.timestamp), y: riskAmount };
    });

    // 5. Calculate Average Risk Line
    const totalRisk = riskData.reduce((acc, data) => acc + data.y, 0);
    const avgRisk = riskData.length > 0 ? totalRisk / riskData.length : 0;

    // 6. Render Chart
    const chartOptions = getChartColors();
    riskConsistencyChart = new Chart(canvas, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Risk per Trade ($)',
                data: riskData,
                borderColor: 'rgba(234, 179, 8, 0.8)', // Amber color
                backgroundColor: 'rgba(234, 179, 8, 0.1)',
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5,
                tension: 0.2
            }, {
                label: 'Average Risk ($)',
                data: riskData.map(d => ({ x: d.x, y: avgRisk })),
                borderColor: document.documentElement.classList.contains('light') ? 'rgba(0, 0, 0, 0.5)' : 'rgba(255, 255, 255, 0.5)',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { 
                    type: 'time', 
                    time: { unit: 'day' }, 
                    grid: { color: chartOptions.gridColor }, 
                    ticks: { color: chartOptions.textColor } 
                },
                y: { 
                    beginAtZero: true, 
                    grid: { color: chartOptions.gridColor }, 
                    ticks: { color: chartOptions.textColor, callback: (value) => `$${value.toFixed(0)}` } 
                }
            },
            plugins: { 
                legend: { display: true, labels: { color: chartOptions.textColor } },
                tooltip: { 
                    callbacks: { 
                        label: (ctx) => `${ctx.dataset.label}: $${ctx.raw.y.toFixed(2)}` 
                    } 
                }
            }
        }
    });
};

        const updateRRPerformanceAnalysis = (allTrades) => {
            const body = dom['rr-performance-body'];
            body.innerHTML = '';
            const rrTrades = allTrades.filter(t => t.rrRatio !== null && t.rrRatio > 0 && t.profitLoss !== null);

            if (rrTrades.length === 0) {
                body.innerHTML = '<p class="text-center text-text-secondary">No trades with planned R:R to analyze.</p>';
                return;
            }

            const rrBuckets = {
                'Under 1R': { trades: 0, wins: 0, totalPL: 0 },
                '1R - 1.9R': { trades: 0, wins: 0, totalPL: 0 },
                '2R - 2.9R': { trades: 0, wins: 0, totalPL: 0 },
                '3R+': { trades: 0, wins: 0, totalPL: 0 }
            };

            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

            rrTrades.forEach(trade => {
                let bucket;
                if (trade.rrRatio < 1) bucket = 'Under 1R';
                else if (trade.rrRatio < 2) bucket = '1R - 1.9R';
                else if (trade.rrRatio < 3) bucket = '2R - 2.9R';
                else bucket = '3R+';

                rrBuckets[bucket].trades++;
                rrBuckets[bucket].totalPL += trade.profitLoss;
                if (trade.profitLoss > breakevenThreshold) {
                    rrBuckets[bucket].wins++;
                }
            });

            const fragment = document.createDocumentFragment();
            for (const [bucketName, stats] of Object.entries(rrBuckets)) {
                if (stats.trades === 0) continue;

                const winRate = (stats.trades > 0 ? (stats.wins / stats.trades) * 100 : 0).toFixed(1);
                const plClass = stats.totalPL >= 0 ? 'text-green-500' : 'text-red-500';

                const bucketEl = document.createElement('div');
                bucketEl.className = 'grid grid-cols-4 items-center bg-tertiary/50 p-3 rounded-lg text-sm';
                bucketEl.innerHTML = `
                    <div class="font-bold text-text-primary col-span-1">${bucketName}</div>
                    <div class="text-center"><span class="font-semibold text-text-primary">${stats.trades}</span> <span class="text-text-secondary">trades</span></div>
                    <div class="text-center"><span class="font-semibold text-text-primary">${winRate}%</span> <span class="text-text-secondary">win rate</span></div>
                    <div class="text-right font-bold ${plClass}">$${stats.totalPL.toFixed(2)}</div>
                `;
                fragment.appendChild(bucketEl);
            }
            body.appendChild(fragment);
        };

        const updateAvgWinLossComparison = (allTrades) => {
            const container = dom['avg-win-loss-comparison'];
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const closedTrades = allTrades.filter(t => t.profitLoss !== null);
            
            const winningTrades = closedTrades.filter(t => t.profitLoss > breakevenThreshold);
            const losingTrades = closedTrades.filter(t => t.profitLoss <= 0);

            const avgWin = winningTrades.length > 0 ? winningTrades.reduce((sum, t) => sum + t.profitLoss, 0) / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? Math.abs(losingTrades.reduce((sum, t) => sum + t.profitLoss, 0) / losingTrades.length) : 0;

            if (avgWin === 0 && avgLoss === 0) {
                container.innerHTML = '<p class="text-center text-text-secondary">Not enough data to compare average win and loss.</p>';
                return;
            }
            
            const maxVal = Math.max(avgWin, avgLoss);
            const winPercentage = maxVal > 0 ? (avgWin / maxVal) * 100 : 0;
            const lossPercentage = maxVal > 0 ? (avgLoss / maxVal) * 100 : 0;

            container.innerHTML = `
                <div>
                    <div class="flex justify-between items-baseline mb-1">
                        <span class="text-sm font-medium text-green-400">Average Win</span>
                        <span class="text-lg font-bold text-green-400">$${avgWin.toFixed(2)}</span>
                    </div>
                    <div class="w-full bg-bg-tertiary rounded-full h-4">
                        <div class="bg-green-500 h-4 rounded-full" style="width: ${winPercentage}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-baseline mb-1">
                        <span class="text-sm font-medium text-red-400">Average Loss</span>
                        <span class="text-lg font-bold text-red-400">$${avgLoss.toFixed(2)}</span>
                    </div>
                    <div class="w-full bg-bg-tertiary rounded-full h-4">
                        <div class="bg-red-500 h-4 rounded-full" style="width: ${lossPercentage}%"></div>
                    </div>
                </div>
            `;
        };
// ====== PASTE THIS ENTIRE NEW FUNCTION AT THE END OF YOUR SCRIPT ======
        const initializeTradingViewWidget = () => {
            const container = dom['tradingview-widget-container'];
            if (!container || typeof TradingView === 'undefined') {
                return; // Exit if the container or TV library isn't ready
            }
            // Clear the container to prevent multiple charts from being created
            container.innerHTML = '';

            const isLightMode = document.documentElement.classList.contains('light');

            new TradingView.widget({
                "autosize": true,
                "symbol": "FX:EURUSD",
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": isLightMode ? "light" : "dark",
                "style": "1",
                "locale": "en",
                "enable_publishing": false, // You can set this back to false, it's not the cause
                "allow_symbol_change": true,
                "withdateranges": true,
                "hide_side_toolbar": false,
                "container_id": "tradingview-widget-container"
            });
        };
const updatePipAnalysis = (allTrades) => {
    const body = dom['pip-analysis-body'];
    if (!body) return;

    // Set UI controls based on saved settings
    const mode = appData.settings.pipAnalysisMode || 'strict';
    const tolerancePercent = appData.settings.pipAnalysisTolerance || 10;
    document.querySelector(`input[name="pip-analysis-mode"][value="${mode}"]`).checked = true;
    dom['pip-analysis-tolerance'].value = tolerancePercent;
    dom['pip-analysis-tolerance-value'].textContent = tolerancePercent;
    dom['pip-analysis-tolerance-container'].classList.toggle('hidden', mode !== 'flexible');

    const getPipMovement = (trade) => {
        if (!trade.exitPrice || !trade.entryPrice) return 0;
        let movement = Math.abs(trade.exitPrice - trade.entryPrice);
        if (trade.indexName.includes('/')) {
            movement *= (trade.indexName.includes('JPY') ? 100 : 10000);
        }
        return movement;
    };

    let tpHitTrades, slHitTrades;
    const closedTrades = allTrades.filter(t => t.exitPrice !== null);

    if (mode === 'strict') {
        tpHitTrades = closedTrades.filter(t => t.takeProfit !== null && t.takeProfit === t.exitPrice);
        slHitTrades = closedTrades.filter(t => t.stopLoss !== null && t.stopLoss === t.exitPrice);
    } else { // --- CORRECTED FLEXIBLE MODE LOGIC ---
        tpHitTrades = [];
        slHitTrades = [];

        for (const trade of closedTrades) {
            // A trade MUST have a defined SL for our flexible analysis to work,
            // as the tolerance is based on the initial risk distance.
            if (trade.stopLoss === null || trade.entryPrice === null) {
                continue; // Skip trades that cannot be analyzed this way.
            }
            
            const riskDistance = Math.abs(trade.entryPrice - trade.stopLoss);
            const tolerance = riskDistance * (tolerancePercent / 100);

            // Check if it's an SL hit
            if (Math.abs(trade.exitPrice - trade.stopLoss) <= tolerance) {
                slHitTrades.push(trade);
                continue; // It's an SL hit, so it can't be a TP hit. Move to the next trade.
            }
            
            // If it wasn't an SL hit, now check if it's a TP hit
            if (trade.takeProfit !== null && Math.abs(trade.exitPrice - trade.takeProfit) <= tolerance) {
                tpHitTrades.push(trade);
            }
        }
    }

    const avgTpPips = tpHitTrades.length > 0 ? tpHitTrades.reduce((sum, t) => sum + getPipMovement(t), 0) / tpHitTrades.length : 0;
    const avgSlPips = slHitTrades.length > 0 ? slHitTrades.reduce((sum, t) => sum + getPipMovement(t), 0) / slHitTrades.length : 0;

    if (tpHitTrades.length === 0 && slHitTrades.length === 0) {
        body.innerHTML = '<p class="text-center text-text-secondary">No trades match the current analysis mode. Try adjusting the filter or mode settings.</p>';
        return;
    }

    const maxValue = Math.max(avgTpPips, avgSlPips, 1);
    const tpBarWidth = (avgTpPips / maxValue) * 100;
    const slBarWidth = (avgSlPips / maxValue) * 100;

    body.innerHTML = `
        <div class="space-y-4">
            <div>
                <div class="flex justify-between items-baseline mb-1">
                    <span class="font-semibold text-green-400">TP-Hit Trades (${tpHitTrades.length})</span>
                    <span class="text-lg font-bold text-green-400">${avgTpPips.toFixed(1)} pips/pts</span>
                </div>
                <div class="w-full bg-bg-tertiary rounded-full h-5" title="Average Reward: ${avgTpPips.toFixed(1)} pips/pts">
                    <div class="h-5 rounded-full text-white text-xs font-bold flex items-center pl-2 pro-shadow" 
                         style="width: ${tpBarWidth}%; background-image: linear-gradient(to right, #4ade80, #16a34a);">
                        Avg. Reward
                    </div>
                </div>
            </div>
            <div>
                <div class="flex justify-between items-baseline mb-1">
                    <span class="font-semibold text-red-400">SL-Hit Trades (${slHitTrades.length})</span>
                    <span class="text-lg font-bold text-red-400">${avgSlPips.toFixed(1)} pips/pts</span>
                </div>
                <div class="w-full bg-bg-tertiary rounded-full h-5" title="Average Risk: ${avgSlPips.toFixed(1)} pips/pts">
                    <div class="h-5 rounded-full text-white text-xs font-bold flex items-center pl-2 pro-shadow" 
                         style="width: ${slBarWidth}%; background-image: linear-gradient(to right, #f87171, #dc2626);">
                        Avg. Risk
                    </div>
                </div>
            </div>
        </div>
    `;
}; 
// ====== PASTE THIS ENTIRE NEW FUNCTION INTO YOUR SCRIPT ======
const updateRiskOptimizationEngine = (allTrades, breakevenThreshold) => {
    const closedTrades = allTrades.filter(t => t.profitLoss !== null && t.stopLoss !== null && t.entryPrice !== null);

    if (closedTrades.length < 15) {
        return ''; // Not enough data for a meaningful analysis
    }

    let recommendationsHTML = '';

    // --- 1. STOP LOSS ANALYSIS (MAE) ---
    const winningTrades = closedTrades.filter(t => t.profitLoss > breakevenThreshold && t.maePrice !== null);
    if (winningTrades.length > 5) {
        let totalRiskEfficiency = 0;
        winningTrades.forEach(trade => {
            const plannedRiskDistance = Math.abs(trade.entryPrice - trade.stopLoss);
            const maxDrawdownDistance = Math.abs(trade.entryPrice - trade.maePrice);
            if (plannedRiskDistance > 0) {
                totalRiskEfficiency += (maxDrawdownDistance / plannedRiskDistance) * 100;
            }
        });
        const avgRiskEfficiency = totalRiskEfficiency / winningTrades.length;

        if (avgRiskEfficiency > 75) {
            recommendationsHTML += `
                <div class="border-t border-border-color pt-4">
                    <h3 class="text-base font-bold text-yellow-400"> Stop Loss Recommendation: Consider Widening Stops</h3>
                    <p class="text-sm text-text-secondary mt-1">
                        <strong>The Data:</strong> On your winning trades, you are experiencing an average drawdown of **${avgRiskEfficiency.toFixed(0)}%** of your planned risk. This means your good trades are frequently coming close to being stopped out.
                    </p>
                    <p class="text-sm text-text-secondary mt-2">
                        <strong>Actionable Advice:</strong> Try widening your stop loss by 10-15% or placing it more definitively behind a recent swing high/low. This may prevent you from being "shaken out" of otherwise profitable trades.
                    </p>
                </div>`;
        } else if (avgRiskEfficiency < 30) {
             recommendationsHTML += `
                <div class="border-t border-border-color pt-4">
                    <h3 class="text-base font-bold text-yellow-400"> Stop Loss Recommendation: Consider Tighter Stops</h3>
                    <p class="text-sm text-text-secondary mt-1">
                        <strong>The Data:</strong> Your winning trades experience very little drawdown, averaging only **${avgRiskEfficiency.toFixed(0)}%** of your planned risk. You are consistently over-estimating the room your trades need.
                    </p>
                    <p class="text-sm text-text-secondary mt-2">
                        <strong>Actionable Advice:</strong> A tighter stop loss would increase your R:R ratio and make your capital more efficient. Look for opportunities to place your stop closer to your entry structure.
                    </p>
                </div>`;
        }
    }

    // --- 2. TAKE PROFIT ANALYSIS (MFE) ---
    const winningTradesWithMFE = closedTrades.filter(t => t.profitLoss > breakevenThreshold && t.peakPrice !== null);
    if (winningTradesWithMFE.length > 5) {
        let totalUnrealizedGains = 0;
        let totalActualProfit = 0;

        winningTradesWithMFE.forEach(trade => {
            const peakProfit = calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.peakPrice, trade.indexName).profit || 0;
            if (peakProfit > trade.profitLoss) {
                totalUnrealizedGains += (peakProfit - trade.profitLoss);
            }
            totalActualProfit += trade.profitLoss;
        });

        if (totalActualProfit > 0) {
            const unrealizedPercentage = (totalUnrealizedGains / totalActualProfit) * 100;
            if (unrealizedPercentage > 25) { // If more than 25% of profit is being left on the table
                 recommendationsHTML += `
                <div class="border-t border-border-color pt-4">
                    <h3 class="text-base font-bold text-yellow-400"> Target Recommendation: Consider Increasing Targets</h3>
                    <p class="text-sm text-text-secondary mt-1">
                        <strong>The Data:</strong> Your winning trades run for an additional **${unrealizedPercentage.toFixed(0)}%** in profit, on average, after you have already exited. You are leaving significant money on the table.
                    </p>
                    <p class="text-sm text-text-secondary mt-2">
                        <strong>Actionable Advice:</strong> Consider using a multi-target strategy: secure partial profit at your original target, then let the rest of the position run with a trailing stop or to a higher structural level.
                    </p>
                </div>`;
            }
        }
    }
    
    // --- 3. AMBITIOUS TARGET ANALYSIS (REVERSALS) ---
    const reversedTrades = closedTrades.filter(t => t.profitLoss <= breakevenThreshold && t.peakPrice !== null);
    if (reversedTrades.length > 5) {
        let slippedProfit = 0;
        let reversedCount = 0;
        reversedTrades.forEach(trade => {
            const peakProfit = calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.peakPrice, trade.indexName).profit || 0;
            const initialRisk = Math.abs(calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.stopLoss, trade.indexName).profit || 1);

            // A "significant" reversal is one where the trade reached at least 1R in profit
            if (peakProfit > initialRisk) {
                reversedCount++;
                slippedProfit += peakProfit - (trade.profitLoss > 0 ? trade.profitLoss : 0);
            }
        });
        
        if (reversedCount > 0 && (reversedCount / closedTrades.filter(t=>t.profitLoss <= breakevenThreshold).length) > 0.20) { // If >20% of losers were once winners
             recommendationsHTML += `
                <div class="border-t border-border-color pt-4">
                    <h3 class="text-base font-bold text-yellow-400"> Target Recommendation: Consider Securing Profits Sooner</h3>
                    <p class="text-sm text-text-secondary mt-1">
                        <strong>The Data:</strong> **${reversedCount}** of your losing/breakeven trades were once in profit by at least 1R before reversing. This has cost you **\$${slippedProfit.toFixed(2)}** in potential gains.
                    </p>
                    <p class="text-sm text-text-secondary mt-2">
                        <strong>Actionable Advice:</strong> Your targets may be too ambitious for current market conditions. Implement a mandatory rule to move your stop loss to breakeven once a trade hits 1R. This will protect your capital from turning winners into losers.
                    </p>
                </div>`;
        }
    }


    if (recommendationsHTML !== '') {
        return `
            <div class="border-t border-border-color pt-4">
                 <h2 class="text-xl font-semibold mb-2 text-text-primary flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-accent-color" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3m6-9h3m-18 0h3m12.364 6.364l-1.414 1.414M6.343 6.343l-1.414 1.414m12.728 0l-1.414-1.414M6.343 17.657l-1.414-1.414M12 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span>Risk & Target Optimization</span>
                </h2>
                <div class="space-y-4">${recommendationsHTML}</div>
            </div>`;
    }

    return ''; // Return empty string if no specific recommendations are triggered
};
// --- EXPOSE FUNCTIONS TO HTML (REQUIRED) ---
window.toggleTradeSelection = toggleTradeSelection;
window.toggleSelectAll = toggleSelectAll;
window.deselectAllTrades = deselectAllTrades;
window.openBulkEditModal = openBulkEditModal;
window.closeBulkEditModal = closeBulkEditModal;
window.applyBulkEdit = applyBulkEdit;   
</script>
<div id="bulk-action-bar" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border-2 border-accent-color shadow-2xl rounded-full px-8 py-4 flex items-center gap-6 hidden z-[100] animate-fade-in text-gray-900 dark:text-white cursor-move">
    
    <span class="text-sm font-bold inherit"><span id="bulk-count">0</span> Selected</span>
    
    <div class="h-4 w-px bg-gray-300 dark:bg-gray-700"></div>
    
    <button onclick="openBulkEditModal()" class="text-sm font-bold text-accent-color hover:text-accent-color/80 transition-colors flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        Edit Selected
    </button>
    
    <button onclick="deselectAllTrades()" class="text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
</div>

<div id="bulk-edit-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-bg-secondary w-full max-w-lg rounded-xl shadow-2xl border border-border-color p-6 transform transition-all scale-100">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-text-primary">Bulk Edit Trades</h2>
            <button onclick="closeBulkEditModal()" class="text-text-secondary hover:text-text-primary"></button>
        </div>
        
        <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">
            <p class="text-xs text-yellow-500 bg-yellow-500/10 p-2 rounded">Note: Only fields you touch will be updated. Empty fields will remain unchanged.</p>

            <div>
                <label class="block text-xs font-semibold text-text-secondary uppercase mb-1">Entry Timeframe</label>
                <select id="bulk-timeframe" class="w-full bg-bg-primary border border-border-color rounded-lg p-2.5 text-text-primary focus:ring-2 focus:ring-accent-color focus:border-transparent">
                    <option value="">(Do not change)</option>
                    <option value="M1">M1</option>
                    <option value="M5">M5</option>
                    <option value="M15">M15</option>
                    <option value="H1">H1</option>
                    <option value="H4">H4</option>
                    <option value="D1">D1</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-semibold text-text-secondary uppercase mb-1">Set Strategy Tag</label>
                <select id="bulk-strategy" class="w-full bg-bg-primary border border-border-color rounded-lg p-2.5 text-text-primary">
                    <option value="">(Do not change)</option>
                    </select>
            </div>

            <div>
                <label class="block text-xs font-semibold text-text-secondary uppercase mb-1">Set Psychology Tag</label>
                <select id="bulk-psychology" class="w-full bg-bg-primary border border-border-color rounded-lg p-2.5 text-text-primary">
                    <option value="">(Do not change)</option>
                    </select>
            </div>

            <div>
                <label class="block text-xs font-semibold text-text-secondary uppercase mb-1">Mark Checklist Items as Met</label>
                <div id="bulk-checklist-container" class="space-y-2 bg-bg-primary p-3 rounded-lg border border-border-color">
                    </div>
            </div>
        </div>

        <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-border-color">
            <button onclick="closeBulkEditModal()" class="px-4 py-2 rounded-lg text-sm font-semibold text-text-secondary hover:bg-bg-tertiary transition-colors">Cancel</button>
            <button onclick="applyBulkEdit()" class="px-4 py-2 rounded-lg text-sm font-bold bg-accent-color text-white hover:bg-opacity-90 shadow-lg shadow-accent-color/20 transition-all transform hover:scale-105">Apply Changes</button>
        </div>
    </div>
</div>
<div id="day-summary-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[200] backdrop-blur-sm animate-fade-in">
    <div class="bg-bg-secondary w-full max-w-sm rounded-2xl shadow-2xl border border-border-color p-6 transform transition-all scale-100 relative">
        <button onclick="closeDayModal()" class="absolute top-4 right-4 text-text-secondary hover:text-text-primary p-2"></button>
        
        <div class="text-center mb-6">
            <h3 id="day-modal-date" class="text-xl font-bold text-text-primary">--</h3>
            <p id="day-modal-net" class="text-sm font-mono mt-1 text-text-secondary">Net P/L: --</p>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-bg-tertiary p-3 rounded-xl text-center border border-border-color">
                <p class="text-[10px] text-text-secondary uppercase tracking-wider font-bold">Trades</p>
                <p id="day-modal-count" class="text-xl font-black text-text-primary mt-1">--</p>
            </div>
            <div class="bg-bg-tertiary p-3 rounded-xl text-center border border-border-color">
                <p class="text-[10px] text-text-secondary uppercase tracking-wider font-bold">Win Rate</p>
                <p id="day-modal-winrate" class="text-xl font-black text-text-primary mt-1">--</p>
            </div>
            <div class="bg-green-500/10 border border-green-500/20 p-3 rounded-xl text-center">
                <p class="text-[10px] text-green-400 uppercase tracking-wider font-bold">Best Trade</p>
                <p id="day-modal-best" class="text-lg font-bold text-green-500 mt-1">--</p>
            </div>
            <div class="bg-red-500/10 border border-red-500/20 p-3 rounded-xl text-center">
                <p class="text-[10px] text-red-400 uppercase tracking-wider font-bold">Worst Trade</p>
                <p id="day-modal-worst" class="text-lg font-bold text-red-400 mt-1">--</p>
            </div>
        </div>

        <button id="day-modal-filter-btn" class="w-full py-3 bg-accent-color hover:bg-opacity-90 text-white font-bold rounded-xl transition-all shadow-lg shadow-accent-color/20 flex items-center justify-center gap-2">
            <span>View Trades in History</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17l9.2-9.2M17 17V7H7"/></svg>
        </button>
    </div>
</div>
</body>
</html>
