<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prolific Trading Journal (Simplified)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- jsPDF and html2canvas for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- IDB Library -->
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #111827;
            --card-bg-dark: rgba(31, 41, 55, 0.7);
            --text-dark-primary: #f9fafb;
            --text-dark-secondary: #9ca3af;
            --border-dark: #374151;
            --input-bg-dark: #374151;
            --accent-color: #3b82f6; /* Default accent color */
        }
        
        html {
             color-scheme: dark;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark-primary);
            background-image: linear-gradient(to top, #202020 0%, #111827 100%);
        }
        
        .sticky-header {
            position: sticky;
            top: 1rem;
            z-index: 30;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: box-shadow 0.3s ease;
        }

        .card {
            background-color: var(--card-bg-dark);
            border: 1px solid var(--border-dark);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .form-input {
            background-color: var(--input-bg-dark);
            border-color: var(--border-dark);
            color: var(--text-dark-primary);
            transition: box-shadow 0.2s ease-in-out;
        }

        .form-input:focus {
            --tw-ring-color: var(--accent-color);
            --tw-ring-offset-shadow: 0 0 0 0 transparent;
            --tw-ring-shadow: 0 0 0 3px var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), 0 0 #0000;
        }

        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .details-row { transition: all 0.3s ease-in-out; }
        .details-row td { padding-top: 0; padding-bottom: 0; }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        .details-row.open .details-content { max-height: 20000px; padding: 1rem; }
        .rendered-notes img, .playbook-image { max-width: 100%; height: auto; border-radius: 0.5rem; margin-top: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgb(255 255 255 / 0.1), 0 2px 4px -2px rgb(255 255 255 / 0.1); }


        #trade-comments-editor, .playbook-textarea { min-height: 100px; }
        #trade-comments-editor:empty:before, .playbook-textarea:empty:before { content: attr(data-placeholder); color: var(--text-dark-secondary); cursor: text; }
        #trade-comments-editor.dragover, .image-dropzone.dragover { border-style: dashed; border-color: var(--accent-color); }

        .tooltip .tooltiptext { visibility: hidden; width: 240px; background-color: #374151; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -120px; opacity: 0; transition: opacity 0.3s; font-size: 12px; line-height: 1.5; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #374151 transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        
        #toast-container { position: fixed; top: 1.25rem; right: 1.25rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateX(120%); opacity: 0; transition: transform 0.5s ease, opacity 0.5s ease; color: white; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: var(--accent-color); }
        .toast-progress { position: absolute; bottom: 0; left: 0; height: 4px; background-color: rgba(0,0,0,0.3); width: 100%; animation: shrink 3s linear forwards; }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }

        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--accent-color); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .loader-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animation Classes */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        .animate-fade-in-up { opacity: 0; animation: fade-in-up 0.5s ease-out forwards; }
        
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: scale(1.05) translateY(-2px); }
        .btn:active { transform: scale(0.98) translateY(0); }

        .btn-primary {
            background-image: linear-gradient(to right, #4338ca 0%, var(--accent-color) 51%, #4338ca 100%);
            background-size: 200% auto;
            transition: 0.5s;
        }
        .btn-primary:hover {
            background-position: right center;
        }

        #log-trade-btn { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 var(--accent-color); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Star Rating */
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating input { display: none; }
        .star-rating label { color: #4b5563; font-size: 2rem; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label { color: #f59e0b; }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-dark);
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 28rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <div class="sticky-header flex flex-wrap items-center justify-between mb-6 gap-4 p-4 rounded-xl bg-gray-900/50 border border-gray-700/50 shadow-lg">
            <h1 class="text-2xl lg:text-3xl font-bold text-gray-100">Prolific Trading Journal</h1>
            <div class="flex items-center gap-2 sm:gap-4">
                <div class="flex items-center bg-gray-800/50 rounded-lg p-1 border border-gray-700">
                    <button data-page="journal" class="page-btn px-3 py-1.5 text-sm font-semibold rounded-md active">Journal</button>
                    <button data-page="playbook" class="page-btn px-3 py-1.5 text-sm font-semibold rounded-md text-gray-300">Playbook</button>
                    <button data-page="goals" class="page-btn px-3 py-1.5 text-sm font-semibold rounded-md text-gray-300">Goals</button>
                    <button data-page="analytics" class="page-btn px-3 py-1.5 text-sm font-semibold rounded-md text-gray-300">Analytics</button>
                </div>
                 <!-- Settings Menu -->
                <div class="relative">
                    <button id="settings-menu-btn" title="Settings" class="btn p-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="settings-menu-panel" class="hidden absolute right-0 mt-2 w-72 bg-gray-800 rounded-lg shadow-xl z-50 border border-gray-700">
                        <div class="p-4 space-y-4">
                              <div>
                                  <h3 class="text-sm font-semibold text-gray-400 mb-2">Account Management</h3>
                                  <div class="flex items-center gap-2">
                                      <select id="account-switcher" class="form-input text-sm rounded-lg p-2 w-full"></select>
                                      <button id="manage-accounts-btn" title="Manage Accounts" class="btn p-2 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 transition-colors flex-shrink-0">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.38"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                      </button>
                                  </div>
                              </div>
                              <div>
                                  <h3 class="text-sm font-semibold text-gray-400 mb-2">Data & Reports</h3>
                                  <div class="space-y-2">
                                        <button id="save-data-btn" class="btn w-full text-sm font-semibold p-2 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 transition-colors">Save Data</button>
                                        <label for="import-file" class="btn w-full text-center cursor-pointer text-sm font-semibold p-2 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 transition-colors block">Import Data</label>
                                        <input type="file" id="import-file" class="hidden" accept=".json">
                                        <button id="export-btn" class="btn w-full text-sm font-semibold p-2 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 transition-colors">Export Data</button>
                                        <button id="export-pdf-btn" class="btn w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                          Export Analytics PDF
                                      </button>
                                  </div>
                              </div>
                              <div>
                                  <h3 class="text-sm font-semibold text-gray-400 mb-2">Theme Accent Color</h3>
                                  <input type="color" id="accent-color-picker" class="w-full h-10 p-1 bg-gray-700 rounded-lg cursor-pointer">
                              </div>
                              <div>
                                <h3 class="text-sm font-semibold text-gray-400 mb-2">Breakeven Threshold ($)</h3>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="breakeven-slider" min="0" max="50" step="0.5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    <span id="breakeven-value" class="text-sm font-mono w-12 text-center">$2.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Page Content -->
        <div id="page-content" class="animate-fade-in">

            <!-- Journal Page -->
            <div id="journal-page">
                <!-- Performance Dashboard -->
                <div class="grid grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
                    <!-- Cards here... -->
                     <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 50ms;">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Total P/L</p>
                            <p id="total-pl" class="text-2xl font-bold text-gray-100">$0.00</p>
                        </div>
                    </div>
                     <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Win Rate</p>
                            <p id="win-rate" class="text-2xl font-bold text-gray-100">0%</p>
                        </div>
                    </div>
                     <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 150ms;">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Realized R:R</p>
                            <p id="realized-rr" class="text-2xl font-bold text-gray-100">1 : 0.00</p>
                        </div>
                    </div>
                    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 200ms;">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Avg. Profit</p>
                            <p id="avg-profit" class="text-2xl font-bold text-green-500">$0.00</p>
                        </div>
                    </div>
                    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 250ms;">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Avg. Loss</p>
                            <p id="avg-loss" class="text-2xl font-bold text-red-500">$0.00</p>
                        </div>
                    </div>
                    <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 300ms;">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Total Trades</p>
                            <p id="total-trades" class="text-2xl font-bold text-gray-100">0</p>
                        </div>
                    </div>
                </div>
                
                 <!-- Account Overview -->
                <div class="mb-6 card p-6 rounded-xl shadow-sm animate-fade-in-up">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Account Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div class="flex items-center gap-4 col-span-1 md:col-span-1">
                            <div class="flex-1">
                                <label for="starting-balance" class="block text-sm font-medium text-gray-400">Starting Balance ($)</label>
                                <input type="number" id="starting-balance" placeholder="e.g., 10000" class="mt-1 w-full p-2 form-input rounded-lg">
                            </div>
                            <button id="save-balance-btn" class="self-end font-semibold py-2 px-4 rounded-lg transition-colors btn btn-primary text-white">Save</button>
                        </div>
                        <div class="col-span-1 md:col-span-1">
                            <p class="text-sm font-medium text-gray-400">Account Growth</p>
                            <p id="account-growth" class="text-3xl font-bold text-gray-100">0.00%</p>
                        </div>
                         <div class="col-span-1 md:col-span-1">
                            <p class="text-sm font-medium text-gray-400">Current Balance</p>
                            <p id="current-balance" class="text-3xl font-bold text-gray-100">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Main Content: Form and History -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card p-6 rounded-xl shadow-sm self-start animate-fade-in-up">
                        <h2 id="form-title" class="text-xl font-semibold mb-4 text-gray-200">Log New Trade</h2>
                        <div class="space-y-4">
                              <input type="hidden" id="editing-trade-id">
                            <div>
                                <label for="index-selector" class="block text-sm font-medium text-gray-400">Instrument</label>
                                <select id="index-selector" class="mt-1 w-full p-2 form-input rounded-lg">
                                      <optgroup label="Stock Indices">
                                          <option value="US Wall Street 30">US Wall Street 30</option><option value="US 500">US 500</option><option value="US Tech 100">US Tech 100</option><option value="Germany 40">Germany 40</option><option value="UK 100">UK 100</option><option value="Japan 225">Japan 225</option>
                                    </optgroup>
                                      <optgroup label="Metals">
                                        <option value="Gold">Gold</option><option value="Silver">Silver</option><option value="Platinum">Platinum</option>
                                    </optgroup>
                                      <optgroup label="Commodities">
                                        <option value="Oil (WTI)">Oil (WTI)</option><option value="Natural Gas">Natural Gas</option>
                                    </optgroup>
                                      <optgroup label="Forex - Majors">
                                        <option value="EUR/USD">EUR/USD</option><option value="GBP/USD">GBP/USD</option><option value="USD/JPY">USD/JPY</option><option value="USD/CAD">USD/CAD</option><option value="AUD/USD">AUD/USD</option><option value="USD/CHF">USD/CHF</option><option value="NZD/USD">NZD/USD</option>
                                    </optgroup>
                                      <optgroup label="Forex - Minors">
                                        <option value="EUR/GBP">EUR/GBP</option><option value="EUR/JPY">EUR/JPY</option><option value="EUR/AUD">EUR/AUD</option><option value="EUR/CAD">EUR/CAD</option><option value="EUR/CHF">EUR/CHF</option><option value="EUR/NZD">EUR/NZD</option><option value="GBP/JPY">GBP/JPY</option><option value="GBP/AUD">GBP/AUD</option><option value="GBP/CAD">GBP/CAD</option><option value="GBP/CHF">GBP/CHF</option><option value="GBP/NZD">GBP/NZD</option><option value="AUD/JPY">AUD/JPY</option><option value="AUD/CAD">AUD/CAD</option><option value="AUD/CHF">AUD/CHF</option><option value="AUD/NZD">AUD/NZD</option><option value="CAD/JPY">CAD/JPY</option><option value="CAD/CHF">CAD/CHF</option><option value="CHF/JPY">CHF/JPY</option><option value="NZD/JPY">NZD/JPY</option><option value="NZD/CAD">NZD/CAD</option><option value="NZD/CHF">NZD/CHF</option>
                                    </optgroup>
                                      <optgroup label="Forex - Exotics">
                                        <option value="USD/ZAR">USD/ZAR</option><option value="USD/MXN">USD/MXN</option><option value="USD/SGD">USD/SGD</option><option value="USD/HKD">USD/HKD</option><option value="USD/TRY">USD/TRY</option><option value="EUR/TRY">EUR/TRY</option>
                                    </optgroup>
                                      <optgroup label="Volatility Indices">
                                        <option value="Volatility 10 Index">Volatility 10 Index</option><option value="Volatility 25 Index">Volatility 25 Index</option><option value="Volatility 50 Index">Volatility 50 Index</option><option value="Volatility 75 Index">Volatility 75 Index</option><option value="Volatility 100 Index">Volatility 100 Index</option><option value="Volatility 10 (1s) Index">Volatility 10 (1s) Index</option><option value="Volatility 25 (1s) Index">Volatility 25 (1s) Index</option><option value="Volatility 50 (1s) Index">Volatility 50 (1s) Index</option><option value="Volatility 75 (1s) Index">Volatility 75 (1s) Index</option><option value="Volatility 100 (1s) Index">Volatility 100 (1s) Index</option>
                                    </optgroup>
                                      <optgroup label="Crash/Boom">
                                        <option value="Crash 300 Index">Crash 300 Index</option><option value="Crash 500 Index">Crash 500 Index</option><option value="Crash 1000 Index">Crash 1000 Index</option><option value="Boom 300 Index">Boom 300 Index</option><option value="Boom 500 Index">Boom 500 Index</option><option value="Boom 1000 Index">Boom 1000 Index</option>
                                    </optgroup>
                                      <optgroup label="Jump Indices">
                                        <option value="Jump 10 Index">Jump 10 Index</option><option value="Jump 25 Index">Jump 25 Index</option><option value="Jump 50 Index">Jump 50 Index</option><option value="Jump 75 Index">Jump 75 Index</option><option value="Jump 100 Index">Jump 100 Index</option>
                                    </optgroup>
                                      <optgroup label="Step Indices">
                                        <option value="Step Index">Step Index</option>
                                    </optgroup>
                                      <optgroup label="Range Break Indices">
                                        <option value="Range Break 100 Index">Range Break 100 Index</option><option value="Range Break 200 Index">Range Break 200 Index</option>
                                    </optgroup>
                                      <optgroup label="DEX Indices">
                                        <option value="DEX 600UP Index">DEX 600UP Index</option><option value="DEX 900UP Index">DEX 900UP Index</option><option value="DEX 1500UP Index">DEX 1500UP Index</option><option value="DEX 600DN Index">DEX 600DN Index</option><option value="DEX 900DN Index">DEX 900DN Index</option><option value="DEX 1500DN Index">DEX 1500DN Index</option>
                                    </optgroup>
                                </select>
                            </div>
                              <div>
                                <label for="playbook-select" class="block text-sm font-medium text-gray-400">Playbook Setup</label>
                                <select id="playbook-select" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <option value="">None</option>
                                    <!-- Playbook options will be dynamically inserted here -->
                                </select>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <label class="block text-sm font-medium text-gray-400">Tags</label>
                                    <button id="manage-tags-btn" class="text-xs text-blue-500 font-semibold hover:underline">Manage Tags</button>
                                </div>
                                <div id="tags-checklist" class="mt-1 w-full p-2 form-input rounded-lg max-h-[150px] overflow-y-auto"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-400">Trade Type</label>
                                <div class="mt-1 grid grid-cols-2 gap-2">
                                      <button id="buy-btn" class="trade-type-btn bg-blue-500 text-white p-2 rounded-lg btn">Buy</button>
                                      <button id="sell-btn" class="trade-type-btn bg-gray-700 text-gray-300 p-2 rounded-lg btn">Sell</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="lot-size" class="block text-sm font-medium text-gray-400">Lot Size</label>
                                    <input type="number" id="lot-size" placeholder="e.g., 0.2" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                                 <div id="num-positions-container">
                                    <label for="num-positions" class="block text-sm font-medium text-gray-400">No. of Positions</label>
                                    <input type="number" id="num-positions" value="1" min="1" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                            </div>
                              <div class="grid grid-cols-2 gap-4">
                                <div>
                                   <label for="entry-price" class="block text-sm font-medium text-gray-400">Entry Price</label>
                                   <input type="number" id="entry-price" placeholder="e.g., 12345.6" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                                <div>
                                   <label for="exit-price" class="block text-sm font-medium text-gray-400">Exit Price</label>
                                   <input type="number" id="exit-price" placeholder="Leave blank if open" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                            </div>
                              <!-- Real-time P/L Display -->
                            <div id="realtime-pl-display" class="p-2 text-center rounded-lg h-10 transition-all"></div>
                              <div>
                                <label for="stop-loss" class="block text-sm font-medium text-gray-400">Stop Loss</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="stop-loss" placeholder="Price level" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <input type="number" id="sl-pips" placeholder="pips/pts" class="form-input mt-1 w-20 p-2 rounded-lg text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="take-profit" class="block text-sm font-medium text-gray-400">Take Profit</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="take-profit" placeholder="Price level" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <input type="number" id="tp-pips" placeholder="pips/pts" class="form-input mt-1 w-20 p-2 rounded-lg text-sm">
                                </div>
                            </div>
                              <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="peak-price" class="block text-sm font-medium text-gray-400">Peak Profit Price (MFE)</label>
                                    <input type="number" id="peak-price" placeholder="For losing trades" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                                <div>
                                    <label for="mae-price" class="block text-sm font-medium text-gray-400">Peak Drawdown Price (MAE)</label>
                                    <input type="number" id="mae-price" placeholder="For winning trades" class="form-input mt-1 w-full p-2 rounded-lg">
                                </div>
                            </div>
                              <div>
                                <label for="fees" class="block text-sm font-medium text-gray-400">Commissions & Fees</label>
                                <input type="number" id="fees" placeholder="e.g., 5.50" class="form-input mt-1 w-full p-2 rounded-lg">
                            </div>
                            <div>
                                <label for="trade-comments-editor" class="block text-sm font-medium text-gray-400">Comments & Screenshots</label>
                                <div id="trade-comments-editor" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg max-h-[400px] overflow-y-auto" data-placeholder="Add notes, paste or drag images here..."></div>
                            </div>
                            <button id="log-trade-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg shadow-md text-white">Log Trade</button>
                            <button id="cancel-edit-btn" class="hidden w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors mt-2">Cancel Edit</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 card p-6 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                        <div class="flex flex-wrap gap-4 items-center justify-between mb-4">
                              <h2 class="text-xl font-semibold text-gray-200">Trade History</h2>
                            <div id="filter-bar" class="flex flex-wrap items-center gap-2 text-sm">
                                <select id="filter-instrument" class="form-input rounded-lg p-1.5"><option value="">All Instruments</option></select>
                                <select id="filter-tag" class="form-input rounded-lg p-1.5"><option value="">All Tags</option></select>
                                <select id="filter-type" class="form-input rounded-lg p-1.5"><option value="">All Types</option><option value="Buy">Buy</option><option value="Sell">Sell</option></select>
                                <select id="filter-outcome" class="form-input rounded-lg p-1.5"><option value="">All Outcomes</option><option value="win">Win</option><option value="loss">Loss</option><option value="breakeven">Breakeven</option><option value="open">Open</option></select>
                                <input type="date" id="filter-start-date" class="form-input rounded-lg p-1.5 text-sm" title="Start Date">
                                <input type="date" id="filter-end-date" class="form-input rounded-lg p-1.5 text-sm" title="End Date">
                                <button id="reset-filters-btn" class="p-1.5 text-gray-500 hover:text-gray-200">Reset</button>
                            </div>
                        </div>
                        <div id="filter-status" class="text-xs text-blue-500 mb-2 hidden"></div>
                        <div class="overflow-y-auto" style="max-height: 70vh;">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-900 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">Trade Details</th>
                                        <th scope="col" class="px-4 py-3">Type</th>
                                        <th scope="col" class="px-4 py-3">R:R</th>
                                        <th scope="col" class="px-4 py-3">Net P/L ($)</th>
                                        <th scope="col" class="px-4 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="trade-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals Page -->
            <div id="goals-page" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card p-6 rounded-xl shadow-sm self-start animate-fade-in-up">
                        <h2 id="goal-form-title" class="text-xl font-semibold mb-4 text-gray-200">Add New Goal</h2>
                         <form class="space-y-4" id="add-goal-form">
                              <input type="hidden" id="editing-goal-id">
                            <div>
                                <label for="goal-title" class="block text-sm font-medium text-gray-400">Goal Title</label>
                                <input type="text" id="goal-title" placeholder="e.g., Monthly Profit Target" class="form-input mt-1 w-full p-2 rounded-lg">
                            </div>
                            <div>
                                <label for="goal-metric" class="block text-sm font-medium text-gray-400">Metric</label>
                                <select id="goal-metric" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <option value="totalPL">Total P/L ($)</option>
                                    <option value="winRate">Win Rate (%)</option>
                                    <option value="profitFactor">Profit Factor</option>
                                </select>
                            </div>
                            <div>
                                <label for="goal-target" class="block text-sm font-medium text-gray-400">Target Value</label>
                                <input type="number" id="goal-target" placeholder="e.g., 1000" class="form-input mt-1 w-full p-2 rounded-lg">
                            </div>
                            <div>
                                <label for="goal-timeframe" class="block text-sm font-medium text-gray-400">Timeframe</label>
                                <select id="goal-timeframe" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <button type="button" id="add-goal-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg shadow-md text-white">Add Goal</button>
                            <button type="button" id="cancel-goal-edit-btn" class="hidden w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors mt-2">Cancel Edit</button>
                        </form>
                    </div>
                     <div class="lg:col-span-2 card p-6 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                         <h2 class="text-xl font-semibold mb-4 text-gray-200">Active Goals</h2>
                         <div id="goals-list" class="space-y-4">
                            <!-- Goals will be rendered here -->
                        </div>
                     </div>
                </div>
            </div>

             <!-- Playbook Page -->
            <div id="playbook-page" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card p-6 rounded-xl shadow-sm self-start animate-fade-in-up">
                        <h2 id="play-form-title" class="text-xl font-semibold mb-4 text-gray-200">Add New Play</h2>
                        <input type="hidden" id="editing-play-id">
                        <div class="space-y-4">
                              <div>
                                <label for="play-title" class="block text-sm font-medium text-gray-400">Play Title</label>
                                <input type="text" id="play-title" placeholder="e.g., London Killzone Scalp" class="form-input mt-1 w-full p-2 rounded-lg">
                            </div>
                              <div>
                                <label for="play-instruments" class="block text-sm font-medium text-gray-400">Optimal Instruments</label>
                                <select id="play-instruments" multiple class="form-input mt-1 w-full p-2 rounded-lg h-32"></select>
                            </div>
                            <div>
                                <label for="play-market-condition" class="block text-sm font-medium text-gray-400">Ideal Market Condition</label>
                                <select id="play-market-condition" class="form-input mt-1 w-full p-2 rounded-lg">
                                    <option>Trending</option>
                                    <option>Ranging</option>
                                    <option>Volatile</option>
                                </select>
                            </div>
                            <div>
                                <label for="play-entry-criteria" class="block text-sm font-medium text-gray-400">Entry Criteria</label>
                                <div id="play-entry-criteria" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg playbook-textarea" data-placeholder="1. Market structure shift..."></div>
                            </div>
                              <div>
                                <label for="play-sl-rules" class="block text-sm font-medium text-gray-400">Stop Loss Rules</label>
                                <div id="play-sl-rules" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg playbook-textarea" data-placeholder="e.g., 5 pips above previous high"></div>
                            </div>
                              <div>
                                <label for="play-management-rules" class="block text-sm font-medium text-gray-400">Trade Management</label>
                                <div id="play-management-rules" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg playbook-textarea" data-placeholder="e.g., Move to BE at 1R"></div>
                            </div>
                            <div>
                                <label for="play-confidence-rating" class="block text-sm font-medium text-gray-400">Confidence Rating</label>
                                <div id="play-confidence-rating" class="star-rating mt-1">
                                    <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars">★</label>
                                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">★</label>
                                    <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars">★</label>
                                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">★</label>
                                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">★</label>
                                </div>
                            </div>
                            <div>
                                <label for="play-review-notes" class="block text-sm font-medium text-gray-400">Review Notes</label>
                                <div id="play-review-notes" contenteditable="true" class="form-input mt-1 w-full p-2 rounded-lg playbook-textarea" data-placeholder="e.g., Underperforms in choppy markets..."></div>
                            </div>
                              <div>
                                <label class="block text-sm font-medium text-gray-400">"Before" Screenshot</label>
                                <div id="play-before-image" class="mt-1 image-dropzone h-32 flex items-center justify-center border-2 border-dashed border-gray-600 rounded-lg text-gray-500 cursor-pointer">
                                    Click or Drag Image Here
                                </div>
                                <input type="file" id="play-before-file" class="hidden" accept="image/*">
                            </div>
                              <div>
                                <label class="block text-sm font-medium text-gray-400">"After" Screenshot</label>
                                <div id="play-after-image" class="mt-1 image-dropzone h-32 flex items-center justify-center border-2 border-dashed border-gray-600 rounded-lg text-gray-500 cursor-pointer">
                                    Click or Drag Image Here
                                </div>
                                 <input type="file" id="play-after-file" class="hidden" accept="image/*">
                            </div>
                            <button id="save-play-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg shadow-md text-white">Save Play</button>
                            <button id="cancel-play-edit-btn" class="hidden w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors mt-2">Cancel Edit</button>
                        </div>
                    </div>
                     <div class="lg:col-span-2 card p-6 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                         <h2 class="text-xl font-semibold mb-4 text-gray-200">My Playbook</h2>
                         <div id="playbook-list" class="space-y-4">
                            <!-- Playbook plays will be rendered here -->
                        </div>
                     </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="analytics-page" class="hidden">
                 <div class="space-y-6" id="analytics-content-for-pdf">
                    <div class="flex justify-between items-center -mb-2">
                         <h2 class="text-2xl font-bold text-gray-100">Analytics Dashboard</h2>
                    </div>
                    <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Drawdown Analysis</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-sm font-medium text-gray-400">Max Drawdown ($)</p>
                                <p id="max-drawdown-usd" class="text-2xl font-bold text-red-500">$0.00</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-400">Max Drawdown (%)</p>
                                <p id="max-drawdown-pct" class="text-2xl font-bold text-red-500">0.00%</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-400">Longest Drawdown</p>
                                <p id="longest-drawdown-period" class="text-2xl font-bold text-red-500">0 days</p>
                            </div>
                        </div>
                        <div class="mt-4 h-48">
                            <canvas id="drawdownChart"></canvas>
                        </div>
                    </div>
                    <!-- Executive Summary Removed -->
                    <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up">
                            <p class="text-sm font-medium text-gray-400">Profit Factor</p>
                            <p id="profit-factor" class="text-2xl font-bold text-gray-100">0.00</p>
                        </div>
                        <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 50ms;">
                            <p class="text-sm font-medium text-gray-400">Expectancy</p>
                            <p id="expectancy" class="text-2xl font-bold text-gray-100">$0.00</p>
                        </div>
                        <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                            <p class="text-sm font-medium text-gray-400">Longest Win Streak</p>
                            <p id="win-streak" class="text-2xl font-bold text-green-500">0</p>
                        </div>
                        <div class="card p-4 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 150ms;">
                            <p class="text-sm font-medium text-gray-400">Longest Loss Streak</p>
                            <p id="loss-streak" class="text-2xl font-bold text-red-500">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                            <h2 class="text-xl font-semibold mb-4 text-gray-200">Performance by Day of Week</h2>
                            <canvas id="dailyPerformanceChart"></canvas>
                        </div>
                        <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up" style="animation-delay: 100ms;">
                            <h2 class="text-xl font-semibold mb-4 text-gray-200">Performance by Hour of Day</h2>
                            <canvas id="hourlyPerformanceChart"></canvas>
                        </div>
                    </div>
                    <!-- Holding Time Analysis Removed -->
                     <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Risk Consistency Tracker</h2>
                        <p class="text-xs text-gray-400 mb-4 -mt-3">Plots the initial dollar risk for each trade with a defined Stop Loss.</p>
                        <div class="h-64">
                            <canvas id="riskConsistencyChart"></canvas>
                        </div>
                    </div>
                     <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Trade Excursion Analysis (MAE/MFE)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-px bg-gray-700/50 rounded-lg overflow-hidden">
                            <div class="bg-gray-800 p-4">
                                <h3 class="font-semibold text-center text-red-400">MAE on Winners</h3>
                                <p class="text-xs text-center text-gray-400 mb-3">(Avg. Drawdown During a Win)</p>
                                <div class="flex justify-between items-baseline">
                                    <span class="text-sm font-medium text-gray-400">Avg. MAE</span>
                                    <span id="avg-mae-winners" class="text-2xl font-bold text-red-400">$0.00</span>
                                </div>
                                <div class="flex justify-between items-baseline mt-1">
                                    <span class="text-sm font-medium text-gray-400">Total MAE</span>
                                    <span id="total-mae-winners" class="text-lg font-semibold text-red-400/80">$0.00</span>
                                </div>
                                <div class="mt-3">
                                    <p class="text-xs text-gray-500 text-center">Avg. MAE relative to Avg. Win</p>
                                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                                        <div id="mae-comparison-bar" class="bg-red-500 h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-4">
                                <h3 class="font-semibold text-center text-green-400">MFE on Losers/BE</h3>
                                <p class="text-xs text-center text-gray-400 mb-3">(Avg. Potential on a Loss)</p>
                                <div class="flex justify-between items-baseline">
                                    <span class="text-sm font-medium text-gray-400">Avg. Slipped P/L</span>
                                    <span id="avg-mfe-losers" class="text-2xl font-bold text-green-400">$0.00</span>
                                </div>
                                <div class="flex justify-between items-baseline mt-1">
                                    <span class="text-sm font-medium text-gray-400">Total Slipped P/L</span>
                                    <span id="total-mfe-losers" class="text-lg font-semibold text-green-400/80">$0.00</span>
                                </div>
                                 <div class="mt-3">
                                    <p class="text-xs text-gray-500 text-center">Avg. Slipped P/L relative to Avg. Loss</p>
                                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                                        <div id="mfe-comparison-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Performance by Tag</h2>
                        <p class="text-xs text-gray-400 mb-4 -mt-3">Analyzes performance based on your custom tags.</p>
                        <div id="tag-performance-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                    <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Performance by Instrument</h2>
                        <div id="index-performance-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                     <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Planned Risk : Reward Analysis</h2>
                        <p class="text-xs text-gray-400 mb-4 -mt-3">Analyzes trades where Stop Loss & Take Profit were recorded.</p>
                        <div id="rr-analysis-body"></div>
                    </div>
                    <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Trade Calendar</h2>
                         <div class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-700">&lt;</button>
                            <div class="flex items-center gap-2">
                                <h3 id="calendar-month-year" class="text-lg font-semibold"></h3>
                                <input type="date" id="calendar-date-picker" class="form-input text-sm rounded-lg p-1">
                            </div>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-700">&gt;</button>
                        </div>
                         <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 mb-2">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                         <div id="calendar-body" class="grid grid-cols-7 gap-1"></div>
                    </div>
                     <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Monte Carlo Simulation</h2>
                         <div class="flex flex-wrap items-end gap-4 mb-4">
                              <div>
                                <label for="mc-trades" class="block text-sm font-medium text-gray-400">Trades to Project</label>
                                <input type="number" id="mc-trades" value="252" class="form-input mt-1 p-2 rounded-lg w-32">
                            </div>
                              <div>
                                <label for="mc-simulations" class="block text-sm font-medium text-gray-400">Simulations</label>
                                <input type="number" id="mc-simulations" value="1000" class="form-input mt-1 p-2 rounded-lg w-32">
                            </div>
                            <button id="run-mc-btn" class="font-semibold py-2 px-4 rounded-lg btn btn-primary text-white">Run Simulation</button>
                        </div>
                         <div id="mc-results-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <canvas id="mcChart"></canvas>
                            <div id="mc-stats" class="text-sm"></div>
                        </div>
                    </div>
                     <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Reversal Analysis (MFE)</h2>
                        <p class="text-xs text-gray-400 mb-4 -mt-3">Analyzes trades that were in profit but ended as losses/breakeven to identify patterns.</p>
                        <div id="reversal-analysis-body"></div>
                    </div>
                    <div class="card p-6 rounded-xl shadow-sm animate-fade-in-up">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">Performance by Planned R:R</h2>
                        <div id="rr-performance-body" class="space-y-4">
                            <!-- Stats will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals and Overlays -->
    <div id="accounts-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40">
         <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-200">Manage Accounts</h2>
                <button id="close-accounts-modal-btn" class="text-gray-500 hover:text-gray-200">&times;</button>
            </div>
            <div id="accounts-list" class="space-y-2 mb-4"></div>
            <div class="flex items-center gap-2">
                <input type="text" id="new-account-name" placeholder="New account name..." class="flex-1 p-2 form-input rounded-lg">
                <button id="add-account-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add</button>
            </div>
        </div>
    </div>
    <div id="tags-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-200">Manage Tags</h2>
                <button id="close-tags-modal-btn" class="text-gray-500 hover:text-gray-200">&times;</button>
            </div>
            <div id="tags-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <div class="flex items-center gap-2">
                <input type="text" id="new-tag-name" placeholder="New tag name..." class="flex-1 p-2 form-input rounded-lg">
                <input type="color" id="new-tag-color" value="#8B5CF6" class="p-1 h-10 w-10 bg-gray-700 rounded-lg cursor-pointer">
                <button id="add-tag-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add</button>
            </div>
        </div>
    </div>
    <div id="calendar-day-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="calendar-day-title" class="text-xl font-semibold text-gray-200">Trades for...</h2>
                <button id="close-day-modal-btn" class="text-gray-500 hover:text-gray-200">&times;</button>
            </div>
            <div id="calendar-day-trades" class="overflow-y-auto"></div>
        </div>
    </div>
    <div id="toast-container"></div>
    <div id="loader-overlay" class="hidden loader-overlay">
        <div class="loader"></div>
    </div>

    <!-- Custom Confirmation/Prompt Modal -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="custom-modal-title" class="text-lg font-bold text-gray-100 mb-2"></h3>
            <p id="custom-modal-text" class="text-sm text-gray-400 mb-4"></p>
            <div id="custom-modal-input-container" class="hidden mb-4">
                <input type="text" id="custom-modal-input" class="form-input w-full p-2 rounded-lg">
            </div>
            <div class="flex justify-end gap-3">
                <button id="custom-modal-cancel-btn" class="btn bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700">Cancel</button>
                <button id="custom-modal-confirm-btn" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- NEW: IndexedDB Configuration ---
        const DB_NAME = 'ProlificJournalDB';
        const DB_VERSION = 1;
        const STORES = {
            accounts: 'accounts',
            settings: 'settings',
            activeAccount: 'activeAccount'
        };
        let db; // This will hold the database connection object

        /**
         * NEW: Opens the database and creates object stores if they don't exist.
         */
        async function openJournalDB() {
            db = await idb.openDB(DB_NAME, DB_VERSION, {
                upgrade(db) {
                    if (!db.objectStoreNames.contains(STORES.accounts)) {
                        db.createObjectStore(STORES.accounts, { keyPath: 'name' });
                    }
                    if (!db.objectStoreNames.contains(STORES.settings)) {
                        db.createObjectStore(STORES.settings, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(STORES.activeAccount)) {
                        db.createObjectStore(STORES.activeAccount, { keyPath: 'id' });
                    }
                },
            });
        }

        // --- App State & Constants ---
        let appData = {};
        let tradeType = 'Buy';
        let calendarDate = new Date();
        let dailyPerfChart = null, hourlyPerfChart = null, mcChart = null, drawdownChart = null, riskConsistencyChart = null;
        
        // --- All DOM Element IDs used in the script ---
        const elementIds = [
            'buy-btn', 'sell-btn', 'log-trade-btn', 'cancel-edit-btn', 'save-balance-btn', 'save-data-btn',
            'settings-menu-btn', 'settings-menu-panel', 'manage-accounts-btn', 'close-accounts-modal-btn', 'add-account-btn', 'account-switcher',
            'prev-month-btn', 'next-month-btn', 'calendar-date-picker', 'close-day-modal-btn', 'export-btn', 'import-file',
            'export-pdf-btn', 'reset-filters-btn', 'run-mc-btn', 'trade-comments-editor', 'lot-size', 'entry-price',
            'exit-price', 'index-selector', 'starting-balance', 'num-positions', 'stop-loss', 'take-profit',
            'peak-price', 'fees', 'realtime-pl-display', 'form-title', 'editing-trade-id', 'num-positions-container',
            'tags-checklist', 'accounts-modal', 'tags-modal', 'calendar-day-modal',
            'manage-tags-btn', 'close-tags-modal-btn', 'add-tag-btn', 'new-tag-name', 'new-tag-color', 'tags-list',
            'accounts-list', 'new-account-name', 'filter-instrument', 'filter-tag', 'filter-type', 'filter-outcome', 'filter-start-date', 'filter-end-date',
            'filter-status', 'journal-page', 'analytics-page', 'goals-page', 'playbook-page', 'trade-history-body', 'total-pl', 'win-rate',
            'realized-rr', 'total-trades', 'avg-profit', 'avg-loss', 'account-growth', 'current-balance',
            'profit-factor', 'expectancy', 'win-streak', 'loss-streak',
            'dailyPerformanceChart', 'hourlyPerformanceChart', 'tag-performance-body',
            'index-performance-body', 'rr-analysis-body', 'calendar-body', 'calendar-month-year',
            'mcChart', 'mc-stats', 'reversal-analysis-body', 'calendar-day-title', 'calendar-day-trades',
            'mc-trades', 'mc-simulations', 'add-goal-form', 'add-goal-btn', 'goals-list', 'goal-title', 'goal-metric', 'goal-target', 'goal-timeframe',
            'drawdownChart', 'max-drawdown-usd', 'max-drawdown-pct', 'longest-drawdown-period', 'goal-form-title', 'editing-goal-id', 'cancel-goal-edit-btn',
            'play-form-title', 'editing-play-id', 'play-title', 'play-instruments', 'play-market-condition', 'play-entry-criteria', 'play-sl-rules', 'play-management-rules',
            'play-confidence-rating', 'play-review-notes', 'play-before-image', 'play-after-image', 'play-before-file', 'play-after-file',
            'save-play-btn', 'cancel-play-edit-btn', 'playbook-list', 'playbook-select', 'mae-price', 
            'avg-mae-winners', 'total-mae-winners', 'mae-comparison-bar',
            'avg-mfe-losers', 'total-mfe-losers', 'mfe-comparison-bar',
            'custom-modal-overlay', 'custom-modal-title', 'custom-modal-text', 'custom-modal-cancel-btn', 'custom-modal-confirm-btn', 'custom-modal-input-container', 'custom-modal-input',
            'accent-color-picker', 'sl-pips', 'tp-pips', 'riskConsistencyChart', 'rr-performance-body',
            'breakeven-slider', 'breakeven-value'
        ];
        
        // --- Global DOM element reference object ---
        const dom = {};

        // --- Initial App Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            elementIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) dom[id] = el;
            });
            dom.pageButtons = document.querySelectorAll('.page-btn');

            setupEventListeners();
            
            await loadAppData(); 
            
            populateAccountSwitcher();
            loadAccountDataIntoUI();
            populatePlaybookInstrumentsSelect();
            refreshUI();
            setupManager(dom['tags-modal'], dom['tags-list'], dom['manage-tags-btn'], dom['close-tags-modal-btn'], dom['add-tag-btn'], dom['new-tag-name'], 'tags');
        
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-fade-in-up');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.animate-fade-in-up').forEach(el => observer.observe(el));
        });
        
        const getChartColors = () => {
            return {
                textColor: '#d1d5db',
                gridColor: 'rgba(255, 255, 255, 0.1)',
                tooltipBg: '#1f2937',
                tooltipText: '#f9fafb'
            };
        };

        // --- Data Management ---
        async function loadAppData() {
            await openJournalDB();
            
            const accounts = await db.getAll(STORES.accounts);
            const settings = await db.get(STORES.settings, 'appSettings');
            const activeAccount = await db.get(STORES.activeAccount, 'active');

            if (accounts.length === 0) {
                console.log("No data found in DB, initializing default structure.");
                appData = {
                    activeAccountName: 'Default Account',
                    accounts: {
                        'Default Account': {
                            name: 'Default Account',
                            trades: [],
                            startingBalance: null,
                            tags: [
                                { name: 'Strategy', color: '#8B5CF6' },
                                { name: 'Mistake', color: '#EF4444' }
                            ],
                            goals: [],
                            playbook: []
                        }
                    },
                    settings: {
                        id: 'appSettings',
                        accentColor: '#3b82f6',
                        breakevenThreshold: 2.0
                    }
                };
                await saveAppData();
            } else {
                appData.accounts = accounts.reduce((obj, acc) => {
                    obj[acc.name] = acc;
                    return obj;
                }, {});
                appData.settings = settings;
                appData.activeAccountName = activeAccount ? activeAccount.name : Object.keys(appData.accounts)[0];
            }

            if (!appData.settings) {
                 appData.settings = { id: 'appSettings', accentColor: '#3b82f6', breakevenThreshold: 2.0 };
            }
             if (appData.settings.breakevenThreshold === undefined) {
                appData.settings.breakevenThreshold = 2.0;
            }

            applyAccentColor(appData.settings.accentColor);
            dom['breakeven-slider'].value = appData.settings.breakevenThreshold;
            dom['breakeven-value'].textContent = `$${parseFloat(appData.settings.breakevenThreshold).toFixed(2)}`;
        }
        
        async function saveAppData() {
            if (!db) await openJournalDB();
            
            const tx = db.transaction([STORES.accounts, STORES.settings, STORES.activeAccount], 'readwrite');
            
            Object.values(appData.accounts).forEach(account => {
                tx.store.objectStore(STORES.accounts).put(account);
            });

            tx.store.objectStore(STORES.settings).put(appData.settings);
            tx.store.objectStore(STORES.activeAccount).put({ id: 'active', name: appData.activeAccountName });

            await tx.done;
            console.log("Data saved to IndexedDB.");
        }
        
        async function deleteAccountFromDB(accountName) {
            if (!db) await openJournalDB();
            await db.delete(STORES.accounts, accountName);
            console.log(`Account ${accountName} deleted from DB.`);
        }

        const getActiveAccount = () => {
            const accountName = appData.activeAccountName || (appData.accounts ? Object.keys(appData.accounts)[0] : null);
            if (!accountName || !appData.accounts) return { name: 'Error', trades: [], tags: [], goals: [], playbook: [] };
            const account = appData.accounts[accountName];
            if (account && !account.tags) account.tags = [];
            if (account && !account.goals) account.goals = [];
            if (account && !account.playbook) account.playbook = [];
            return account;
        };

        const getActiveTrades = () => {
            const account = getActiveAccount();
            return account ? account.trades : [];
        }

        const switchAccount = async (accountName) => {
            if (appData.accounts[accountName]) {
                appData.activeAccountName = accountName;
                await saveAppData();
                loadAccountDataIntoUI();
                refreshUI();
            }
        };

        const loadAccountDataIntoUI = () => {
            const balance = getActiveAccount().startingBalance;
            dom['starting-balance'].value = balance !== null ? balance : '';
        };

        const populateAccountSwitcher = () => {
            const switcher = dom['account-switcher'];
            if (!switcher) return;
            switcher.innerHTML = '';
            Object.keys(appData.accounts).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                switcher.appendChild(option);
            });
            switcher.value = appData.activeAccountName;
        };
        
        const populatePlaybookInstrumentsSelect = () => {
            const tradeInstrumentSelector = dom['index-selector'];
            const playbookInstrumentSelector = dom['play-instruments'];
            playbookInstrumentSelector.innerHTML = tradeInstrumentSelector.innerHTML;
        };

        // --- UI Feedback (Toast, Loader, Custom Modal) ---
        const showToast = (message, type = 'info', duration = 3000) => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span><div class="toast-progress" style="animation-duration: ${duration / 1000}s;"></div>`;
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        };
        const toggleLoader = (show) => document.getElementById('loader-overlay').classList.toggle('hidden', !show);

        const showCustomModal = ({ title, text, confirmText = 'Confirm', cancelText = 'Cancel', isPrompt = false, promptValue = '' }) => {
            return new Promise((resolve) => {
                dom['custom-modal-title'].textContent = title;
                dom['custom-modal-text'].textContent = text;
                dom['custom-modal-confirm-btn'].textContent = confirmText;
                dom['custom-modal-cancel-btn'].textContent = cancelText;

                dom['custom-modal-input-container'].classList.toggle('hidden', !isPrompt);
                dom['custom-modal-input'].value = promptValue;

                dom['custom-modal-overlay'].classList.add('open');

                const close = (value) => {
                    dom['custom-modal-overlay'].classList.remove('open');
                    dom['custom-modal-confirm-btn'].onclick = null;
                    dom['custom-modal-cancel-btn'].onclick = null;
                    resolve(value);
                };

                dom['custom-modal-confirm-btn'].onclick = () => {
                    close(isPrompt ? dom['custom-modal-input'].value : true);
                };
                dom['custom-modal-cancel-btn'].onclick = () => {
                    close(isPrompt ? null : false);
                };
            });
        };

        const calculatePL = (type, lot, entry, exit, index) => {
            if (exit === null || exit === undefined || isNaN(entry) || isNaN(exit) || isNaN(lot) || !index) return { profit: null, movement: null };
            
            let diff = exit - entry;
            if (type === 'Sell') diff = entry - exit;

            let profit;
            if (index.includes('/')) {
                profit = diff * 100000 * lot;
            } 
            else {
                profit = diff * lot;
            }
            
            let movement = Math.abs(exit - entry);
            if (index.includes('/')) {
                movement *= (index.includes('JPY') ? 100 : 10000);
            }

            return { profit, movement };
        };

        const calculateRR = (type, entry, sl, tp) => {
             if (!sl || !tp || isNaN(entry) || isNaN(sl) || isNaN(tp)) return null;
             const risk = Math.abs(entry - sl);
             const reward = Math.abs(tp - entry);
             if (risk === 0) return null;
             return reward / risk;
        };

        const formatDuration = (ms) => {
            if(ms < 0 || isNaN(ms)) return 'N/A';
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${seconds}s`;
            return `${seconds}s`;
        }

        const resetForm = () => {
            const form = dom['log-trade-btn'].closest('div.space-y-4');
            form.querySelectorAll('input, select').forEach(el => {
                if(el.type !== 'checkbox' && el.type !== 'radio' && el.id !== 'num-positions' && el.id !== 'index-selector'  && el.id !== 'playbook-select') el.value = '';
            });
            dom['num-positions'].value = '1';
            dom['trade-comments-editor'].innerHTML = '';
            dom['editing-trade-id'].value = '';
            dom['form-title'].textContent = 'Log New Trade';
            dom['log-trade-btn'].textContent = 'Log Trade';
            dom['cancel-edit-btn'].classList.add('hidden');
            dom['num-positions-container'].classList.remove('hidden');
            dom['realtime-pl-display'].innerHTML = '';
            dom['realtime-pl-display'].className = 'p-2 text-center rounded-lg h-10 transition-all';
            renderTagsChecklist();
        };

        const enterEditMode = (tradeId) => {
            const tradeToEdit = getActiveTrades().find(t => t.id === tradeId);
            if (!tradeToEdit) return;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            dom['form-title'].textContent = 'Editing Trade';
            dom['log-trade-btn'].textContent = 'Save Changes';
            dom['cancel-edit-btn'].classList.remove('hidden');
            dom['editing-trade-id'].value = tradeToEdit.id;
            dom['index-selector'].value = tradeToEdit.indexName;
            dom['lot-size'].value = tradeToEdit.lotSize;
            dom['num-positions-container'].classList.add('hidden');
            dom['entry-price'].value = tradeToEdit.entryPrice;
            dom['exit-price'].value = tradeToEdit.exitPrice !== null ? tradeToEdit.exitPrice : '';
            dom['stop-loss'].value = tradeToEdit.stopLoss || '';
            dom['take-profit'].value = tradeToEdit.takeProfit || '';
            dom['peak-price'].value = tradeToEdit.peakPrice !== null ? tradeToEdit.peakPrice : '';
            dom['mae-price'].value = tradeToEdit.maePrice !== null ? tradeToEdit.maePrice : '';
            dom['fees'].value = tradeToEdit.fees || '';
            dom['trade-comments-editor'].innerHTML = tradeToEdit.notesHTML || '';
            dom['playbook-select'].value = tradeToEdit.playId || '';
            if (tradeToEdit.tradeType === 'Buy') dom['buy-btn'].click(); else dom['sell-btn'].click();
            renderTagsChecklist(tradeToEdit.tags || []);
            updateRealtimePL();
        };
        
        const handleLogTrade = async () => {
             const lotSize = parseFloat(dom['lot-size'].value);
             const entryPrice = parseFloat(dom['entry-price'].value);
             const numPositions = parseInt(dom['num-positions'].value) || 1;
             const exitPrice = dom['exit-price'].value.trim() === '' ? null : parseFloat(dom['exit-price'].value);
             const stopLoss = dom['stop-loss'].value.trim() === '' ? null : parseFloat(dom['stop-loss'].value);
             const takeProfit = dom['take-profit'].value.trim() === '' ? null : parseFloat(dom['take-profit'].value);
             const peakPrice = dom['peak-price'].value.trim() === '' ? null : parseFloat(dom['peak-price'].value);
             const maePrice = dom['mae-price'].value.trim() === '' ? null : parseFloat(dom['mae-price'].value);
             const fees = dom['fees'].value.trim() === '' ? 0 : parseFloat(dom['fees'].value);
             const notesHTML = dom['trade-comments-editor'].innerHTML.trim();
             const playId = dom['playbook-select'].value || null;

             const selectedTags = Array.from(dom['tags-checklist'].querySelectorAll('input:checked')).map(cb => cb.value);

             if (isNaN(lotSize) || isNaN(entryPrice) || lotSize <= 0) { showToast("Please enter a valid Lot Size and Entry Price.", "error"); return; }
             
             const editingId = dom['editing-trade-id'].value;
             const activeAccount = getActiveAccount();

             if (editingId) {
                  const tradeIndex = activeAccount.trades.findIndex(t => t.id === editingId);
                  if (tradeIndex > -1) {
                      const originalTrade = activeAccount.trades[tradeIndex];
                      let exitTimestamp = originalTrade.exitTimestamp;
                      if (originalTrade.exitPrice === null && exitPrice !== null) exitTimestamp = new Date().toISOString();
                      if (originalTrade.exitPrice !== null && exitPrice === null) exitTimestamp = null;
                      
                      let { profit: profitLoss, movement: pointsMoved } = calculatePL(tradeType, lotSize, entryPrice, exitPrice, dom['index-selector'].value);
                      if(profitLoss !== null) profitLoss -= fees;
                      const rrRatio = calculateRR(tradeType, entryPrice, stopLoss, takeProfit);
                      
                      activeAccount.trades[tradeIndex] = { ...originalTrade, indexName: dom['index-selector'].value, tradeType, lotSize, entryPrice, exitPrice, exitTimestamp, stopLoss, takeProfit, peakPrice, maePrice, fees, profitLoss, pointsMoved, rrRatio, tags: selectedTags, playId, notesHTML };
                      showToast("Trade updated successfully!", "success");
                  }
             } else {
                   for (let i = 0; i < numPositions; i++) {
                       let { profit: profitLoss, movement: pointsMoved } = calculatePL(tradeType, lotSize, entryPrice, exitPrice, dom['index-selector'].value);
                       if(profitLoss !== null) profitLoss -= fees;
                       const rrRatio = calculateRR(tradeType, entryPrice, stopLoss, takeProfit);
                       
                       activeAccount.trades.push({
                           id: crypto.randomUUID(),
                           timestamp: new Date().toISOString(),
                           exitTimestamp: exitPrice !== null ? new Date().toISOString() : null,
                           indexName: dom['index-selector'].value, tradeType, lotSize, entryPrice, exitPrice, stopLoss, takeProfit, peakPrice, maePrice, fees, profitLoss, pointsMoved, rrRatio, tags: selectedTags, playId, notesHTML
                       });
                   }
                   showToast(`${numPositions} trade(s) logged successfully!`, "success");
             }
             await saveAppData();
             refreshUI();
             resetForm();
        };
        
        const updateRealtimePL = () => {
            const display = dom['realtime-pl-display'];
            const lot = parseFloat(dom['lot-size'].value);
            const entry = parseFloat(dom['entry-price'].value);
            const exit = parseFloat(dom['exit-price'].value);
            const index = dom['index-selector'].value;

            const { profit } = calculatePL(tradeType, lot, entry, exit, index);

            if (profit === null) {
                display.innerHTML = '';
                display.className = 'p-2 text-center rounded-lg h-10 transition-all';
                return;
            }

            const plText = `P/L: $${profit.toFixed(2)}`;
            if (profit > 0) {
                display.className = 'p-2 text-center rounded-lg h-10 transition-all bg-green-900/50 text-green-400 font-semibold';
            } else if (profit < 0) {
                display.className = 'p-2 text-center rounded-lg h-10 transition-all bg-red-900/50 text-red-400 font-semibold';
            } else {
                display.className = 'p-2 text-center rounded-lg h-10 transition-all bg-gray-700 font-semibold';
            }
            display.innerHTML = plText;
        };

        const setupEventListeners = () => {
            dom['buy-btn'].addEventListener('click', () => { 
                tradeType = 'Buy'; 
                dom['buy-btn'].className = 'trade-type-btn bg-blue-500 text-white p-2 rounded-lg btn'; 
                dom['sell-btn'].className = 'trade-type-btn bg-gray-700 text-gray-300 p-2 rounded-lg btn'; 
                updateRealtimePL();
                clearPipInputs();
            });
            dom['sell-btn'].addEventListener('click', () => { 
                tradeType = 'Sell'; 
                dom['sell-btn'].className = 'trade-type-btn bg-red-500 text-white p-2 rounded-lg btn'; 
                dom['buy-btn'].className = 'trade-type-btn bg-gray-700 text-gray-300 p-2 rounded-lg btn'; 
                updateRealtimePL(); 
                clearPipInputs();
            });
            
            ['lot-size', 'entry-price', 'exit-price', 'index-selector'].forEach(id => {
                if(dom[id]) dom[id].addEventListener('input', updateRealtimePL)
            });
            
            ['entry-price', 'index-selector'].forEach(id => {
                if(dom[id]) dom[id].addEventListener('input', clearPipInputs);
            });

            dom['sl-pips'].addEventListener('input', () => calculatePriceFromPips('sl'));
            dom['tp-pips'].addEventListener('input', () => calculatePriceFromPips('tp'));

            dom['log-trade-btn'].addEventListener('click', handleLogTrade);
            dom['cancel-edit-btn'].addEventListener('click', resetForm);
            
            dom['save-balance-btn'].addEventListener('click', async () => {
                const newBalance = parseFloat(dom['starting-balance'].value);
                if (isNaN(newBalance) || newBalance < 0) { showToast('Please enter a valid starting balance.', 'error'); return; }
                getActiveAccount().startingBalance = newBalance;
                await saveAppData();
                refreshUI();
                showToast('Balance saved!', 'success');
            });

            dom['save-data-btn'].addEventListener('click', async () => {
                await saveAppData();
                showToast("Data saved successfully!", "success");
            });
            
            dom.pageButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const page = button.dataset.page;
                    dom.pageButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.remove('text-white');
                        btn.classList.add('text-gray-300');
                    });
                    button.classList.add('active', 'text-white');
                    dom['journal-page'].classList.toggle('hidden', page !== 'journal');
                    dom['analytics-page'].classList.toggle('hidden', page !== 'analytics');
                    dom['goals-page'].classList.toggle('hidden', page !== 'goals');
                    dom['playbook-page'].classList.toggle('hidden', page !== 'playbook');
                    refreshUI();
                });
            });
            
            const settingsMenuBtn = dom['settings-menu-btn'];
            const settingsMenuPanel = dom['settings-menu-panel'];
            settingsMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                settingsMenuPanel.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (settingsMenuBtn && !settingsMenuBtn.contains(e.target) && settingsMenuPanel && !settingsMenuPanel.contains(e.target)) {
                    settingsMenuPanel.classList.add('hidden');
                }
            });
            
            dom['manage-accounts-btn'].addEventListener('click', () => { renderAccountsList(); dom['accounts-modal'].classList.remove('hidden'); });
            dom['close-accounts-modal-btn'].addEventListener('click', () => dom['accounts-modal'].classList.add('hidden'));
            dom['add-account-btn'].addEventListener('click', () => {
                addAccount(dom['new-account-name'].value);
                dom['new-account-name'].value = '';
                renderAccountsList();
            });
            dom['account-switcher'].addEventListener('change', () => switchAccount(dom['account-switcher'].value));
            
            dom['prev-month-btn'].addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); updateTradeCalendar(); });
            dom['next-month-btn'].addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); updateTradeCalendar(); });
            dom['calendar-date-picker'].addEventListener('change', (e) => {
                const selected = new Date(e.target.value);
                const tzoffset = selected.getTimezoneOffset() * 60000;
                calendarDate = new Date(selected.getTime() + tzoffset);
                updateTradeCalendar();
            });
            dom['close-day-modal-btn'].addEventListener('click', () => dom['calendar-day-modal'].classList.add('hidden'));

            dom['export-btn'].addEventListener('click', exportData);
            dom['import-file'].addEventListener('change', importData);
            dom['export-pdf-btn'].addEventListener('click', generatePDF);

            ['filter-instrument', 'filter-tag', 'filter-type', 'filter-outcome', 'filter-start-date', 'filter-end-date'].forEach(id => {
               if(dom[id]) dom[id].addEventListener('change', refreshUI);
            });
            dom['reset-filters-btn'].addEventListener('click', () => {
                ['filter-instrument', 'filter-tag', 'filter-type', 'filter-outcome', 'filter-start-date', 'filter-end-date'].forEach(id => dom[id].value = '');
                refreshUI();
            });
            
            dom['run-mc-btn'].addEventListener('click', runMonteCarlo);
            
            const editor = dom['trade-comments-editor'];
            editor.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); editor.classList.add('dragover'); });
            editor.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); editor.classList.remove('dragover'); });
            editor.addEventListener('drop', handleImageDrop);
            editor.addEventListener('paste', handleImagePaste);

            dom['add-goal-btn'].addEventListener('click', handleSaveGoal);
            dom['cancel-goal-edit-btn'].addEventListener('click', resetGoalForm);

            dom['save-play-btn'].addEventListener('click', handleSavePlay);
            dom['cancel-play-edit-btn'].addEventListener('click', resetPlayForm);
            setupImageDropzone('play-before-image', 'play-before-file');
            setupImageDropzone('play-after-image', 'play-after-file');

            dom['accent-color-picker'].addEventListener('input', async (e) => {
                const newColor = e.target.value;
                appData.settings.accentColor = newColor;
                applyAccentColor(newColor);
                await saveAppData();
            });

            dom['breakeven-slider'].addEventListener('input', async (e) => {
                const value = parseFloat(e.target.value);
                appData.settings.breakevenThreshold = value;
                dom['breakeven-value'].textContent = `$${value.toFixed(2)}`;
                await saveAppData();
                refreshUI();
            });
        };
        
        const handleImageDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const editor = dom['trade-comments-editor'];
            editor.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        editor.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        };

        const handleImagePaste = (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                         document.execCommand('insertHTML', false, `<img src="${e.target.result}" style="max-width: 100%; border-radius: 0.5rem; margin: 1rem 0;">`);
                    };
                    reader.readAsDataURL(file);
                    e.preventDefault();
                    break;
                }
            }
        };

        const refreshUI = () => {
            const filteredTrades = applyFilters();
            const allTrades = getActiveTrades();
            
            renderTrades(filteredTrades);
            renderTagsChecklist();
            updateFilterDropdowns();
            populatePlaybookSelect();

            updateSummary(filteredTrades);
            updateAccountGrowth(allTrades);
            
            if (!dom['analytics-page'].classList.contains('hidden')) {
                setTimeout(() => {
                    if (!dom['analytics-page'].classList.contains('hidden')) {
                        updateDrawdownAnalysis(allTrades);
                        updateAdvancedAnalytics(allTrades);
                        updateTagAnalysis(allTrades);
                        updateIndexSummary(allTrades);
                        updateRRAnalysis(allTrades);
                        updateRRPerformanceAnalysis(allTrades);
                        updateTradeCalendar();
                        updateReversalAnalysis(allTrades);
                        updateExcursionAnalysis(allTrades);
                        updateRiskConsistencyTracker(allTrades);
                    }
                }, 0); 
            } else {
                if (drawdownChart) { drawdownChart.destroy(); drawdownChart = null; }
                if (riskConsistencyChart) { riskConsistencyChart.destroy(); riskConsistencyChart = null; }
            }

            if (!dom['goals-page'].classList.contains('hidden')) {
                updateGoals();
            }

            if (!dom['playbook-page'].classList.contains('hidden')) {
                updatePlaybook();
            }
        };

        const renderTrades = (tradesToRender) => {
            const tradeHistoryBody = dom['trade-history-body'];
            tradeHistoryBody.innerHTML = '';
            if (tradesToRender.length === 0) { 
                tradeHistoryBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-8">No trades match the current filters.</td></tr>`; 
                return;
            }
            
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

            const fragment = document.createDocumentFragment();
            tradesToRender.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800/50 border-b border-gray-700/50';
                
                const isClosed = trade.profitLoss !== null;
                let plText, plClass;
                if (!isClosed) { plText = 'Open'; plClass = 'text-gray-400'; } 
                else if (trade.profitLoss > 0 && trade.profitLoss <= breakevenThreshold) { plText = 'Breakeven'; plClass = 'text-blue-500'; }
                else if (trade.profitLoss > breakevenThreshold) { plText = `$${trade.profitLoss.toFixed(2)}`; plClass = 'text-green-500'; }
                else { plText = `$${trade.profitLoss.toFixed(2)}`; plClass = 'text-red-500'; }
                
                const rrText = trade.rrRatio ? `1 : ${trade.rrRatio.toFixed(2)}` : '-';
                const typeClass = trade.tradeType === 'Buy' ? 'bg-blue-900/50 text-blue-300' : 'bg-red-900/50 text-red-300';
                const tradeDate = new Date(trade.timestamp).toLocaleString('en-GB', { timeZone: 'Africa/Accra', dateStyle: 'medium', timeStyle: 'short' });
                
                const allTags = getActiveAccount().tags || [];
                const tagSpans = (trade.tags && trade.tags.length > 0) ? `<div class="flex flex-wrap gap-1 mt-1">${trade.tags.map(tagName => {
                    const tagInfo = allTags.find(t => t.name === tagName);
                    const color = tagInfo ? tagInfo.color : '#8B5CF6';
                    return `<span class="text-xs px-2 py-0.5 rounded-full font-semibold" style="background-color: ${color}33; color: ${color};">${tagName}</span>`;
                }).join('')}</div>` : '';


                row.innerHTML = `
                    <td class="px-4 py-3 align-top">
                        <div class="font-medium text-gray-100">${trade.indexName}</div>
                        <div class="text-xs text-gray-400">${tradeDate}</div>
                        ${tagSpans}
                    </td>
                    <td class="px-4 py-3 align-top"><span class="px-2 py-1 text-xs font-semibold rounded-full ${typeClass}">${trade.tradeType}</span></td>
                    <td class="px-4 py-3 font-medium align-top text-gray-300">${rrText}</td>
                    <td class="px-4 py-3 font-bold align-top ${plClass}">${plText}</td>
                    <td class="px-4 py-3 align-top">
                        <div class="flex items-center space-x-2">
                            <button class="details-btn text-blue-500 hover:underline text-sm font-semibold">View</button>
                            <button class="edit-trade-btn text-gray-500 hover:text-green-500" data-id="${trade.id}" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="delete-trade-btn text-gray-500 hover:text-red-500" data-id="${trade.id}" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div>
                    </td>`;
                
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'details-row bg-gray-900';
                detailsRow.innerHTML = `<td colspan="5"><div class="details-content"><div class="rendered-notes prose dark:prose-invert max-w-none">${trade.notesHTML || '<p class="text-gray-400">No notes or screenshots added.</p>'}</div></div></td>`;
                
                fragment.appendChild(row);
                fragment.appendChild(detailsRow);
            });

            tradeHistoryBody.appendChild(fragment);
            
            tradeHistoryBody.querySelectorAll('.details-btn').forEach(btn => btn.addEventListener('click', (e) => e.currentTarget.closest('tr').nextElementSibling.classList.toggle('open')));
            tradeHistoryBody.querySelectorAll('.edit-trade-btn').forEach(btn => btn.addEventListener('click', (e) => enterEditMode(e.currentTarget.dataset.id)));
            tradeHistoryBody.querySelectorAll('.delete-trade-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const tradeIdToDelete = e.currentTarget.dataset.id;
                    const confirmed = await showCustomModal({
                        title: 'Delete Trade',
                        text: 'Are you sure you want to delete this trade? This action cannot be undone.',
                        confirmText: 'Delete',
                    });

                    if (confirmed) {
                        const activeAccount = getActiveAccount();
                        const tradeIndex = activeAccount.trades.findIndex(t => t.id === tradeIdToDelete);
                        if(tradeIndex > -1) {
                            activeAccount.trades.splice(tradeIndex, 1);
                            await saveAppData();
                            refreshUI();
                            showToast("Trade deleted", "info");
                        }
                    }
                });
            });
        };
        
        const updateSummary = (trades) => {
             const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
             const totalTradesEl = dom['total-trades'];
             totalTradesEl.textContent = trades.length;
             const closedTrades = trades.filter(t => t.profitLoss !== null);
             const totalPL = closedTrades.reduce((acc, trade) => acc + trade.profitLoss, 0);
             const winningTrades = closedTrades.filter(trade => trade.profitLoss > breakevenThreshold);
             const losingTrades = closedTrades.filter(trade => trade.profitLoss <= 0);
             const totalProfit = winningTrades.reduce((acc, trade) => acc + trade.profitLoss, 0);
             const totalLoss = losingTrades.reduce((acc, trade) => acc + trade.profitLoss, 0);
             const avgProfit = winningTrades.length > 0 ? totalProfit / winningTrades.length : 0;
             const avgLoss = losingTrades.length > 0 ? Math.abs(totalLoss / losingTrades.length) : 0;
             const countableTrades = winningTrades.length + losingTrades.length;
             const winRate = countableTrades > 0 ? (winningTrades.length / countableTrades) * 100 : 0;
             const realizedRR = avgLoss > 0 ? avgProfit / avgLoss : 0;

             const totalPlEl = dom['total-pl'];
             totalPlEl.textContent = `$${totalPL.toFixed(2)}`;
             totalPlEl.className = `text-2xl font-bold ${totalPL >= 0 ? 'text-green-500' : 'text-red-500'}`;
             dom['win-rate'].textContent = `${winRate.toFixed(1)}%`;
             const realizedRrEl = dom['realized-rr'];
             realizedRrEl.textContent = `1 : ${realizedRR.toFixed(2)}`;
             realizedRrEl.className = `text-2xl font-bold ${realizedRR >= 1 ? 'text-green-500' : 'text-red-500'}`;
             dom['avg-profit'].textContent = `$${avgProfit.toFixed(2)}`;
             dom['avg-loss'].textContent = `$${avgLoss.toFixed(2)}`;
        };
        
        const updateTradeCalendar = () => {
             const allTrades = getActiveTrades();
             const year = calendarDate.getFullYear();
             const month = calendarDate.getMonth();

             dom['calendar-month-year'].textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric'});
             dom['calendar-date-picker'].value = calendarDate.toISOString().split('T')[0];
             const calendarBody = dom['calendar-body'];
             calendarBody.innerHTML = '';

             const firstDay = new Date(year, month, 1).getDay();
             const daysInMonth = new Date(year, month + 1, 0).getDate();

             const dailyPL = allTrades.filter(t => t.profitLoss !== null).reduce((acc, trade) => {
                  const tradeDate = new Date(trade.timestamp);
                  if (tradeDate.getFullYear() === year && tradeDate.getMonth() === month) {
                      const day = tradeDate.getDate();
                      acc[day] = (acc[day] || 0) + trade.profitLoss;
                  }
                  return acc;
             }, {});
             
             for(let i = 0; i < firstDay; i++) { calendarBody.innerHTML += `<div></div>`; }

             for(let day = 1; day <= daysInMonth; day++) {
                 const pl = dailyPL[day];
                 let bgColor = 'bg-gray-800/50 hover:bg-gray-700/50';
                 if (pl > 0) bgColor = 'bg-green-800/60 hover:bg-green-700/60';
                 else if (pl < 0) bgColor = 'bg-red-800/60 hover:bg-red-700/60';

                 const dayDiv = document.createElement('div');
                 dayDiv.className = `p-2 border border-gray-700/50 rounded-md cursor-pointer transition-colors ${bgColor}`;
                 dayDiv.innerHTML = `<div class="font-semibold text-gray-200">${day}</div><div class="text-xs mt-1 font-bold ${pl > 0 ? 'text-green-300' : (pl < 0 ? 'text-red-300' : 'text-gray-400')}">${pl ? `$${pl.toFixed(2)}` : ''}</div>`;
                 
                 dayDiv.onclick = () => showTradesForDay(new Date(year, month, day));
                 calendarBody.appendChild(dayDiv);
             }
        };

        const generatePDF = async () => {
             toggleLoader(true);
             const { jsPDF } = window.jspdf;
             const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4', hotfixes: ['px_scaling'] });

             const content = dom['analytics-content-for-pdf'];
             
             await new Promise(resolve => setTimeout(resolve, 100));

             try {
                 const canvas = await html2canvas(content, { scale: 2, backgroundColor: '#111827', useCORS: true, windowWidth: 1200 });
                 const imgData = canvas.toDataURL('image/jpeg', 0.9);
                 const pdfWidth = pdf.internal.pageSize.getWidth();
                 const pdfHeight = pdf.internal.pageSize.getHeight();
                 const imgProps = pdf.getImageProperties(imgData);
                 const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                 let heightLeft = imgHeight;
                 let position = 0;

                 pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                 heightLeft -= pdfHeight;

                 while (heightLeft > 0) {
                     position = heightLeft - imgHeight;
                     pdf.addPage();
                     pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                     heightLeft -= pdfHeight;
                 }
                 pdf.save(`prolific-journal-report-${new Date().toISOString().split('T')[0]}.pdf`);
                 showToast("PDF report generated!", "success");
             } catch(e) {
                 showToast("Error generating PDF.", "error");
                 console.error(e);
             } finally {
                 toggleLoader(false);
             }
        };
        
        const addAccount = async (accountName) => {
            if (!accountName.trim()) { showToast("Account name cannot be empty.", "error"); return; }
            if (appData.accounts[accountName]) { showToast("An account with this name already exists.", "error"); return; }
            const newAccount = { 
                name: accountName,
                trades: [], 
                startingBalance: null, 
                tags: [
                    { name: 'Strategy', color: '#8B5CF6' },
                    { name: 'Mistake', color: '#EF4444' }
                ],
                goals: [],
                playbook: []
            };
            appData.accounts[accountName] = newAccount;
            populateAccountSwitcher();
            await switchAccount(accountName);
            showToast(`Account "${accountName}" created.`, "success");
        };

        const deleteAccount = async (accountName) => {
            if (Object.keys(appData.accounts).length <= 1) { showToast("You cannot delete the only remaining account.", "error"); return; }
            delete appData.accounts[accountName];
            await deleteAccountFromDB(accountName);
            appData.activeAccountName = Object.keys(appData.accounts)[0];
            populateAccountSwitcher();
            await switchAccount(appData.activeAccountName);
        };
        
        const renameAccount = async (oldName, newName) => {
            if (!newName.trim()) { showToast("New name cannot be empty.", "error"); return; }
            if (appData.accounts[newName]) { showToast("An account with this name already exists.", "error"); return; }
            
            appData.accounts[newName] = { ...appData.accounts[oldName], name: newName };
            delete appData.accounts[oldName];
            await deleteAccountFromDB(oldName);
            
            if (appData.activeAccountName === oldName) {
                appData.activeAccountName = newName;
            }
            populateAccountSwitcher();
            await saveAppData();
        };

        const renderAccountsList = () => {
            const container = dom['accounts-list'];
            container.innerHTML = '';
            Object.keys(appData.accounts).forEach(name => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-700 rounded-md';
                div.innerHTML = `<span class="font-semibold">${name}</span>
                    <div>
                        <button class="rename-account-btn p-1 text-gray-400 hover:text-green-500" data-name="${name}">Rename</button>
                        <button class="delete-account-btn p-1 text-gray-400 hover:text-red-500" data-name="${name}">Delete</button>
                    </div>`;
                container.appendChild(div);
            });

            container.querySelectorAll('.delete-account-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const accountName = e.currentTarget.dataset.name;
                const confirmed = await showCustomModal({
                    title: `Delete Account "${accountName}"`,
                    text: 'Are you sure? All trades and data for this account will be permanently deleted. This action cannot be undone.',
                    confirmText: 'Delete Account'
                });
                if (confirmed) {
                    await deleteAccount(accountName);
                    renderAccountsList();
                }
            }));
            
            container.querySelectorAll('.rename-account-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const oldName = e.currentTarget.dataset.name;
                const newName = await showCustomModal({
                    title: 'Rename Account',
                    text: `Enter a new name for "${oldName}":`,
                    isPrompt: true,
                    promptValue: oldName,
                    confirmText: 'Rename'
                });
                if(newName && newName !== oldName) {
                    await renameAccount(oldName, newName);
                    renderAccountsList();
                }
            }));
        };

        const updateAdvancedAnalytics = (allTrades) => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const closedTrades = allTrades.filter(t => t.profitLoss !== null);
            if (closedTrades.length === 0) return;

            const winningTrades = closedTrades.filter(t => t.profitLoss > breakevenThreshold);
            const losingTrades = closedTrades.filter(t => t.profitLoss <= 0);
            
            const grossProfit = winningTrades.reduce((sum, t) => sum + t.profitLoss, 0);
            const grossLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.profitLoss, 0));
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : Infinity;

            const winRate = (winningTrades.length + losingTrades.length) > 0 ? winningTrades.length / (winningTrades.length + losingTrades.length) : 0;
            const lossRate = 1 - winRate;
            const avgWin = winningTrades.length > 0 ? grossProfit / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? grossLoss / losingTrades.length : 0;
            const expectancy = (winRate * avgWin) - (lossRate * avgLoss);

            dom['profit-factor'].textContent = profitFactor === Infinity ? '∞' : profitFactor.toFixed(2);
            dom['expectancy'].textContent = `$${expectancy.toFixed(2)}`;

            let maxWinStreak = 0, currentWinStreak = 0, maxLossStreak = 0, currentLossStreak = 0;
            closedTrades.forEach(trade => {
                if (trade.profitLoss > breakevenThreshold) { currentWinStreak++; currentLossStreak = 0; maxWinStreak = Math.max(maxWinStreak, currentWinStreak); } 
                else if (trade.profitLoss <= 0) { currentLossStreak++; currentWinStreak = 0; maxLossStreak = Math.max(maxLossStreak, currentLossStreak); }
            });
            dom['win-streak'].textContent = maxWinStreak;
            dom['loss-streak'].textContent = maxLossStreak;

            const chartOptions = getChartColors();
            
            const dailyStats = { 'Sun': 0, 'Mon': 0, 'Tue': 0, 'Wed': 0, 'Thu': 0, 'Fri': 0, 'Sat': 0 };
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            closedTrades.forEach(t => dailyStats[days[new Date(t.timestamp).getDay()]] += t.profitLoss);
            const dailyData = Object.values(dailyStats);
            if(dailyPerfChart) dailyPerfChart.destroy();
            dailyPerfChart = new Chart(dom['dailyPerformanceChart'], {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Total P/L by Day',
                        data: dailyData,
                        backgroundColor: dailyData.map(v => v >= 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)'),
                    }]
                },
                options: { scales: { y: { beginAtZero: true, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } }, x: { grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } } }, plugins: { legend: { display: false } } }
            });

            const hourlyStats = Array(24).fill(0);
            closedTrades.forEach(t => hourlyStats[new Date(t.timestamp).getHours()] += t.profitLoss);
            if(hourlyPerfChart) hourlyPerfChart.destroy();
            hourlyPerfChart = new Chart(dom['hourlyPerformanceChart'], {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Total P/L by Hour',
                        data: hourlyStats,
                        backgroundColor: hourlyStats.map(v => v >= 0 ? 'rgba(59, 130, 246, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
                    }]
                },
                options: { scales: { y: { beginAtZero: true, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } }, x: { grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } } }, plugins: { legend: { display: false } } }
            });
        };
        
        const updateTagAnalysis = (allTrades) => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const body = dom['tag-performance-body'];
            body.innerHTML = '';
            const tradesWithTags = allTrades.filter(t => t.profitLoss !== null && t.tags && t.tags.length > 0);
            if(tradesWithTags.length === 0) { body.innerHTML = '<p class="text-center text-gray-400 py-4 col-span-full">No trades with tags to analyze.</p>'; return; }

            const stats = tradesWithTags.reduce((acc, trade) => {
                trade.tags.forEach(tag => {
                    if(!acc[tag]) acc[tag] = { trades: 0, totalPL: 0, wins: 0, losses: 0 };
                    acc[tag].trades++;
                    acc[tag].totalPL += trade.profitLoss;
                    if(trade.profitLoss > breakevenThreshold) acc[tag].wins++;
                    else if (trade.profitLoss <= 0) acc[tag].losses++;
                });
                return acc;
            }, {});
            
            const allTags = getActiveAccount().tags || [];
            Object.entries(stats).sort((a,b) => b[1].totalPL - a[1].totalPL).forEach(([tag, data]) => {
                const plClass = data.totalPL >= 0 ? 'text-green-500' : 'text-red-500';
                const winRate = (data.wins + data.losses) > 0 ? (data.wins / (data.wins + data.losses)) * 100 : 0;
                const tagInfo = allTags.find(t => t.name === tag);
                const color = tagInfo ? tagInfo.color : '#8B5CF6';
                const statCard = document.createElement('div');
                statCard.className = 'bg-gray-800/50 p-4 rounded-lg border border-gray-700/50';
                statCard.innerHTML = `
                    <h3 class="font-bold" style="color: ${color};">${tag}</h3>
                    <div class="mt-2 space-y-1 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">Total P/L:</span><span class="font-semibold ${plClass}">$${data.totalPL.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Win Rate:</span><span class="font-semibold text-gray-300">${winRate.toFixed(1)}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Trades:</span><span class="font-semibold text-gray-300">${data.trades}</span></div>
                    </div>`;
                body.appendChild(statCard);
            });
        };

        const updateIndexSummary = (allTrades) => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const body = dom['index-performance-body'];
            body.innerHTML = '';
            const closedTrades = allTrades.filter(t => t.profitLoss !== null);
            if(closedTrades.length === 0) { body.innerHTML = '<p class="text-center text-gray-400 py-4 col-span-full">No closed trades to analyze.</p>'; return; }

            const stats = closedTrades.reduce((acc, trade) => {
                if(!acc[trade.indexName]) acc[trade.indexName] = { trades: 0, totalPL: 0, wins: 0, losses: 0 };
                acc[trade.indexName].trades++;
                acc[trade.indexName].totalPL += trade.profitLoss;
                if(trade.profitLoss > breakevenThreshold) acc[trade.indexName].wins++;
                else if (trade.profitLoss <= 0) acc[trade.indexName].losses++;
                return acc;
            }, {});

            Object.entries(stats).sort((a,b) => b[1].totalPL - a[1].totalPL).forEach(([instrument, data]) => {
                const plClass = data.totalPL >= 0 ? 'text-green-500' : 'text-red-500';
                const winRate = (data.wins + data.losses) > 0 ? (data.wins / (data.wins + data.losses)) * 100 : 0;
                const statCard = document.createElement('div');
                statCard.className = 'bg-gray-800/50 p-4 rounded-lg border border-gray-700/50';
                statCard.innerHTML = `
                    <h3 class="font-bold text-gray-100">${instrument}</h3>
                    <div class="mt-2 space-y-1 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">Total P/L:</span><span class="font-semibold ${plClass}">$${data.totalPL.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Win Rate:</span><span class="font-semibold text-gray-300">${winRate.toFixed(1)}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Trades:</span><span class="font-semibold text-gray-300">${data.trades}</span></div>
                    </div>`;
                body.appendChild(statCard);
            });
           };
        const updateRRAnalysis = (allTrades) => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const rrAnalysisBody = dom['rr-analysis-body'];
            rrAnalysisBody.innerHTML = '';
            const rrTrades = allTrades.filter(t => t.rrRatio !== null && t.rrRatio > 0 && t.profitLoss !== null);

            if (rrTrades.length === 0) {
                rrAnalysisBody.innerHTML = '<p class="text-center text-gray-400 py-4 col-span-full">No trades with Planned R:R data to analyze.</p>';
                return;
            }

            const totalPlannedRR = rrTrades.reduce((acc, t) => acc + t.rrRatio, 0);
            const avgPlannedRR = totalPlannedRR / rrTrades.length;
            
            const winningTrades = rrTrades.filter(t => t.profitLoss > breakevenThreshold);
            const losingTrades = rrTrades.filter(t => t.profitLoss <= 0);
            const totalProfit = winningTrades.reduce((acc, t) => acc + t.profitLoss, 0);
            const totalLoss = losingTrades.reduce((acc, t) => t.profitLoss, 0);
            const avgProfit = winningTrades.length > 0 ? totalProfit / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? Math.abs(totalLoss / losingTrades.length) : 0;
            const realizedRR = avgLoss > 0 ? avgProfit / avgLoss : 0;


            const totalCard = document.createElement('div');
            totalCard.className = 'col-span-full bg-blue-900/30 p-4 rounded-lg border border-blue-800/50 mb-4 grid grid-cols-2 gap-4';
            totalCard.innerHTML = `
                <div class="text-center">
                    <p class="text-xs text-blue-300 font-semibold uppercase">Avg. Planned R:R</p>
                    <p class="text-2xl font-bold text-blue-400">1 : ${avgPlannedRR.toFixed(2)}</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-blue-300 font-semibold uppercase">Avg. Realized R:R</p>
                    <p class="text-2xl font-bold ${realizedRR >= avgPlannedRR ? 'text-green-500' : 'text-red-500'}">1 : ${realizedRR.toFixed(2)}</p>
                </div>`;
            rrAnalysisBody.appendChild(totalCard);
        };
        const showTradesForDay = (date) => {
            dom['calendar-day-title'].textContent = `Trades for ${date.toLocaleDateString('en-US', { dateStyle: 'full' })}`;
            const tradesContainer = dom['calendar-day-trades'];
            tradesContainer.innerHTML = '';

            const tradesForDay = getActiveTrades().filter(trade => {
                const tradeDate = new Date(trade.timestamp);
                return tradeDate.getFullYear() === date.getFullYear() &&
                       tradeDate.getMonth() === date.getMonth() &&
                       tradeDate.getDate() === date.getDate();
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (tradesForDay.length === 0) {
                tradesContainer.innerHTML = '<p class="text-center text-gray-500">No trades on this day.</p>';
            } else {
                const fragment = document.createDocumentFragment();
                tradesForDay.forEach(trade => {
                    const isClosed = trade.profitLoss !== null;
                    let plText, plClass;
                    if (!isClosed) { plText = 'Open'; plClass = 'text-gray-400'; } 
                    else if (trade.profitLoss > 0) { plText = `$${trade.profitLoss.toFixed(2)}`; plClass = 'text-green-500'; }
                    else { plText = `$${trade.profitLoss.toFixed(2)}`; plClass = 'text-red-500'; }
                    
                    const div = document.createElement('div');
                    div.className = 'bg-gray-900/50 p-3 rounded-lg border border-gray-700/50 mb-2 flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-100">${trade.indexName} <span class="text-xs ${trade.tradeType === 'Buy' ? 'text-blue-400' : 'text-red-400'}">(${trade.tradeType})</span></p>
                            <p class="text-xs text-gray-400">Entry: ${trade.entryPrice} | Exit: ${trade.exitPrice || 'N/A'}</p>
                        </div>
                        <p class="font-bold ${plClass}">${plText}</p>
                    `;
                    fragment.appendChild(div);
                });
                tradesContainer.appendChild(fragment);
            }
            dom['calendar-day-modal'].classList.remove('hidden');
        };
        const updateReversalAnalysis = (allTrades) => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const body = dom['reversal-analysis-body'];
            body.innerHTML = '';

            const reversedTrades = allTrades.filter(t => 
                t.profitLoss <= breakevenThreshold && 
                t.peakPrice !== null && 
                !isNaN(t.peakPrice) &&
                calculatePL(t.tradeType, t.lotSize, t.entryPrice, t.peakPrice, t.indexName).profit > 0
            );

            if (reversedTrades.length === 0) {
                body.innerHTML = '<p class="text-center text-gray-400 py-4 col-span-full">No reversed trades with potential profit to analyze.</p>';
                return;
            }

            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            const weeklyReversals = reversedTrades.filter(t => new Date(t.timestamp) >= startOfWeek);
            const monthlyReversals = reversedTrades.filter(t => new Date(t.timestamp) >= startOfMonth);
            const yearlyReversals = reversedTrades.filter(t => new Date(t.timestamp) >= startOfYear);
            
            const createAnalysisCard = (trades, periodName) => {
                if (trades.length === 0) {
                    return `<div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700/50">
                                <h3 class="font-bold text-lg text-gray-100">${periodName}</h3>
                                <p class="mt-2 text-sm text-gray-400">No reversals in this period.</p>
                            </div>`;
                }

                let totalPotentialProfit = 0;
                let totalHoldTime = 0;
                const tagFreq = {};
                const assetFreq = {};

                trades.forEach(trade => {
                    const { profit: peakProfit } = calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.peakPrice, trade.indexName);
                    if (peakProfit > 0) totalPotentialProfit += (peakProfit - (trade.profitLoss > 0 ? trade.profitLoss : 0));
                    
                    if(trade.exitTimestamp) {
                        totalHoldTime += new Date(trade.exitTimestamp) - new Date(trade.timestamp);
                    }

                    (trade.tags || []).forEach(t => tagFreq[t] = (tagFreq[t] || 0) + 1);
                    assetFreq[trade.indexName] = (assetFreq[trade.indexName] || 0) + 1;
                });
                
                const findTopItem = (freqMap) => Object.keys(freqMap).length > 0 ? Object.entries(freqMap).sort((a,b) => b[1] - a[1])[0][0] : 'N/A';
                
                const topTag = findTopItem(tagFreq);
                const topAsset = findTopItem(assetFreq);
                const avgHoldTime = totalHoldTime / trades.length;

                return `<div class="bg-orange-900/20 p-4 rounded-lg border border-orange-800/30">
                            <h3 class="font-bold text-lg text-orange-300">${periodName} (${trades.length} Reversals)</h3>
                            <div class="mt-2 space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Profit Slipped:</span><span class="font-semibold text-orange-400">$${totalPotentialProfit.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Avg. Hold Time:</span><span class="font-semibold text-orange-400">${formatDuration(avgHoldTime)}</span></div>
                                <hr class="my-1 border-orange-800/30">
                                <div class="flex justify-between"><span class="text-gray-400">Top Reversed Asset:</span><span class="font-semibold text-gray-300">${topAsset}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Top Associated Tag:</span><span class="font-semibold text-purple-400">${topTag}</span></div>
                            </div>
                        </div>`;
            };

            body.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${createAnalysisCard(weeklyReversals, 'This Week')}
                    ${createAnalysisCard(monthlyReversals, 'This Month')}
                    ${createAnalysisCard(yearlyReversals, 'This Year')}
                </div>
            `;
        };
        const updateExcursionAnalysis = (allTrades) => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

            const winningTrades = allTrades.filter(t => t.profitLoss > breakevenThreshold);
            const losingOrBETrades = allTrades.filter(t => t.profitLoss !== null && t.profitLoss <= breakevenThreshold);

            const avgProfit = winningTrades.length > 0 ? winningTrades.reduce((acc, t) => acc + t.profitLoss, 0) / winningTrades.length : 0;
            const avgLoss = losingOrBETrades.length > 0 ? Math.abs(losingOrBETrades.reduce((acc, t) => acc + t.profitLoss, 0) / losingOrBETrades.length) : 0;

            const maeTrades = winningTrades.filter(t => t.maePrice !== null && !isNaN(t.maePrice));
            let totalMAE = 0;
            maeTrades.forEach(trade => {
                const { profit: peakDrawdown } = calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.maePrice, trade.indexName);
                if(peakDrawdown < 0) totalMAE += Math.abs(peakDrawdown);
            });
            const avgMAE = maeTrades.length > 0 ? totalMAE / maeTrades.length : 0;
            
            const mfeTrades = losingOrBETrades.filter(t => t.peakPrice !== null && !isNaN(t.peakPrice));
            let totalMFE = 0;
            mfeTrades.forEach(trade => {
                const { profit: peakProfit } = calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.peakPrice, trade.indexName);
                if(peakProfit > 0) totalMFE += peakProfit;
            });
            const avgMFE = mfeTrades.length > 0 ? totalMFE / mfeTrades.length : 0;

            dom['avg-mae-winners'].textContent = `$${avgMAE.toFixed(2)}`;
            dom['total-mae-winners'].textContent = `$${totalMAE.toFixed(2)}`;
            dom['avg-mfe-losers'].textContent = `$${avgMFE.toFixed(2)}`;
            dom['total-mfe-losers'].textContent = `$${totalMFE.toFixed(2)}`;

            const maeRatio = avgProfit > 0 ? (avgMAE / avgProfit) * 100 : 0;
            dom['mae-comparison-bar'].style.width = `${Math.min(100, maeRatio)}%`;

            const mfeRatio = avgLoss > 0 ? (avgMFE / avgLoss) * 100 : 0;
            dom['mfe-comparison-bar'].style.width = `${Math.min(100, mfeRatio)}%`;
        };
        const runMonteCarlo = () => {
            toggleLoader(true);
            setTimeout(() => {
                const tradesToProject = parseInt(dom['mc-trades'].value);
                const numSimulations = parseInt(dom['mc-simulations'].value);
                const closedTrades = getActiveTrades().filter(t => t.profitLoss !== null);

                if (closedTrades.length < 10) {
                    showToast("Need at least 10 closed trades for a meaningful simulation.", "error");
                    toggleLoader(false);
                    return;
                }

                const historicalReturns = closedTrades.map(t => t.profitLoss);
                const initialBalance = getActiveAccount().startingBalance || 0;
                const simulationResults = [];
                let finalEquities = [];

                for (let i = 0; i < numSimulations; i++) {
                    let currentEquity = initialBalance;
                    const path = [{ x: 0, y: initialBalance }];
                    for (let j = 0; j < tradesToProject; j++) {
                        const randomReturn = historicalReturns[Math.floor(Math.random() * historicalReturns.length)];
                        currentEquity += randomReturn;
                        path.push({ x: j + 1, y: currentEquity });
                    }
                    simulationResults.push(path);
                    finalEquities.push(currentEquity);
                }

                finalEquities.sort((a, b) => a - b);

                const medianFinalEquity = finalEquities[Math.floor(numSimulations / 2)];
                const top10Percentile = finalEquities[Math.floor(numSimulations * 0.9)];
                const bottom10Percentile = finalEquities[Math.floor(numSimulations * 0.1)];
                const probOfProfit = (finalEquities.filter(e => e > initialBalance).length / numSimulations) * 100;

                dom['mc-stats'].innerHTML = `
                    <h3 class="font-bold text-lg text-gray-100 mb-2">Simulation Stats</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">Median Outcome:</span><span class="font-semibold text-gray-200">$${medianFinalEquity.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Top 10% Outcome:</span><span class="font-semibold text-green-500">$${top10Percentile.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Bottom 10% Outcome:</span><span class="font-semibold text-red-500">$${bottom10Percentile.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Probability of Profit:</span><span class="font-semibold text-blue-400">${probOfProfit.toFixed(1)}%</span></div>
                    </div>
                `;

                const chartColors = getChartColors();
                if (mcChart) mcChart.destroy();
                mcChart = new Chart(dom.mcChart, {
                    type: 'line',
                    data: {
                        datasets: simulationResults.slice(0, 50).map((path, i) => ({
                            label: `Sim ${i + 1}`,
                            data: path,
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            pointRadius: 0
                        }))
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: chartColors.gridColor }, ticks: { color: chartColors.textColor } },
                            x: { title: { display: true, text: 'Number of Trades', color: chartColors.textColor }, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } }
                        }
                    }
                });
                showToast("Monte Carlo simulation complete!", "success");
                toggleLoader(false);
            }, 50);
        };
        const exportData = () => {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `prolific-journal-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showToast("Data exported successfully!", "success");
        };
        
        // FIX: Updated importData to be more robust and handle old backup formats.
        const importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.activeAccountName && importedData.accounts) {
                        
                        // Ensure settings object has an ID for the database keyPath
                        if (importedData.settings && !importedData.settings.id) {
                            importedData.settings.id = 'appSettings';
                        }

                        // Ensure each account has a name property for the database keyPath
                        for (const accountKey in importedData.accounts) {
                            if (!importedData.accounts[accountKey].name) {
                                importedData.accounts[accountKey].name = accountKey;
                            }
                        }

                        appData = importedData;
                        await saveAppData();
                        populateAccountSwitcher();
                        await switchAccount(appData.activeAccountName);
                        showToast("Data imported successfully!", "success");
                    } else {
                        showToast("Invalid backup file format.", "error");
                    }
                } catch (err) {
                    showToast("Could not parse backup file.", "error");
                    console.error("Import error:", err);
                }
                event.target.value = ''; 
            };
            reader.readAsText(file);
        };

        const applyFilters = () => {
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
            const allTrades = getActiveTrades();
            const instrument = dom['filter-instrument'].value;
            const tag = dom['filter-tag'].value;
            const type = dom['filter-type'].value;
            const outcome = dom['filter-outcome'].value;
            const startDateString = dom['filter-start-date'].value;
            const endDateString = dom['filter-end-date'].value;

            const startDate = startDateString ? new Date(startDateString + 'T00:00:00') : null;
            const endDate = endDateString ? new Date(endDateString + 'T23:59:59') : null;

            let activeFilterCount = [instrument, tag, type, outcome, startDateString, endDateString].filter(Boolean).length;

            dom['filter-status'].classList.toggle('hidden', activeFilterCount === 0);
            if(activeFilterCount > 0) dom['filter-status'].textContent = `${activeFilterCount} filter(s) active. Dashboard stats reflect filtered data.`;

            return allTrades.filter(trade => {
                if (instrument && trade.indexName !== instrument) return false;
                if (tag && (!trade.tags || !trade.tags.includes(tag))) return false;
                if (type && trade.tradeType !== type) return false;
                if (outcome) {
                    const isWin = trade.profitLoss > breakevenThreshold;
                    const isLoss = trade.profitLoss <= 0;
                    const isBreakeven = trade.profitLoss > 0 && trade.profitLoss <= breakevenThreshold;
                    const isOpen = trade.profitLoss === null;
                    if (outcome === 'win' && !isWin) return false;
                    if (outcome === 'loss' && !isLoss) return false;
                    if (outcome === 'breakeven' && !isBreakeven) return false;
                    if (outcome === 'open' && !isOpen) return false;
                }
                const tradeDate = new Date(trade.timestamp);
                if (startDate && tradeDate < startDate) return false;
                if (endDate && tradeDate > endDate) return false;
                return true;
            });
        };
        const updateFilterDropdowns = () => {
            const allTrades = getActiveTrades();
            const instruments = [...new Set(allTrades.map(t => t.indexName))].sort();
            const tags = getActiveAccount().tags.map(t => t.name).sort();
            
            const updateSelect = (selectEl, options, label) => {
                const currentValue = selectEl.value;
                selectEl.innerHTML = `<option value="">All ${label}</option>`;
                options.forEach(opt => selectEl.innerHTML += `<option value="${opt}">${opt}</option>`);
                selectEl.value = currentValue;
            };

            updateSelect(dom['filter-instrument'], instruments, 'Instruments');
            updateSelect(dom['filter-tag'], tags, 'Tags');
        };
        
        const setupManager = (modal, listContainer, btn, closeBtn, addBtn, nameInput, type) => {
            btn.addEventListener('click', () => { renderList(listContainer, type); modal.classList.remove('hidden'); });
            closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
            addBtn.addEventListener('click', async () => {
                const newName = nameInput.value.trim();
                const newColor = document.getElementById('new-tag-color').value;
                const collection = getActiveAccount()[type];
                if (newName && !collection.find(t => t.name === newName)) {
                    collection.push({ name: newName, color: newColor });
                    await saveAppData();
                    renderList(listContainer, type);
                    renderTagsChecklist();
                    nameInput.value = '';
                } else {
                    showToast(`Tag name cannot be empty or a duplicate.`, "error");
                }
            });
        };
        const renderList = (container, type) => {
             container.innerHTML = '';
             getActiveAccount()[type].forEach((item, index) => {
                 const div = document.createElement('div');
                 div.className = 'flex items-center justify-between p-2 bg-gray-700 rounded-md';
                 div.innerHTML = `<div class="flex items-center gap-2">
                                     <span class="w-4 h-4 rounded-full" style="background-color: ${item.color};"></span>
                                     <span class="font-semibold">${item.name}</span>
                                 </div>
                                <button class="delete-item-btn p-1 text-gray-400 hover:text-red-500" data-index="${index}" data-type="${type}">Delete</button>`;
                 container.appendChild(div);
             });
             container.querySelectorAll('.delete-item-btn').forEach(btn => btn.addEventListener('click', async e => {
                const {index, type} = e.currentTarget.dataset;
                getActiveAccount()[type].splice(index, 1);
                await saveAppData();
                renderList(container, type);
                renderTagsChecklist();
             }));
        };
        const renderTagsChecklist = (selected = []) => { 
            const container = dom['tags-checklist'];
            container.innerHTML = '';
            const tags = getActiveAccount().tags;
            if (tags.length === 0) { container.innerHTML = `<p class="text-xs text-center text-gray-400">No tags. Click "Manage Tags".</p>`; return; }
            tags.forEach(tag => {
                container.innerHTML += `<div class="flex items-center"><input type="checkbox" id="tag-${tag.name}" value="${tag.name}" ${selected.includes(tag.name)?'checked':''} class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 ring-offset-gray-800 focus:ring-2"><label for="tag-${tag.name}" class="ml-2 text-sm font-medium">${tag.name}</label></div>`;
            });
        };
        
        const updateAccountGrowth = (allTrades) => { 
            const totalPL = allTrades.filter(t => t.profitLoss !== null).reduce((acc, trade) => acc + trade.profitLoss, 0);
            const balance = getActiveAccount().startingBalance;
            if (balance === null || isNaN(balance)) {
                dom['account-growth'].textContent = '-';
                dom['current-balance'].textContent = 'Set starting balance...';
                return;
            }
            const currentValue = balance + totalPL;
            const growth = balance > 0 ? ((currentValue - balance) / balance) * 100 : (currentValue > 0 ? 100 : 0);
            dom['account-growth'].textContent = `${growth.toFixed(2)}%`;
            dom['account-growth'].className = `text-3xl font-bold ${growth >= 0 ? 'text-green-500' : 'text-red-500'}`;
            dom['current-balance'].textContent = `$${currentValue.toFixed(2)}`;
        };

        const handleSaveGoal = async () => {
            const editingId = dom['editing-goal-id'].value;
            const title = dom['goal-title'].value.trim();
            const metric = dom['goal-metric'].value;
            const target = parseFloat(dom['goal-target'].value);
            const timeframe = dom['goal-timeframe'].value;

            if (!title || isNaN(target)) {
                showToast('Please fill out all goal fields correctly.', 'error');
                return;
            }

            const goals = getActiveAccount().goals;

            if (editingId) {
                const goalIndex = goals.findIndex(g => g.id === editingId);
                if(goalIndex > -1) {
                    goals[goalIndex] = { ...goals[goalIndex], title, metric, target, timeframe };
                    showToast('Goal updated!', 'success');
                }
            } else {
                const newGoal = { id: crypto.randomUUID(), title, metric, target, timeframe, createdAt: new Date().toISOString() };
                goals.push(newGoal);
                showToast('Goal added!', 'success');
            }
            
            await saveAppData();
            updateGoals();
            resetGoalForm();
        };

        const resetGoalForm = () => {
            dom['add-goal-form'].reset();
            dom['editing-goal-id'].value = '';
            dom['goal-form-title'].textContent = 'Add New Goal';
            dom['add-goal-btn'].textContent = 'Add Goal';
            dom['cancel-goal-edit-btn'].classList.add('hidden');
        };

        const enterGoalEditMode = (goalId) => {
            const goals = getActiveAccount().goals;
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            dom['goal-form-title'].textContent = 'Edit Goal';
            dom['add-goal-btn'].textContent = 'Save Changes';
            dom['cancel-goal-edit-btn'].classList.remove('hidden');
            
            dom['editing-goal-id'].value = goal.id;
            dom['goal-title'].value = goal.title;
            dom['goal-metric'].value = goal.metric;
            dom['goal-target'].value = goal.target;
            dom['goal-timeframe'].value = goal.timeframe;

            dom['add-goal-form'].scrollIntoView({ behavior: 'smooth' });
        };


        const updateGoals = () => {
            const goalsList = dom['goals-list'];
            goalsList.innerHTML = '';
            const goals = getActiveAccount().goals;
            const trades = getActiveTrades();

            if (goals.length === 0) {
                goalsList.innerHTML = '<p class="text-center text-gray-500">No active goals. Add one to get started!</p>';
                return;
            }

            goals.forEach(goal => {
                const { currentValue } = calculateGoalProgress(goal, trades);
                const progress = goal.target !== 0 ? Math.min(100, (currentValue / goal.target) * 100) : (currentValue > 0 ? 100 : 0);
                const progressColor = progress >= 80 ? 'bg-green-500' : progress >= 40 ? 'bg-yellow-500' : 'bg-red-500';

                const goalEl = document.createElement('div');
                goalEl.className = 'bg-gray-800/50 p-4 rounded-lg border border-gray-700/50';
                goalEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-gray-100">${goal.title}</h3>
                            <p class="text-xs text-gray-400">${goal.timeframe.charAt(0).toUpperCase() + goal.timeframe.slice(1)} Goal</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-goal-btn text-gray-400 hover:text-blue-500" data-id="${goal.id}">Edit</button>
                            <button class="delete-goal-btn text-gray-400 hover:text-red-500" data-id="${goal.id}">&times;</button>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-400">Progress</span>
                        <span class="font-semibold text-gray-200">${currentValue.toFixed(2)} / ${goal.target}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div class="${progressColor} h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                `;
                goalsList.appendChild(goalEl);
            });

            goalsList.querySelectorAll('.delete-goal-btn').forEach(btn => {
                btn.addEventListener('click', async e => {
                    const goalId = e.currentTarget.dataset.id;
                    const goals = getActiveAccount().goals;
                    const index = goals.findIndex(g => g.id === goalId);
                    if (index > -1) {
                        goals.splice(index, 1);
                        await saveAppData();
                        updateGoals();
                        showToast('Goal removed.', 'info');
                    }
                });
            });

            goalsList.querySelectorAll('.edit-goal-btn').forEach(btn => {
                btn.addEventListener('click', e => enterGoalEditMode(e.currentTarget.dataset.id));
            });
        };

        const calculateGoalProgress = (goal, allTrades) => {
            const now = new Date();
            let startDate;

            if (goal.timeframe === 'week') {
                startDate = new Date(now);
                startDate.setDate(now.getDate() - now.getDay());
                startDate.setHours(0,0,0,0);
            } else if (goal.timeframe === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else { // year
                startDate = new Date(now.getFullYear(), 0, 1);
            }

            const tradesForPeriod = allTrades.filter(t => new Date(t.timestamp) >= startDate && t.profitLoss !== null);
            let currentValue = 0;

            if (tradesForPeriod.length > 0) {
                if (goal.metric === 'totalPL') {
                    currentValue = tradesForPeriod.reduce((acc, t) => acc + t.profitLoss, 0);
                } else {
                    const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;
                    const winningTrades = tradesForPeriod.filter(t => t.profitLoss > breakevenThreshold);
                    const losingTrades = tradesForPeriod.filter(t => t.profitLoss <= 0);
                    if (goal.metric === 'winRate') {
                        const countable = winningTrades.length + losingTrades.length;
                        currentValue = countable > 0 ? (winningTrades.length / countable) * 100 : 0;
                    } else if (goal.metric === 'profitFactor') {
                        const grossProfit = winningTrades.reduce((acc, t) => acc + t.profitLoss, 0);
                        const grossLoss = Math.abs(losingTrades.reduce((acc, t) => acc + t.profitLoss, 0));
                        currentValue = grossLoss > 0 ? grossProfit / grossLoss : Infinity;
                    }
                }
            }
            return { currentValue, tradesForPeriod };
        };

        const updateDrawdownAnalysis = (allTrades) => {
            const closedTrades = allTrades.filter(t => t.profitLoss !== null).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const initialBalance = getActiveAccount().startingBalance || 0;

            let maxDrawdownUSD = 0;
            let maxDrawdownPct = 0;
            let peakEquity = initialBalance;
            let longestDrawdownDays = 0;
            let currentDrawdownStart = null;
            const drawdownData = [];

            let cumulativeEquity = initialBalance;

            closedTrades.forEach(trade => {
                cumulativeEquity += trade.profitLoss;
                if (cumulativeEquity > peakEquity) {
                    peakEquity = cumulativeEquity;
                    if (currentDrawdownStart) {
                        const drawdownEnd = new Date(trade.timestamp);
                        const duration = (drawdownEnd - currentDrawdownStart) / (1000 * 60 * 60 * 24);
                        if (duration > longestDrawdownDays) {
                            longestDrawdownDays = duration;
                        }
                        currentDrawdownStart = null;
                    }
                }

                const drawdown = peakEquity - cumulativeEquity;
                if (drawdown > maxDrawdownUSD) {
                    maxDrawdownUSD = drawdown;
                }
                
                const drawdownPct = peakEquity > 0 ? (drawdown / peakEquity) * 100 : 0;
                if (drawdownPct > maxDrawdownPct) {
                    maxDrawdownPct = drawdownPct;
                }

                if (drawdown > 0 && !currentDrawdownStart) {
                    currentDrawdownStart = new Date(trade.timestamp);
                }

                drawdownData.push({ x: new Date(trade.timestamp), y: -drawdownPct }); // Use negative for chart
            });

            dom['max-drawdown-usd'].textContent = `$${maxDrawdownUSD.toFixed(2)}`;
            dom['max-drawdown-pct'].textContent = `${maxDrawdownPct.toFixed(2)}%`;
            dom['longest-drawdown-period'].textContent = `${Math.ceil(longestDrawdownDays)} days`;

            const chartOptions = getChartColors();
            if (drawdownChart) drawdownChart.destroy();
            drawdownChart = new Chart(dom.drawdownChart, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Drawdown (%)',
                        data: drawdownData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } },
                        y: { beginAtZero: false, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor, callback: (value) => `${-value.toFixed(1)}%` } }
                    },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `Drawdown: ${-ctx.raw.y.toFixed(2)}%` } } }
                }
            });
        };
        
        const handleSavePlay = async () => {
             const editingId = dom['editing-play-id'].value;
             const title = dom['play-title'].value.trim();
             const instruments = Array.from(dom['play-instruments'].selectedOptions).map(opt => opt.value);
             const marketCondition = dom['play-market-condition'].value;
             const entryCriteria = dom['play-entry-criteria'].innerHTML;
             const slRules = dom['play-sl-rules'].innerHTML;
             const managementRules = dom['play-management-rules'].innerHTML;
             const confidence = document.querySelector('input[name="rating"]:checked')?.value || 0;
             const reviewNotes = dom['play-review-notes'].innerHTML;
             const beforeImage = dom['play-before-image'].querySelector('img')?.src || null;
             const afterImage = dom['play-after-image'].querySelector('img')?.src || null;
             
             if (!title) {
                 showToast('Play title is required.', 'error');
                 return;
             }

             const playbook = getActiveAccount().playbook;

             if (editingId) {
                 const playIndex = playbook.findIndex(p => p.id === editingId);
                 if (playIndex > -1) {
                     playbook[playIndex] = { ...playbook[playIndex], title, instruments, marketCondition, entryCriteria, slRules, managementRules, confidence, reviewNotes, beforeImage, afterImage };
                     showToast('Play updated!', 'success');
                 }
             } else {
                 const newPlay = { id: crypto.randomUUID(), title, instruments, marketCondition, entryCriteria, slRules, managementRules, confidence, reviewNotes, beforeImage, afterImage };
                 playbook.push(newPlay);
                 showToast('New play added to your playbook!', 'success');
             }

             await saveAppData();
             updatePlaybook();
             resetPlayForm();
             populatePlaybookSelect();
        };

        const resetPlayForm = () => {
             dom['editing-play-id'].value = '';
             dom['play-form-title'].textContent = 'Add New Play';
             dom['save-play-btn'].textContent = 'Save Play';
             dom['cancel-play-edit-btn'].classList.add('hidden');
             dom['play-title'].value = '';
             Array.from(dom['play-instruments'].options).forEach(opt => opt.selected = false);
             dom['play-market-condition'].value = 'Trending';
             dom['play-entry-criteria'].innerHTML = '';
             dom['play-sl-rules'].innerHTML = '';
             dom['play-management-rules'].innerHTML = '';
             dom['play-review-notes'].innerHTML = '';
             document.querySelectorAll('input[name="rating"]').forEach(radio => radio.checked = false);
             dom['play-before-image'].innerHTML = 'Click or Drag Image Here';
             dom['play-after-image'].innerHTML = 'Click or Drag Image Here';
        };

        const setupImageDropzone = (dropzoneId, fileInputId) => {
            const dropzone = dom[dropzoneId];
            const fileInput = dom[fileInputId];
            
            const handleFiles = (files) => {
                const file = files[0];
                if(file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        dropzone.innerHTML = `<img src="${e.target.result}" class="playbook-image object-contain h-full w-full">`;
                    };
                    reader.readAsDataURL(file);
                }
            }

            dropzone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        };

        const updatePlaybook = () => {
            const list = dom['playbook-list'];
            list.innerHTML = '';
            const playbook = getActiveAccount().playbook;
            const trades = getActiveTrades();
            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

            if (playbook.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">Your playbook is empty. Add a new play to document your best setups!</p>';
                return;
            }

            playbook.forEach(play => {
                const linkedTrades = trades.filter(t => t.playId === play.id && t.profitLoss !== null);
                const wins = linkedTrades.filter(t => t.profitLoss > breakevenThreshold).length;
                const losses = linkedTrades.filter(t => t.profitLoss <= 0).length;
                const winRate = (wins + losses) > 0 ? (wins / (wins + losses)) * 100 : 0;
                const totalPL = linkedTrades.reduce((acc, t) => acc + t.profitLoss, 0);

                const starHtml = Array(5).fill(0).map((_, i) => `<span class="${i < play.confidence ? 'text-yellow-400' : 'text-gray-600'}">★</span>`).join('');

                const playEl = document.createElement('div');
                playEl.className = 'bg-gray-800/50 p-4 rounded-lg border border-gray-700/50';
                playEl.innerHTML = `
                      <div class="flex justify-between items-start mb-2">
                          <div>
                              <h3 class="font-bold text-xl text-gray-100">${play.title}</h3>
                              <div class="text-2xl">${starHtml}</div>
                          </div>
                          <div class="flex gap-2">
                            <button class="view-play-btn text-gray-400 hover:text-blue-500" data-id="${play.id}">View</button>
                             <button class="edit-play-btn text-gray-400 hover:text-blue-500" data-id="${play.id}">Edit</button>
                             <button class="delete-play-btn text-gray-400 hover:text-red-500" data-id="${play.id}">Delete</button>
                          </div>
                      </div>
                      <div class="grid grid-cols-3 gap-2 text-center text-sm mb-4">
                          <div class="bg-gray-700/50 p-2 rounded">
                              <p class="text-xs text-gray-400">Win Rate</p>
                              <p class="font-bold text-lg">${winRate.toFixed(1)}%</p>
                          </div>
                          <div class="bg-gray-700/50 p-2 rounded">
                              <p class="text-xs text-gray-400">Total P/L</p>
                              <p class="font-bold text-lg ${totalPL >= 0 ? 'text-green-500' : 'text-red-500'}">$${totalPL.toFixed(2)}</p>
                          </div>
                           <div class="bg-gray-700/50 p-2 rounded">
                              <p class="text-xs text-gray-400">Trades</p>
                              <p class="font-bold text-lg">${linkedTrades.length}</p>
                          </div>
                      </div>
                      <div class="details-row">
                          <div class="details-content prose prose-invert max-w-none prose-sm">
                              <h4>Entry Criteria</h4>
                              <div>${play.entryCriteria}</div>
                              <h4>Stop Loss Rules</h4>
                              <div>${play.slRules}</div>
                              <h4>Trade Management</h4>
                              <div>${play.managementRules}</div>
                              <h4>Review Notes</h4>
                              <div>${play.reviewNotes}</div>
                              <div class="grid grid-cols-2 gap-4 mt-4">
                                  <div>
                                      <h4>Before</h4>
                                      ${play.beforeImage ? `<img src="${play.beforeImage}" class="playbook-image">` : '<p>No image</p>'}
                                  </div>
                                  <div>
                                      <h4>After</h4>
                                      ${play.afterImage ? `<img src="${play.afterImage}" class="playbook-image">` : '<p>No image</p>'}
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
                list.appendChild(playEl);
            });
            
            list.querySelectorAll('.delete-play-btn').forEach(btn => {
                btn.addEventListener('click', async e => {
                    const playId = e.currentTarget.dataset.id;
                    const confirmed = await showCustomModal({
                        title: 'Delete Play',
                        text: 'Are you sure you want to delete this play from your playbook?',
                        confirmText: 'Delete'
                    });
                    if (confirmed) {
                        const playbook = getActiveAccount().playbook;
                        const index = playbook.findIndex(p => p.id === playId);
                        if (index > -1) {
                            playbook.splice(index, 1);
                            await saveAppData();
                            updatePlaybook();
                            populatePlaybookSelect();
                            showToast('Play removed from playbook.', 'info');
                        }
                    }
                });
            });
            list.querySelectorAll('.edit-play-btn').forEach(btn => btn.addEventListener('click', e => enterPlayEditMode(e.currentTarget.dataset.id)));
            list.querySelectorAll('.view-play-btn').forEach(btn => btn.addEventListener('click', e => e.currentTarget.closest('.p-4').querySelector('.details-row').classList.toggle('open')));
        };

        const enterPlayEditMode = (playId) => {
            const play = getActiveAccount().playbook.find(p => p.id === playId);
            if (!play) return;
            resetPlayForm();

            dom['editing-play-id'].value = play.id;
            dom['play-form-title'].textContent = 'Edit Play';
            dom['save-play-btn'].textContent = 'Save Changes';
            dom['cancel-play-edit-btn'].classList.remove('hidden');

            dom['play-title'].value = play.title;
            Array.from(dom['play-instruments'].options).forEach(opt => {
                if(play.instruments.includes(opt.value)) opt.selected = true;
            });
            dom['play-market-condition'].value = play.marketCondition;
            dom['play-entry-criteria'].innerHTML = play.entryCriteria;
            dom['play-sl-rules'].innerHTML = play.slRules;
            dom['play-management-rules'].innerHTML = play.managementRules;
            dom['play-review-notes'].innerHTML = play.reviewNotes;
            if (play.confidence > 0) document.getElementById(`star${play.confidence}`).checked = true;
            if (play.beforeImage) dom['play-before-image'].innerHTML = `<img src="${play.beforeImage}" class="playbook-image object-contain h-full w-full">`;
            if (play.afterImage) dom['play-after-image'].innerHTML = `<img src="${play.afterImage}" class="playbook-image object-contain h-full w-full">`;
            
            dom['play-form-title'].scrollIntoView({ behavior: 'smooth' });
        };


        const populatePlaybookSelect = () => {
            const select = dom['playbook-select'];
            const currentVal = select.value;
            select.innerHTML = '<option value="">None</option>';
            getActiveAccount().playbook.forEach(play => {
                select.innerHTML += `<option value="${play.id}">${play.title}</option>`;
            });
            select.value = currentVal;
        };
        
        const applyAccentColor = (color) => {
            document.documentElement.style.setProperty('--accent-color', color);
            dom['accent-color-picker'].value = color;
        };

        const clearPipInputs = () => {
            dom['sl-pips'].value = '';
            dom['tp-pips'].value = '';
        };

        const calculatePriceFromPips = (type) => {
            const entryPrice = parseFloat(dom['entry-price'].value);
            const pips = parseFloat(dom[`${type}-pips`].value);
            const instrument = dom['index-selector'].value;

            if (isNaN(entryPrice) || isNaN(pips)) {
                return;
            }

            let multiplier = 1;
            if (instrument.includes('/')) { // Forex
                multiplier = instrument.includes('JPY') ? 0.01 : 0.0001;
            }

            let priceChange = pips * multiplier;
            let finalPrice;

            if (type === 'sl') {
                finalPrice = tradeType === 'Buy' ? entryPrice - priceChange : entryPrice + priceChange;
            } else { // tp
                finalPrice = tradeType === 'Buy' ? entryPrice + priceChange : entryPrice - priceChange;
            }
            
            // Determine decimal places from entry price
            const decimalPlaces = (entryPrice.toString().split('.')[1] || '').length;
            dom[`${type === 'sl' ? 'stop-loss' : 'take-profit'}`].value = finalPrice.toFixed(decimalPlaces);
        };

        const updateRiskConsistencyTracker = (allTrades) => {
           const riskTrades = allTrades
               .filter(t => t.stopLoss !== null && !isNaN(t.stopLoss) && t.entryPrice !== null)
               .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

           if (riskConsistencyChart) riskConsistencyChart.destroy();
           
           if (riskTrades.length < 2) {
               const canvas = dom.riskConsistencyChart;
               if (canvas) {
                  const ctx = canvas.getContext('2d');
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
               }
               return;
           }

           const riskData = riskTrades.map(trade => {
               // Use the central calculatePL function for consistent risk calculation
               const { profit: riskInDollars } = calculatePL(trade.tradeType, trade.lotSize, trade.entryPrice, trade.stopLoss, trade.indexName);
               
               // Ensure risk is always a positive value for the chart
               const positiveRisk = riskInDollars !== null ? Math.abs(riskInDollars) : 0;
               
               return { x: new Date(trade.timestamp), y: positiveRisk };
           });

           const totalRisk = riskData.reduce((acc, data) => acc + data.y, 0);
           const avgRisk = totalRisk / riskData.length;

           const chartOptions = getChartColors();
           riskConsistencyChart = new Chart(dom.riskConsistencyChart, {
               type: 'line',
               data: {
                   datasets: [{
                       label: 'Risk per Trade ($)',
                       data: riskData,
                       borderColor: 'rgba(234, 179, 8, 0.8)',
                       backgroundColor: 'rgba(234, 179, 8, 0.1)',
                       tension: 0.1,
                       fill: true,
                   }, {
                       label: 'Average Risk ($)',
                       data: riskData.map(d => ({ x: d.x, y: avgRisk })),
                       borderColor: 'rgba(255, 255, 255, 0.5)',
                       borderDash: [5, 5],
                       borderWidth: 2,
                       pointRadius: 0,
                       fill: false,
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   scales: {
                       x: { type: 'time', time: { unit: 'day' }, grid: { color: chartOptions.gridColor }, ticks: { color: chartOptions.textColor } },
                       y: { 
                           beginAtZero: true, 
                           grid: { color: chartOptions.gridColor }, 
                           ticks: { color: chartOptions.textColor, callback: (value) => `$${value.toFixed(0)}` } 
                       }
                   },
                   plugins: { 
                       legend: { display: true, labels: { color: chartOptions.textColor } },
                       tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: $${ctx.raw.y.toFixed(2)}` } }
                   }
               }
           });
        };

        const updateRRPerformanceAnalysis = (allTrades) => {
            const body = dom['rr-performance-body'];
            body.innerHTML = '';
            const rrTrades = allTrades.filter(t => t.rrRatio !== null && t.rrRatio > 0 && t.profitLoss !== null);

            if (rrTrades.length === 0) {
                body.innerHTML = '<p class="text-center text-gray-500">No trades with planned R:R to analyze.</p>';
                return;
            }

            const rrBuckets = {
                'Under 1R': { trades: 0, wins: 0, totalPL: 0 },
                '1R - 1.9R': { trades: 0, wins: 0, totalPL: 0 },
                '2R - 2.9R': { trades: 0, wins: 0, totalPL: 0 },
                '3R+': { trades: 0, wins: 0, totalPL: 0 }
            };

            const breakevenThreshold = appData.settings.breakevenThreshold || 2.0;

            rrTrades.forEach(trade => {
                let bucket;
                if (trade.rrRatio < 1) bucket = 'Under 1R';
                else if (trade.rrRatio < 2) bucket = '1R - 1.9R';
                else if (trade.rrRatio < 3) bucket = '2R - 2.9R';
                else bucket = '3R+';

                rrBuckets[bucket].trades++;
                rrBuckets[bucket].totalPL += trade.profitLoss;
                if (trade.profitLoss > breakevenThreshold) {
                    rrBuckets[bucket].wins++;
                }
            });

            const fragment = document.createDocumentFragment();
            for (const [bucketName, stats] of Object.entries(rrBuckets)) {
                if (stats.trades === 0) continue;

                const winRate = (stats.trades > 0 ? (stats.wins / stats.trades) * 100 : 0).toFixed(1);
                const plClass = stats.totalPL >= 0 ? 'text-green-500' : 'text-red-500';

                const bucketEl = document.createElement('div');
                bucketEl.className = 'grid grid-cols-4 items-center bg-gray-800/50 p-3 rounded-lg text-sm';
                bucketEl.innerHTML = `
                    <div class="font-bold text-gray-200 col-span-1">${bucketName}</div>
                    <div class="text-center"><span class="font-semibold text-gray-300">${stats.trades}</span> <span class="text-gray-400">trades</span></div>
                    <div class="text-center"><span class="font-semibold text-gray-300">${winRate}%</span> <span class="text-gray-400">win rate</span></div>
                    <div class="text-right font-bold ${plClass}">$${stats.totalPL.toFixed(2)}</div>
                `;
                fragment.appendChild(bucketEl);
            }
            body.appendChild(fragment);
        };

    </script>
</body>
</html>


